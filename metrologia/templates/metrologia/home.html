{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard Metrologia{% endblock %}

{% block content %}
{% include 'partials/global/_styles_componentes.html' %}

<style>
  .welcome-banner {
    border-radius: 12px;
    background: linear-gradient(90deg, #0d6efd 0%, #0dcaf0 100%);
    color: #fff;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.08);
  }
  .kpi-card {
    border: none;
    border-radius: 14px;
    background: #f8fafc;
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 6px 22px rgba(0,0,0,.08); }
  .kpi-value { font-size: 2rem; font-weight: 800; }
  .table-card { border-radius: 12px; overflow: hidden; }
  .table thead th { white-space: nowrap; }
</style>

<div class="container mt-4">

  {# Banner (padrão visual inspirado na home geral) #}
  <div class="welcome-banner d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <i class="bi bi-rulers fs-1"></i>
      <div>
        <h5 class="mb-0">Bem-vindo ao Painel de Metrologia</h5>
        <small class="opacity-75">Acompanhe status de calibrações, vencimentos e alterações recentes.</small>
      </div>
    </div>

    {# Botões rápidos e Filtros (Offcanvas) #}
   <div class="d-flex align-items-center gap-2">
<a href="{% url 'cronograma_calibracao' %}" class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2 rounded-pill shadow-sm">
  <i class="bi bi-calendar-check fs-5"></i>
  <span>Cronograma Equipamentos</span>
</a>

<a href="{% url 'cronograma_dispositivos' %}" class="btn btn-success d-flex align-items-center gap-2 px-3 py-2 rounded-pill shadow-sm">
  <i class="bi bi-calendar-range fs-5"></i>
  <span>Cronograma Dispositivos</span>
</a>

  <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFiltros">
    <i class="bi bi-sliders"></i> Filtros
  </button>
</div>

  </div>

  {# KPIs principais (cards) #}
  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Ativos (filtro)</div>
            <div class="kpi-value text-dark">{{ kpi_total_ativos|default:0 }}</div>
          </div>
          <i class="bi bi-grid-3x3-gap fs-1 text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Vencidos</div>
            <div class="kpi-value text-danger">{{ kpi_vencidos|default:0 }}</div>
          </div>
          <i class="bi bi-exclamation-octagon fs-1 text-danger"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Próx. {{ dias_alerta }} dias</div>
            <div class="kpi-value text-warning">{{ kpi_proximos|default:0 }}</div>
          </div>
          <i class="bi bi-hourglass-split fs-1 text-warning"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Calibrados ({{ start_month|date:"m/Y" }})</div>
            <div class="kpi-value text-success">{{ kpi_calibrados_mes|default:0 }}</div>
          </div>
          <i class="bi bi-check2-circle fs-1 text-success"></i>
        </div>
      </div>
    </div>
  </div>

  {# Seções em cards (padrão inspirado nos seus painéis) #}
  <div class="row g-4">
    <div class="col-xl-8">
      <div class="card table-card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-exclamation-diamond"></i> Alertas de Calibração (próx. {{ dias_alerta }} dias)</strong>
          <small class="text-muted">Hoje: {{ today|date:"d/m/Y" }}</small>
        </div>
        <div class="card-body p-0">
          {% if alertas_calibracao %}
            <div class="table-responsive" style="max-height: 380px; overflow: auto;">
              <table class="table table-hover table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Código</th>
                    <th>Nome</th>
                    <th>Última Calibração</th>
                    <th>Próxima Calibração</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in alertas_calibracao %}
                    <tr>
                      <td>{{ a.codigo }}</td>
                      <td>{{ a.nome_equipamento }}</td>
                      <td>{{ a.data_ultima_calibracao|date:"d/m/Y" }}</td>
                      <td>{{ a.proxima_calibracao|date:"d/m/Y" }}</td>
                      <td>
                        {% if a.proxima_calibracao < today %}
                          <span class="badge bg-danger">Vencido</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">Próximo</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            {% include 'partials/global/_sem_resultados.html' with item_nome="alerta de calibração" %}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <strong><i class="bi bi-tools"></i> Equipamentos Recentes</strong>
        </div>
        <div class="card-body">
          {% if equipamentos_recente %}
            <ul class="list-group list-group-flush">
              {% for e in equipamentos_recente %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ e.codigo }}</strong><br>
                    <small class="text-muted">{{ e.nome_equipamento }}</small>
                  </div>
                  <small class="text-muted">{{ e.updated_at|date:"d/m/Y" }}</small>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">Nenhuma alteração recente.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <strong><i class="bi bi-cpu"></i> Dispositivos Recentes</strong>
        </div>
        <div class="card-body">
          {% if dispositivos_recente %}
            <ul class="list-group list-group-flush">
              {% for d in dispositivos_recente %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ d.codigo }}</strong><br>
                    <small class="text-muted">{{ d.descricao }}</small>
                  </div>
                  <small class="text-muted">{{ d.updated_at|date:"d/m/Y" }}</small>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">Nenhuma alteração recente.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <strong><i class="bi bi-info-circle"></i> Observações & Dicas</strong>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Vencimento considera sempre o último dia do mês da frequência de calibração.</li>
            <li>Use os filtros para ampliar a janela de alerta (30/60/90 dias).</li>
            <li>Calibrados no mês consideram {{ start_month|date:"d/m/Y" }} a {{ end_month|date:"d/m/Y" }}.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

{# Offcanvas de Filtros (mesmo padrão visual dos demais dashboards) #}
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFiltros" aria-labelledby="offcanvasFiltrosLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasFiltrosLabel">
      <i class="bi bi-sliders"></i> Filtros
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get">
      <div class="mb-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="ativo" {% if status_filtro == "ativo" %}selected{% endif %}>Ativo</option>
          <option value="inativo" {% if status_filtro == "inativo" %}selected{% endif %}>Inativo</option>
          <option value="todos" {% if status_filtro == "todos" %}selected{% endif %}>Todos</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Janela de alerta (dias)</label>
        <select name="janela" class="form-select">
          <option value="30" {% if dias_alerta == 30 %}selected{% endif %}>30</option>
          <option value="60" {% if dias_alerta == 60 %}selected{% endif %}>60</option>
          <option value="90" {% if dias_alerta == 90 %}selected{% endif %}>90</option>
        </select>
      </div>
      <div class="d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel"></i> Aplicar filtros
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
