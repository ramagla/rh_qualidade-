{% extends 'base.html' %}

{% block content %}
{% load tz %}
{% now "Y-m-d" as hoje %}
{% load custom_filters %}
{% include 'partials/global/_toast_mensagens.html' %}
{% include 'partials/global/_estilos_impressao_paisagem.html' %}

<div class="print-container container mt-5">
  {% include 'partials/global/_header_titulo.html' with titulo="Cronograma de Calibra√ß√£o dos Equipamentos" icone="bi bi-tools" emoji="üîß" %}

  <div class="header header-table print-header text-center">
    <div class="table-responsive">
      <table class="custom-header table table-bordered table-striped align-middle">  
      <thead>
        <tr>
          <th rowspan="2" style="text-align: center; vertical-align: middle; width: 10%; border: 1px solid #ddd;">
            <img src="/static/logo.png" alt="Logo" style="width: 80px; height: auto;">
          </th>
          <th colspan="5" style="text-align: center; font-weight: bold; font-size: 16px; vertical-align: middle; border: 1px solid #ddd;">
            <i class="bi bi-calendar2-range"></i> CRONOGRAMA DE CALIBRA√á√ÉO DOS EQUIPAMENTOS
          </th>
          <th rowspan="2" style="text-align: center; vertical-align: middle; width: 15%; border: 1px solid #ddd;">
            <strong>CR001 - Rev25</strong><br>
            <time datetime="{{ hoje }}">{{ hoje }}</time>
          </th>
        </tr>
        <tr>
          <th style="text-align: left; padding-left: 10px; border: 1px solid #ddd;">
            <i class="bi bi-calendar3"></i> <strong>Ano:</strong> {{ ano|default:"Todos os Anos" }}
          </th>
          <th style="text-align: left; padding-left: 10px; border: 1px solid #ddd;">
            <i class="bi bi-bar-chart-steps"></i> <strong>Tipo de Avalia√ß√£o:</strong> {{ tipo_avaliacao|default:"Todos os Tipos" }}
          </th>
          <th colspan="3" style="text-align: left; padding-left: 10px; border: 1px solid #ddd;">
            <i class="bi bi-arrow-clockwise"></i> <strong>Atualizado:</strong> Automaticamente
          </th>
        </tr>
      </thead>
    </table>
  </div>
</div>

  <div class="text-center mb-4 d-print-none">
    {% include 'partials/global/_botao_impressao.html' %}
  </div>
  
  <!-- Filtros -->
<div class="card shadow-sm mb-4 d-print-none">
  <div class="card-header bg-light d-flex align-items-center gap-2">
    <i class="bi bi-funnel-fill text-primary"></i>
    <strong>Filtros de Pesquisa</strong>
  </div>
  <div class="card-body">
    <form method="GET" class="row row-cols-1 row-cols-md-4 g-3 align-items-end">
      <div class="col">
        <label for="ano" class="form-label"><i class="bi bi-calendar3 me-1"></i> Ano:</label>
        <select id="ano" name="ano" class="form-select">
          <option value="">Todos</option>
          {% for ano in anos_disponiveis %}
            <option value="{{ ano }}" {% if ano == request.GET.ano %}selected{% endif %}>{{ ano }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label for="codigo" class="form-label"><i class="bi bi-upc-scan me-1"></i> C√≥digo:</label>
        <input type="text" id="codigo" name="codigo" class="form-control"
               value="{{ request.GET.codigo }}" placeholder="Digite o c√≥digo">
      </div>

      <div class="col-md-3">
        <label for="grandeza" class="form-label"><i class="bi bi-rulers me-1"></i> Grandeza:</label>
        <select id="grandeza" name="grandeza" class="form-select">
          <option value="">Todas</option>
          {% for tipo in tipos_grandeza %}
            <option value="{{ tipo }}" {% if tipo == request.GET.grandeza %}selected{% endif %}>{{ tipo }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label for="tipo_avaliacao" class="form-label"><i class="bi bi-bar-chart-line me-1"></i> Tipo de Avalia√ß√£o:</label>
        <select id="tipo_avaliacao" name="tipo_avaliacao" class="form-select">
          <option value="">Todos</option>
          {% for tipo in tipos_avaliacao %}
            <option value="{{ tipo }}" {% if tipo == request.GET.tipo_avaliacao %}selected{% endif %}>{{ tipo }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Bot√£o centralizado -->
 <div class="w-100 d-flex justify-content-center mt-2">
  {% include 'partials/global/_botao_filtrar.html' %}
</div>


    </form>
  </div>
</div>

  <!-- Scroll horizontal superior -->
<div class="table-scroll-top overflow-auto mb-2" style="height: 20px;">
  <div style="width: max-content;"></div>
</div>

<!-- Scroll principal com tabela -->
<div class="table-responsive table-scroll-bottom overflow-auto">
  <table class="custom-table table table-bordered table-striped table-hover text-center align-middle">
   <thead class="table-primary">
  <tr>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-upc-scan mb-1"></i>
        <small>C√≥digo</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-hammer mb-1"></i>
        <small>Equipamento</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-building mb-1"></i>
        <small>Fabricante</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-arrows-expand mb-1"></i>
        <small>Capacidade</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-grid-1x2 mb-1"></i>
        <small>Resolu√ß√£o</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-person-badge mb-1"></i>
        <small>Respons√°vel</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-calendar-check mb-1"></i>
        <small>√öltima Calibra√ß√£o</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-calendar-event mb-1"></i>
        <small>Pr√≥xima Calibra√ß√£o</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-clock-history mb-1"></i>
        <small>Frequ√™ncia</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-hospital mb-1"></i>
        <small>Laborat√≥rio</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-file-earmark-text mb-1"></i>
        <small>N¬∫ Certificado</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <small>(E) Erro</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <small>(I) Incerteza</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <small>L = (E + I)</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-bullseye mb-1"></i>
        <small>Exatid√£o</small>
      </div>
    </th>
    <th class="text-center">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-activity mb-1"></i>
        <small>Status</small>
      </div>
    </th>
  </tr>
</thead>

    <tbody>
      {% for equipamento in equipamentos %}
        <tr>
          <td>{{ equipamento.codigo }}</td>
          <td>{{ equipamento.nome_equipamento }}</td>
          <td>{{ equipamento.fabricante }}</td>
          <td>{{ equipamento.capacidade }}</td>
          <td>{{ equipamento.resolucao }}</td>
          <td>{{ equipamento.responsavel }}</td>
          <td>{{ equipamento.data_ultima_calibracao|date:"d/m/Y" }}</td>
          <td>
            {% if equipamento.data_proxima_calibracao %}
              {% with equipamento.data_proxima_calibracao as data_calibracao %}
                {% if data_calibracao < hoje %}
                  <span class="badge bg-danger">{{ data_calibracao|date:"d/m/Y" }}</span>
                {% elif data_calibracao <= hoje|add_days:31 %}
                  <span class="badge bg-warning text-dark">{{ data_calibracao|date:"d/m/Y" }}</span>
                {% else %}
                  <span class="badge bg-success">{{ data_calibracao|date:"d/m/Y" }}</span>
                {% endif %}
              {% endwith %}
            {% else %}
              <span class="text-muted">N√£o definida</span>
            {% endif %}
          </td>
          <td>{{ equipamento.frequencia_calibracao }}</td>
          <td>{{ equipamento.laboratorio }}</td>
          <td>
            {% if equipamento.certificado_url %}
              <a href="{{ equipamento.certificado_url }}" target="_blank" rel="noopener"
                class="link-primary text-decoration-none">
                {{ equipamento.numero_certificado }}
                <i class="bi bi-box-arrow-up-right ms-1"></i>
              </a>
            {% else %}
              {% if equipamento.numero_certificado and equipamento.numero_certificado != "N/A" %}
                {{ equipamento.numero_certificado }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            {% endif %}
          </td>          
          <td>{{ equipamento.erro_equipamento }}</td>
          <td>{{ equipamento.incerteza }}</td>
          <td>{{ equipamento.l }}</td>
          <td>{{ equipamento.exatidao_requerida }}</td>
          <td>
            {% if equipamento.status == "Aprovado" %}
              <span class="badge bg-success">Aprovado</span>
            {% elif equipamento.status == "Reprovado" %}
              <span class="badge bg-danger">Reprovado</span>
            {% else %}
              <span class="badge bg-secondary">Indefinido</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<style>
    @media print {
  /* For√ßa a tabela a caber na p√°gina */
  .print-container {
    zoom: 85%; /* ajuste at√© caber na p√°gina, pode testar 80% ou 90% */
  }

  table {
    font-size: 11px; /* diminui um pouco a fonte */
    table-layout: fixed; /* evita que colunas se expandam demais */
    width: 100% !important;
  }

  th, td {
    word-wrap: break-word; /* quebra o texto se for muito longo */
    white-space: normal !important;
    padding: 2px 4px !important;
  }

  /* Remove scrolls na impress√£o */
  .table-responsive,
  .table-scroll-bottom,
  .table-scroll-top {
    overflow: visible !important;
  }
}

      
    </style>      

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const topScroll = document.querySelector('.table-scroll-top');
        const bottomScroll = document.querySelector('.table-scroll-bottom');
    
        if (topScroll && bottomScroll) {
          const table = bottomScroll.querySelector('table');
          const mirror = table.cloneNode(false);
          mirror.style.width = table.scrollWidth + 'px';
          mirror.style.height = '1px';
          mirror.style.visibility = 'hidden';
          topScroll.innerHTML = '';
          topScroll.appendChild(mirror);
    
          // sincronizar os scrolls
          topScroll.addEventListener('scroll', () => {
            bottomScroll.scrollLeft = topScroll.scrollLeft;
          });
          bottomScroll.addEventListener('scroll', () => {
            topScroll.scrollLeft = bottomScroll.scrollLeft;
          });
        }
      });
    </script>
    
    
{% endblock %}
