{% extends 'base.html' %}

{% block title %}Lista de Cargos{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Lista de Descrições de Cargos</h2>

    <!-- Botões de Ação -->
    <div class="text-end mb-4">
        <!-- Botão de Adicionar Cargo com Ícone -->
        <a href="{% url 'cadastrar_cargo' %}" class="btn btn-success me-2">
           <i class="bi bi-plus-circle"></i> Cadastrar
        </a>      
    </div>

    <!-- Toast container para mensagens de alerta no canto inferior direito -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11;">
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == "error" %}
                    <div class="toast align-items-center border-0" 
                         style="background-color: #f8d7da; color: #842029;" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                <h4 class="alert-heading">Atenção!</h4>
                                <p>{{ message }}</p>
                                <p class="mb-0">Certifique-se de resolver os vínculos antes de tentar excluir novamente.</p>
                            </div>
                        </div>
                    </div>
                {% elif message.tags == "success" %}
                    <div class="toast align-items-center border-0" 
                         style="background-color: #d1e7dd; color: #0f5132;" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
                        <div class="d-flex">
                            <div class="toast-body">
                                <h4 class="alert-heading">Sucesso!</h4>
                                <p>{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Formulário de filtro -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-6">
                <label for="departamento" class="form-label">Filtrar por Departamento:</label>
                <select name="departamento" id="departamento" class="form-select select2">
                    <option value="">Todos</option>
                    {% for dept in departamentos %}
                        <option value="{{ dept }}" {% if request.GET.departamento == dept %}selected{% endif %}>
                            {{ dept }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="cargo" class="form-label">Filtrar por Cargo:</label>
                <select name="cargo" id="cargo" class="form-select select2">
                    <option value="">Todos</option>
                    {% for cargo in todos_cargos %}
                        <option value="{{ cargo.nome }}" {% if request.GET.cargo == cargo.nome %}selected{% endif %}>
                            {{ cargo.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="text-end mt-3">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> Filtrar
            </button>
        </div>
    </form>

    <!-- Tabela de cargos -->
    <table class="table table-bordered text-center">
        <thead>
            <tr>
                <th>Nome do Cargo</th>
                <th>Número da DC</th>  <!-- Substituído CBO por Número da DC -->
                <th>Departamento</th>
                <th>Última Revisão</th>
                <th>Última Atualização</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for cargo in cargos %}
            <tr>
                <td>{{ cargo.nome }}</td>
                <td>{{ cargo.numero_dc }}</td>  <!-- Atualizado para exibir Número da DC -->
                <td>{{ cargo.departamento }}</td>
                <td>
                    {% if cargo.ultima_revisao %}
                        {{ cargo.ultima_revisao.numero_revisao }}
                    {% else %}
                        Sem revisão
                    {% endif %}
                </td>
                <td>
                    {% if cargo.ultima_revisao %}
                        {{ cargo.ultima_revisao.data_revisao|date:"d/m/Y" }}
                    {% else %}
                        Sem data
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'editar_cargo' cargo.id %}" class="btn btn-warning btn-sm" title="Editar">
                        <i class="bi bi-pencil-square"></i>  <!-- Ícone de Editar -->
                    </a>
                    <a href="{% url 'historico_revisoes' cargo.id %}" class="btn btn-info btn-sm" title="Histórico de Revisões">
                        <i class="bi bi-clock-history"></i>
                    </a>
                    <!-- Verifica se o arquivo de descrição está presente -->
                    {% if cargo.descricao_arquivo %}
                        <a href="{{ cargo.descricao_arquivo.url }}" class="btn btn-secondary btn-sm" download title="Baixar Descrição">
                            <i class="bi bi-file-earmark-word"></i>  <!-- Ícone de Word -->
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(toast => {
            const bootstrapToast = new bootstrap.Toast(toast);
            bootstrapToast.show();
        });
    });
</script>

{% endblock %}
