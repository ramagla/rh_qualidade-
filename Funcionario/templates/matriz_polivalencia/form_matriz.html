{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load custom_filters %}

{% block title %}Cadastrar Matriz de Polival√™ncia{% endblock %}

{% block content %}
{% include "partials/global/_styles_componentes.html" %}
{% include "partials/global/_header_titulo.html" with titulo="Matriz de Polival√™ncia" icone="bi bi-people-fill" emoji="üß†" %}
{% include "partials/global/_toast_mensagens.html" %}
{% include "partials/global/_form_errors.html" %}

<div class="container mt-4">
 <form method="post"
      id="matriz-form"
      enctype="multipart/form-data"
      class="row g-3"
      action="{% if form.instance.pk %}
                 {% url 'editar_matriz_polivalencia' form.instance.pk %}
              {% else %}
                 {% url 'cadastrar_matriz_polivalencia' %}
              {% endif %}">
    {% csrf_token %}


  <!-- üîß Accordion - Informa√ß√µes B√°sicas -->
<div class="accordion" id="accordionMatriz">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingBasico">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasico" aria-expanded="true" aria-controls="collapseBasico">
        <i class="bi bi-building me-2"></i> Informa√ß√µes B√°sicas
      </button>
    </h2>
    <div id="collapseBasico" class="accordion-collapse collapse show" aria-labelledby="headingBasico" data-bs-parent="#accordionMatriz">
      <div class="accordion-body">
        <div class="row">

          <div class="col-md-6">
  <label for="departamento" class="form-label">
    <i class="bi bi-diagram-3 me-1"></i> Departamento (Atividade)
  </label>
  <select name="departamento" id="departamento" class="form-select select2">
    <option value="">Selecione o Departamento</option>
    {% for departamento in departamentos %}
    <option value="{{ departamento.0 }}" {% if form.instance.departamento == departamento.0 %}selected{% endif %}>
      {{ departamento.1 }}
    </option>
  {% endfor %}
  
    
  
  </select>
</div>


          <div class="col-md-6">
            <label for="{{ form.elaboracao.id_for_label }}" class="form-label">
              <i class="bi bi-pencil-fill me-1"></i> Elabora√ß√£o
            </label>
            {{ form.elaboracao|add_class:"form-select select2" }}
          </div>

          <div class="col-md-6">
            <label for="{{ form.coordenacao.id_for_label }}" class="form-label">
              <i class="bi bi-people-fill me-1"></i> Coordena√ß√£o
            </label>
            {{ form.coordenacao|add_class:"form-select select2" }}
          </div>

          <div class="col-md-6">
            <label for="{{ form.validacao.id_for_label }}" class="form-label">
              <i class="bi bi-check2-square me-1"></i> Valida√ß√£o
            </label>
            {{ form.validacao|add_class:"form-select select2" }}
          </div>

        </div>
      </div>
    </div>
  </div>
</div>


      <!-- üìä Accordion - Tabela de Notas -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingNotas">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNotas" aria-expanded="false" aria-controls="collapseNotas">
            <i class="bi bi-table me-2"></i> Tabela de Notas por Atividade
          </button>
        </h2>
        <div id="collapseNotas" class="accordion-collapse collapse" aria-labelledby="headingNotas" data-bs-parent="#accordionMatriz">
          <div class="accordion-body">
            <div class="mb-4">
              <label for="select-colaborador" class="form-label"><i class="bi bi-person-plus me-1"></i> Adicionar Colaborador</label>
              <select id="select-colaborador" class="form-select select2">
                <option value="">Selecione o Colaborador</option>
                {% for funcionario in funcionarios %}
                  <option value="{{ funcionario.id }}" data-nome="{{ funcionario.nome }}">{{ funcionario.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div id="tabela-notas-container">
              <div class="tabela-scroll">
                <table class="table table-bordered table-striped" id="tabela-notas">
                  <thead>
                    <tr class="align-middle text-center">
                      <th class="sticky-header align-middle text-center" title="Remover colaborador">
                        <i class="bi bi-trash3-fill"></i>
                      </th>
                      <th class="sticky-header sticky-column align-middle">
                        <i class="bi bi-person-fill me-1"></i> Colaborador
                      </th>
                      <th class="sticky-header sticky-suplente align-middle">
                        <i class="bi bi-person-badge-fill me-1"></i> Perfil
                      </th>
                    </tr>
                  </thead>
                  
                  
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

{% include "partials/global/_botoes_salvar_cancelar.html" with edicao=form.instance.id url_voltar='lista_matriz_polivalencia' %}
  </form>
</div>

<style>
  .tabela-scroll {
    overflow-x: auto;
    max-width: 100%;
    border: 1px solid #dee2e6;
    padding-bottom: 1rem;
  }
</style>
{% if notas_lista %}
  {{ notas_lista|json_script:"notas-json" }}
{% endif %}


{{ funcionarios|json_script:"funcionarios-json" }}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    $('.select2').select2({ placeholder: 'Selecione uma op√ß√£o', allowClear: true });

    let atividades = [];

    // Carrega atividades ao selecionar departamento
    $('#departamento').on('change', function () {
      const departamentoId = $(this).val();
      if (departamentoId) {
        $.ajax({
          url: '{% url "get_atividades_e_funcionarios_por_departamento" %}',
          data: { 'departamento': departamentoId },
          success: function (data) {
            atividades = data.atividades;
            const tabelaNotas = $('#tabela-notas');

            // Cabe√ßalho
            let headRow = '<th class="sticky-header">#</th><th class="sticky-header sticky-column">Colaborador</th><th class="sticky-header sticky-suplente">Suplente</th>';
            atividades.forEach((atividade, index) => {
              headRow += `
                <th class="activity-header">
                  Atividade ${index + 1}
                  <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="${atividade.nome}">
                    <i class="bi bi-info-circle-fill" aria-label="${atividade.nome}"></i>
                  </span>
                </th>`;
            });
            tabelaNotas.find('thead tr').html(headRow);
            tabelaNotas.find('tbody').empty();
            $('#tabela-notas-container').show();

            // Tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

            // Modo edi√ß√£o ‚Äì popula colaboradores e notas
            {% if notas_lista %}
              const notas = JSON.parse(document.getElementById("notas-json").textContent);
              const funcionariosData = JSON.parse(document.getElementById("funcionarios-json").textContent);
              const colaboradorIdsJaInseridos = new Set();

              notas.forEach(nota => {
                if (colaboradorIdsJaInseridos.has(nota.funcionario_id)) return;
                colaboradorIdsJaInseridos.add(nota.funcionario_id);

                const nome = funcionariosData.find(f => f.id === nota.funcionario_id)?.nome || '---';

                let row = `<tr id="linha-funcionario-${nota.funcionario_id}" class="align-middle text-center">
                  <td class="align-middle text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm excluir-colaborador" data-id="${nota.funcionario_id}">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </td>
                  <td class="sticky-column align-middle">${nome}</td>
                  <td class="sticky-suplente align-middle">
                
                    <select name="perfil_${nota.funcionario_id}" class="form-select" required>
                      <option value="">Selecione...</option>
                      <option value="suplente" ${nota.perfil === 'suplente' ? 'selected' : ''}>Suplente</option>
                      <option value="treinado" ${nota.perfil === 'treinado' ? 'selected' : ''}>Treinado</option>
                      <option value="em_treinamento" ${nota.perfil === 'em_treinamento' ? 'selected' : ''}>Em Treinamento</option>
                      <option value="oficial" ${nota.perfil === 'oficial' ? 'selected' : ''}>Oficial</option>
                    </select>
                  </td>`;

                atividades.forEach((atividade) => {
                  const notaDoFuncionario = notas.find(n =>
                    n.funcionario_id === nota.funcionario_id && n.atividade_id === atividade.id
                  );
                  const valor = notaDoFuncionario ? notaDoFuncionario.pontuacao : '';
                  row += `
                    <td>
                      <select name="nota_${nota.funcionario_id}_${atividade.id}" class="form-select">
                        <option value="">Selecione a Nota</option>
                        <option value="0" ${valor == 0 ? 'selected' : ''}>0 - Observador</option>
                        <option value="1" ${valor == 1 ? 'selected' : ''}>1 - Aprendiz</option>
                        <option value="2" ${valor == 2 ? 'selected' : ''}>2 - Assistente</option>
                        <option value="3" ${valor == 3 ? 'selected' : ''}>3 - Aut√¥nomo</option>
                        <option value="4" ${valor == 4 ? 'selected' : ''}>4 - Instrutor</option>
                      </select>
                    </td>`;
                });

                row += '</tr>';
                $('#tabela-notas tbody').append(row);
              });
            {% endif %}
          }
        });
      } else {
        $('#tabela-notas-container').hide();
      }
    });

    // Adicionar colaborador manualmente
    $('#select-colaborador').on('change', function () {
      const id = $(this).val();
      const nome = $(this).find(':selected').data('nome');

      if (!id || $(`#linha-funcionario-${id}`).length > 0) return;

      let row = `<tr id="linha-funcionario-${id}" class="align-middle text-center">
        <td class="align-middle text-center">
          <button type="button" class="btn btn-outline-danger btn-sm excluir-colaborador" data-id="${id}">
            <i class="bi bi-x-lg"></i>
          </button>
        </td>
        <td class="sticky-column align-middle">${nome}</td>
      
       <td class="sticky-suplente">
            <select name="perfil_${id}" class="form-select" required>
              <option value="">Selecione...</option>
              <option value="suplente">Suplente</option>
              <option value="treinado">Treinado</option>
              <option value="em_treinamento">Em Treinamento</option>
              <option value="oficial">Oficial</option>
            </select>
          </td>`;

      atividades.forEach((atividade) => {
        row += `
          <td>
            <select name="nota_${id}_${atividade.id}" class="form-select">
              <option value="">Selecione a Nota</option>
              <option value="0">0 - Observador</option>
              <option value="1">1 - Aprendiz</option>
              <option value="2">2 - Assistente</option>
              <option value="3">3 - Aut√¥nomo</option>
              <option value="4">4 - Instrutor</option>
            </select>
          </td>`;
      });

      row += '</tr>';
      $('#tabela-notas tbody').append(row);
      $(this).val(null).trigger('change');
    });

    // ‚ö†Ô∏è Gatilho autom√°tico no modo edi√ß√£o
    {% if form.instance.pk %}
      setTimeout(function () {
        $('#departamento').trigger('change');
      }, 200);
    {% endif %}
     // Evento para remover colaborador da tabela
$('#tabela-notas').on('click', '.excluir-colaborador', function () {
  const id = $(this).data('id');
  $(`#linha-funcionario-${id}`).remove();
});
  });
 

</script>



{% endblock %}
