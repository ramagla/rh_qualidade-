{% extends 'base.html' %}

{% block title %}Cadastro de Avalia√ß√£o de Treinamentos{% endblock %}

{% block content %}
{% load custom_filters %}

<div class="container mt-5">
    <h2 class="text-center mb-4">Cadastro de Avalia√ß√£o de Treinamentos</h2>

    <!-- Toast container para mensagens de alerta -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11;">
        {% if messages %}
            {% for message in messages %}
                <div class="toast align-items-center border-0" style="background-color: {% if message.tags == 'error' %}#f8d7da; color: #842029;{% else %}#d1e7dd; color: #0f5132;{% endif %};">
                    <div class="d-flex">
                        <div class="toast-body">
                            <h4 class="alert-heading">{% if message.tags == 'error' %}Aten√ß√£o!{% else %}Sucesso!{% endif %}</h4>
                            <p>{{ message }}</p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <form method="post" action="{% url 'avaliacao_create' %}" class="row g-3">
        {% csrf_token %}

        <!-- Data da Avalia√ß√£o -->
        <div class="col-md-6">
            <label for="data_avaliacao" class="form-label">Data da Avalia√ß√£o:</label>
            <input type="date" class="form-control" id="data_avaliacao" name="data_avaliacao" required>
        </div>

        <!-- Per√≠odo da Avalia√ß√£o em Dias -->
        <div class="col-md-6">
            <label for="periodo_avaliacao" class="form-label">Per√≠odo da Avalia√ß√£o (em dias):</label>
            <input type="number" class="form-control" id="periodo_avaliacao" name="periodo_avaliacao" value="60" required>
        </div>

        <!-- Status do Prazo -->
        <div class="col-12 mt-3">
            <label class="form-label">Status do Prazo:</label>
            <div id="status_prazo" class="alert" role="alert">
                <!-- O status do prazo ser√° exibido aqui -->
            </div>
        </div>

        <!-- Nome do Funcion√°rio -->
        <div class="col-md-6">
            <label for="funcionario" class="form-label">Nome do Funcion√°rio:</label>
            <select class="form-select" id="funcionario" name="funcionario" required>
                <option selected>Selecione o funcion√°rio</option>
                {% for funcionario in funcionarios %}
                <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Treinamento/Curso -->
        <div class="col-md-6">
            <label for="treinamento" class="form-label">Treinamento/Curso:</label>
            <select class="form-select" id="treinamento" name="treinamento" required>
                <option selected>Selecione o treinamento</option>
                {% for presenca in listas_presenca %}
                    <option value="{{ presenca.id }}">{{ presenca.treinamento }} - {{ presenca.data_realizacao }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Respons√°veis pela Avalia√ß√£o -->
        <div class="col-12">
            <label for="responsaveis" class="form-label">Respons√°veis pela Avalia√ß√£o:</label>
        </div>

        <!-- Primeiro Respons√°vel -->
        <div class="col-md-6">
            <label for="responsavel1" class="form-label">Primeiro Respons√°vel:</label>
            <select class="form-select" id="responsavel1" name="responsavel1" onchange="preencherCargo(1)">
                <option selected>Selecione o respons√°vel</option>
                {% for funcionario in funcionarios %}
                <option value="{{ funcionario.id }}" data-cargo="{{ funcionario.cargo_atual.nome }}">{{ funcionario.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="cargo1" class="form-label">Cargo:</label>
            <input type="text" class="form-control" id="cargo1" name="cargo1" placeholder="Cargo" readonly>
        </div>

        <!-- Segundo Respons√°vel -->
        <div class="col-md-6">
            <label for="responsavel2" class="form-label">Segundo Respons√°vel:</label>
            <select class="form-select" id="responsavel2" name="responsavel2" onchange="preencherCargo(2)">
                <option selected>Selecione o respons√°vel</option>
                {% for funcionario in funcionarios %}
                <option value="{{ funcionario.id }}" data-cargo="{{ funcionario.cargo_atual.nome }}">{{ funcionario.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="cargo2" class="form-label">Cargo:</label>
            <input type="text" class="form-control" id="cargo2" name="cargo2" placeholder="Cargo" readonly>
        </div>

        <!-- Terceiro Respons√°vel -->
        <div class="col-md-6">
            <label for="responsavel3" class="form-label">Terceiro Respons√°vel:</label>
            <select class="form-select" id="responsavel3" name="responsavel3" onchange="preencherCargo(3)">
                <option selected>Selecione o respons√°vel</option>
                {% for funcionario in funcionarios %}
                <option value="{{ funcionario.id }}" data-cargo="{{ funcionario.cargo_atual.nome }}">{{ funcionario.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="cargo3" class="form-label">Cargo:</label>
            <input type="text" class="form-control" id="cargo3" name="cargo3" placeholder="Cargo" readonly>
        </div>

        <!-- Question√°rios -->
        <div class="col-12">
            <label class="form-label">I - Grau de conhecimento atual dos participantes da metodologia:</label>
            {% for valor, label in opcoes_conhecimento %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="conhecimento" id="conhecimento{{ valor }}" value="{{ valor }}" required>
                <label class="form-check-label" for="conhecimento{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

        <div class="col-12">
            <label class="form-label">II - Aplica√ß√£o dos conceitos da metodologia:</label>
            {% for valor, label in opcoes_aplicacao %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="aplicacao" id="aplicacao{{ valor }}" value="{{ valor }}" required>
                <label class="form-check-label" for="aplicacao{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

        <div class="col-12">
            <label class="form-label">III - Resultados obtidos com a aplica√ß√£o da metodologia:</label>
            {% for valor, label in opcoes_resultados %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="resultados" id="resultados{{ valor }}" value="{{ valor }}" required>
                <label class="form-check-label" for="resultados{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

        <!-- Descrever Melhorias -->
        <div class="col-12">
            <label for="melhorias" class="form-label">Descreva as melhorias obtidas/resultados:</label>
            <div class="form-floating">
                <textarea class="form-control" id="melhorias" name="melhorias" style="height: 100px"></textarea>
                <label for="melhorias">Coment√°rios</label>
            </div>
        </div>

        <!-- Avalia√ß√£o Geral -->
        <div class="col-12 mt-3">
            <label for="avaliacao_geral" class="form-label">Avalia√ß√£o Geral do Treinamento:</label>
            <div id="avaliacao_geral" class="alert" role="alert">
                <!-- O resultado da avalia√ß√£o ser√° exibido aqui -->
            </div>
        </div>

        <!-- Bot√£o de submiss√£o -->
        <div class="col-12">
            <button type="submit" class="btn btn-primary w-100 mt-3">Salvar Avalia√ß√£o</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function calcularAvaliacaoGeral() {
            let total = 0;
            let poucoEficaz = false;

            document.querySelectorAll('input[type="radio"]:checked').forEach(function (input) {
                const valor = parseInt(input.value);
                if (valor === 1) {
                    poucoEficaz = true;
                }
                total += valor;
            });

            const avaliacaoGeralDiv = document.getElementById('avaliacao_geral');
            let status = '';
            let cor = '';
            let emoji = '';

            if (poucoEficaz) {
                status = 'Pouco Eficaz';
                cor = 'alert-danger';
                emoji = 'üòî';
            } else if (total >= 8 && total <= 11) {
                status = 'Eficaz';
                cor = 'alert-warning';
                emoji = 'üòä';
            } else if (total >= 12 && total <= 15) {
                status = 'Muito Eficaz';
                cor = 'alert-success';
                emoji = 'üòÑ';
            } else {
                status = 'Selecione todas as respostas';
                cor = 'alert-secondary';
                emoji = '‚ùì';
            }

            avaliacaoGeralDiv.className = `alert ${cor}`;
            avaliacaoGeralDiv.textContent = `${status} ${emoji}`;
        }

        function verificarPrazo() {
            const dataAvaliacao = document.getElementById('data_avaliacao').value;
            const periodoAvaliacao = parseInt(document.getElementById('periodo_avaliacao').value);
            const statusPrazoDiv = document.getElementById('status_prazo');

            if (dataAvaliacao && periodoAvaliacao) {
                const dataAvaliacaoDate = new Date(dataAvaliacao);
                const dataLimite = new Date(dataAvaliacaoDate);
                dataLimite.setDate(dataLimite.getDate() + periodoAvaliacao);

                const hoje = new Date();
                let status = '';
                let cor = '';
                let emoji = '';

                if (hoje <= dataLimite) {
                    status = 'Dentro do Prazo';
                    cor = 'alert-success';
                    emoji = 'üòÉ';
                } else {
                    status = 'Fora do Prazo';
                    cor = 'alert-danger';
                    emoji = 'üòî';
                }

                statusPrazoDiv.className = `alert ${cor}`;
                statusPrazoDiv.textContent = `${status} ${emoji}`;
            } else {
                statusPrazoDiv.className = 'alert alert-secondary';
                statusPrazoDiv.textContent = 'Defina a data de avalia√ß√£o e o per√≠odo.';
            }
        }

        function preencherCargo(numeroResponsavel) {
            const responsavelSelect = document.getElementById('responsavel' + numeroResponsavel);
            const cargoInput = document.getElementById('cargo' + numeroResponsavel);

            responsavelSelect.addEventListener('change', function () {
                const funcionarioId = responsavelSelect.value;

                if (funcionarioId) {
                    fetch(`/get-cargo/${funcionarioId}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro na resposta do servidor');
                            }
                            return response.json();
                        })
                        .then(data => {
                            cargoInput.value = data.cargo || 'Cargo n√£o encontrado';
                        })
                        .catch(error => {
                            console.error('Erro ao buscar o cargo:', error);
                            cargoInput.value = 'Erro ao carregar o cargo';
                        });
                } else {
                    cargoInput.value = '';
                }
            });
        }

        [1, 2, 3].forEach(preencherCargo);

        document.querySelectorAll('input[type="radio"]').forEach(function (input) {
            input.addEventListener('change', calcularAvaliacaoGeral);
        });

        document.getElementById('data_avaliacao').addEventListener('change', verificarPrazo);
        document.getElementById('periodo_avaliacao').addEventListener('input', verificarPrazo);

        verificarPrazo();
    });
</script>

{% endblock %}
