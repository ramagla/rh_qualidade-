{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Cadastrar Colaboradores{% endblock %}

{% block content %}
{% block errors %}{% endblock %}

<div class="container mt-5">
   <h2 class="text-center mb-4">
    <i class="bi bi-person-fill me-2"></i>
    {% if funcionario %}Editar{% else %}Cadastrar{% endif %} Colaboradores
</h2>


    <form method="post" enctype="multipart/form-data" class="row g-3" id="funcionarioForm">
        {% csrf_token %}
          {% if form.errors %}
    {% include "partials/global/_form_errors.html" %}
  {% endif %}
        <div class="accordion" id="accordionColaborador">
            <!-- üì∏ Foto e Arquivos -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingFoto">
                    <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFoto" aria-expanded="true" aria-controls="collapseFoto">
                        <i class="bi bi-image me-2"></i> Foto e Arquivos
                    </button>
                </h2>
                <div id="collapseFoto" class="accordion-collapse collapse show" aria-labelledby="headingFoto" data-bs-parent="#accordionColaborador">
                    <div class="accordion-body row g-3">
                        <!-- Foto -->
                        <div class="col-md-6">
                            <label for="foto" class="form-label">
                                <i class="bi bi-image me-1"></i> Foto:
                            </label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('id_foto').click();">
                                    <i class="bi bi-image"></i>
                                </button>
                                <input type="text" class="form-control" placeholder="Nenhum arquivo selecionado" id="foto_filename" readonly>
                            </div>
                            <input type="file" id="id_foto" name="foto" style="display: none;" onchange="document.getElementById('foto_filename').value = this.files[0].name;">
                            {% if funcionario.foto %}
                                <div class="mt-2 text-center">
                                    <img src="/media/{{ funcionario.foto.name }}" alt="Foto do Colaborador" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Assinatura -->
                        <div class="col-md-6">
                            <label for="assinatura_eletronica" class="form-label">
                                <i class="bi bi-pencil-square me-1"></i> Assinatura Eletr√¥nica:
                            </label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('id_assinatura_eletronica').click();">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <input type="text" class="form-control" placeholder="Nenhum arquivo selecionado" id="assinatura_filename" readonly>
                            </div>
                            <input type="file" id="id_assinatura_eletronica" name="assinatura_eletronica" style="display: none;" onchange="document.getElementById('assinatura_filename').value = this.files[0].name;">
                            {% if funcionario.assinatura_eletronica %}
                                <div class="mt-2 text-center">
                                    <img src="{{ funcionario.assinatura_eletronica.url }}" alt="Assinatura Eletr√¥nica" style="width: 200px; height: auto; object-fit: contain;">
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Curr√≠culo -->
                        <div class="col-md-6">
                            <label for="curriculo" class="form-label">
                                <i class="bi bi-file-earmark-pdf me-1"></i> Curr√≠culo:
                            </label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('id_curriculo').click();">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </button>
                                <input type="text" class="form-control" placeholder="Nenhum arquivo selecionado" id="curriculo_filename" readonly>
                            </div>
                            <input type="file" id="id_curriculo" name="curriculo" style="display: none;" onchange="document.getElementById('curriculo_filename').value = this.files[0].name;">
                            {% if funcionario.curriculo %}
                                <div class="mt-2">
                                    <a href="{{ funcionario.curriculo.url }}" class="btn btn-info" download>Baixar Curr√≠culo</a>
                                    <p>Atualmente: {{ funcionario.curriculo.name }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- üë§ Dados Pessoais -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingDados">
                    <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDados" aria-expanded="false" aria-controls="collapseDados">
                        <i class="bi bi-person-lines-fill me-2"></i> Dados Pessoais
                    </button>
                </h2>
                <div id="collapseDados" class="accordion-collapse collapse" aria-labelledby="headingDados" data-bs-parent="#accordionColaborador">
                    <div class="accordion-body row g-3">
                        <div class="col-md-6">
                            <label for="nome" class="form-label">
                                <i class="bi bi-person-fill me-1"></i> Nome:
                            </label>
                            {{ form.nome }}
                        </div>

            <div class="col-md-6">
  <label for="{{ form.data_admissao.id_for_label }}" class="form-label">
    <i class="bi bi-calendar-check-fill me-1"></i> Data de Admiss√£o:
  </label>
  {{ form.data_admissao }}
</div>
<div class="col-md-6">
    <label for="{{ form.data_nascimento.id_for_label }}" class="form-label">
      <i class="bi bi-gift-fill me-1"></i> Data de Nascimento:
    </label>
    {{ form.data_nascimento }}
  </div>
  



                        <div class="col-md-6">
                            <label for="cargo_inicial" class="form-label">
                                <i class="bi bi-briefcase-fill me-1"></i> Cargo Inicial:
                            </label>
                            {{ form.cargo_inicial|add_class:"form-select" }}
                        </div>

                        <div class="col-md-6">
                            <label for="cargo_atual" class="form-label">
                                <i class="bi bi-briefcase-fill me-1"></i> Cargo Atual:
                            </label>
                            {{ form.cargo_atual|add_class:"form-select" }}
                        </div>

                        <div class="col-md-6">
                            <label for="numero_registro" class="form-label">
                                <i class="bi bi-123 me-1"></i> N√∫mero de Registro:
                            </label>
                            {{ form.numero_registro }}
                        </div>
                        <div class="col-md-6">
                            <label for="user" class="form-label">
                                <i class="bi bi-person-lock me-1"></i> Usu√°rio do Sistema:
                            </label>
                            {{ form.user|add_class:"form-select select2" }}
                        </div>                        

                        <div class="col-md-6">
                            <label for="local_trabalho" class="form-label">
                                <i class="bi bi-geo-alt-fill me-1"></i> Local de Trabalho:
                            </label>
                            {{ form.local_trabalho|add_class:"form-select select2" }}
                        </div>

                        <div class="col-md-6">
                            <label for="escolaridade" class="form-label">
                                <i class="bi bi-mortarboard-fill me-1"></i> Escolaridade:
                            </label>
                            {{ form.escolaridade|add_class:"form-select select2" }}
                        </div>

                    </div>
                </div>
            </div>

            <!-- üß† Experi√™ncia -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingExp">
                    <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExp" aria-expanded="false" aria-controls="collapseExp">
                        <i class="bi bi-briefcase-fill me-2"></i> Experi√™ncia Profissional
                    </button>
                </h2>
                <div id="collapseExp" class="accordion-collapse collapse" aria-labelledby="headingExp" data-bs-parent="#accordionColaborador">
                    <div class="accordion-body row g-3">
                        <div class="col-md-6">
                            <label for="experiencia_profissional" class="form-label">
                                <i class="bi bi-briefcase-fill me-1"></i> Experi√™ncia Profissional:
                            </label>
                            {{ form.experiencia_profissional }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- üë®‚Äçüíº Respons√°vel -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingResp">
                    <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResp" aria-expanded="false" aria-controls="collapseResp">
                        <i class="bi bi-person-check-fill me-2"></i> Respons√°vel
                    </button>
                </h2>
                <div id="collapseResp" class="accordion-collapse collapse" aria-labelledby="headingResp" data-bs-parent="#accordionColaborador">
                    <div class="accordion-body row g-3">
                        <div class="col-md-6">
                            <label for="responsavel" class="form-label">
                                <i class="bi bi-person-check-fill me-1"></i> Respons√°vel:
                            </label>
                            {{ form.responsavel|add_class:"form-select select2" }}
                        </div>

                        <div class="col-md-6">
                            <label for="cargo_responsavel" class="form-label">Cargo do Respons√°vel:</label>
                            <input type="text" class="form-control" id="cargo_responsavel" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üìÑ Certificados -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingCertificados">
                    <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCertificados" aria-expanded="false" aria-controls="collapseCertificados">
                        <i class="bi bi-file-earmark-check-fill me-2"></i> Certificados
                    </button>
                </h2>
                <div id="collapseCertificados" class="accordion-collapse collapse" aria-labelledby="headingCertificados" data-bs-parent="#accordionColaborador">
                    <div class="accordion-body row g-3">
                        <div class="col-md-6">
                            <label for="formulario_f146" class="form-label">Certificado de Conclus√£o de Ensino M√©dio:</label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('id_formulario_f146').click();">Selecionar Arquivo</button>
                                <input type="text" class="form-control" placeholder="Nenhum arquivo selecionado" id="formulario_f146_filename" readonly>
                            </div>
                            <input type="file" id="id_formulario_f146" name="formulario_f146" style="display: none;" onchange="document.getElementById('formulario_f146_filename').value = this.files[0].name;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Status -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingStatus">
                    <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStatus" aria-expanded="false" aria-controls="collapseStatus">
                        <i class="bi bi-check-circle-fill me-2"></i> Status
                    </button>
                </h2>
                <div id="collapseStatus" class="accordion-collapse collapse" aria-labelledby="headingStatus" data-bs-parent="#accordionColaborador">
                    <div class="accordion-body row g-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">
                                <i class="bi bi-check-circle-fill me-1"></i> Status:
                            </label>
                            {{ form.status|add_class:"form-select" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="col-12 text-center mt-4">
            {% include "partials/global/_botoes_salvar_cancelar.html" with edicao=edicao url_voltar='lista_funcionarios' %}
        </div>
    </form>
</div>


   <!-- Script para edi√ß√£o -->
<script>
    // Fun√ß√£o para editar a foto
function editarFoto() {
    document.getElementById('fotoInput').click();
}

// Fun√ß√£o para editar o curr√≠culo
function editarCurriculo() {
    document.getElementById('curriculoInput').click();
}

// Fun√ß√£o para preencher o campo de cargo do respons√°vel automaticamente
function preencherCargo() {
    const responsavelSelect = $('#id_responsavel'); // Usar jQuery para o Select2
    const cargoInput = document.getElementById('cargo_responsavel');

    // Vari√°vel para armazenar o ID do respons√°vel selecionado
    let idResponsavelAnterior = '';

    // Evento para detec√ß√£o de sele√ß√£o no Select2
    responsavelSelect.on('select2:select', function (e) {
        const funcionarioId = e.params.data.id; // Obt√©m o ID do funcion√°rio selecionado

        // S√≥ dispara a requisi√ß√£o se o ID for diferente do valor anterior
        if (funcionarioId && funcionarioId !== idResponsavelAnterior) {
            idResponsavelAnterior = funcionarioId; // Atualiza o ID anterior

            fetch(`/get-cargo/${funcionarioId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta do servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    // Preenche o campo cargo com o valor retornado pela API
                    cargoInput.value = data.cargo || 'Cargo n√£o encontrado';
                })
                .catch(error => {
                    console.error('Erro ao buscar o cargo:', error);
                    cargoInput.value = 'Erro ao carregar o cargo';
                });
        } else {
            console.log('ID do respons√°vel n√£o mudou, n√£o disparando a requisi√ß√£o.');
        }
    });
}

// Inicializa o preenchimento do cargo no carregamento da p√°gina
document.addEventListener("DOMContentLoaded", function () {
    // Inicializa o Select2 no campo respons√°vel (somente se vis√≠vel)
    const responsavelSelect = $('#id_responsavel');
    if (responsavelSelect.length) {
        responsavelSelect.select2({
            placeholder: 'Selecione um respons√°vel',
            allowClear: true
        });

        preencherCargo(); // Configura o evento de sele√ß√£o no Select2

        // Preencher o campo de cargo ao carregar a p√°gina, se houver um respons√°vel selecionado
        const funcionarioId = $('#id_responsavel').val(); // Obt√©m o valor inicial do Select2
        if (funcionarioId) {
            fetch(`/get-cargo/${funcionarioId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta do servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('cargo_responsavel').value = data.cargo || 'Cargo n√£o encontrado';
                })
                .catch(error => console.error('Erro ao buscar cargo do respons√°vel:', error));
        }
    }
});

// Fun√ß√£o para aplicar a m√°scara dd/mm/aaaa
function mascaraData(input) {
    var valor = input.value.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos
    if (valor.length <= 2) {
        input.value = valor.replace(/(\d{2})/, '$1');
    } else if (valor.length <= 4) {
        input.value = valor.replace(/(\d{2})(\d{2})/, '$1/$2');
    } else if (valor.length <= 6) {
        input.value = valor.replace(/(\d{2})(\d{2})(\d{4})/, '$1/$2/$3');
    } else {
        input.value = valor.replace(/(\d{2})(\d{2})(\d{4})/, '$1/$2/$3').substring(0, 10); // Limita a 10 caracteres
    }
}

</script>

{% endblock %}