{% extends 'base.html' %}

{% block title %}Cadastro de Avalia칞칚o de Treinamentos{% endblock %}

{% block content %}
{% load custom_filters %}

    <div class="container mt-5">
        <h2 class="text-center mb-4">Cadastro de Avalia칞칚o de Treinamentos</h2>

        <!-- Valida칞칚o de Erros do Formul치rio -->
    {% if form.errors %}
        <div class="alert alert-danger">
            <strong>Erro!</strong> Por favor, corrija os seguintes erros:
            <ul>
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>
                            {{ field|capfirst }}: {{ error }}
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    

    <form method="post" action="{% url 'avaliacao_create' %}" class="row g-3">
        {% csrf_token %}

        

        <!-- Data da Avalia칞칚o -->
        <div class="col-md-6">
            <label for="data_avaliacao" class="form-label">Data da Avalia칞칚o:</label>
            <input type="date" class="form-control" id="data_avaliacao" name="data_avaliacao" required>
        </div>

        <!-- Per칤odo da Avalia칞칚o em Dias -->
        <div class="col-md-6">
            <label for="periodo_avaliacao" class="form-label">Per칤odo da Avalia칞칚o (em dias):</label>
            <input type="number" class="form-control" id="periodo_avaliacao" name="periodo_avaliacao" value="60" required>
        </div>

        <!-- Status do Prazo -->
        <div class="col-12 mt-3">
                <label class="form-label">Status do Prazo:</label>
                <div id="status_prazo" class="alert alert-secondary" role="alert">
                    Defina a data de avalia칞칚o e o per칤odo.
                </div>
            </div>

        <div class="row">
            <!-- Nome do Funcion치rio -->
            <div class="col-md-6">
                <label for="funcionario" class="form-label">Funcion치rio:</label>
                <select class="form-select select2" id="funcionario" name="funcionario" required>
                    <option value="" selected>Selecione o funcion치rio</option>
                    {% for funcionario in funcionarios %}
                        <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Treinamento/Curso -->
            <div class="col-md-6">
                <label for="treinamento" class="form-label">Treinamento/Curso:</label>
                <select class="form-select select2" id="treinamento" name="treinamento" required>
                    <option value="" selected>Selecione o treinamento</option>
                </select>
            </div>

        <!-- Respons치veis pela Avalia칞칚o -->
        <div class="col-12">
            <label for="responsaveis" class="form-label">Respons치veis pela Avalia칞칚o:</label>
        </div>

        <!-- Primeiro Respons치vel -->
        <div class="col-md-6">
            <label for="responsavel_1" class="form-label">Primeiro Respons치vel:</label>
            {{ form.responsavel_1 |add_class:"form-select select2" }}
        </div>

        <!-- Segundo Respons치vel -->
        <div class="col-md-6">
            <label for="responsavel_2" class="form-label">Segundo Respons치vel:</label>
            {{ form.responsavel_2 |add_class:"form-select select2" }}
        </div>

        <!-- Terceiro Respons치vel -->
        <div class="col-md-6">
            <label for="responsavel_3" class="form-label">Terceiro Respons치vel:</label>
            {{ form.responsavel_3 |add_class:"form-select select2" }}
        </div>



        <!-- Question치rios -->
          <!-- Pergunta 1 -->
        <div class="col-12">
            <label class="form-label">I- Com rela칞칚o ao grau de conhecimento atual dos participantes da metodologia provida pelo treinamento?:</label>
            {% for valor, label in opcoes_conhecimento %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="pergunta_1" id="pergunta_1_{{ valor }}" value="{{ valor }}" required>
                <label class="form-check-label" for="pergunta_1_{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

    <!-- Pergunta 2 -->
    <div class="col-12">
        <label class="form-label">II- Com rela칞칚o a aplica칞칚o pelos participantes, quando necess치rio, dos conceitos da metodologia:</label>
        {% for valor, label in opcoes_aplicacao %}
        <div class="form-check">
            <input class="form-check-input" type="radio" name="pergunta_2" id="pergunta_2_{{ valor }}" value="{{ valor }}" required>
            <label class="form-check-label" for="pergunta_2_{{ valor }}">{{ valor }} - {{ label }}</label>
        </div>
        {% endfor %}
    </div>

    <!-- Pergunta 3 -->
    <div class="col-12">
        <label class="form-label">III- Com rela칞칚o aos resultados obtidos com a aplica칞칚o da metologia na melhoria das atividades, processos, servi칞os ou produtos da 치rea ou empresa:</label>
        {% for valor, label in opcoes_resultados %}
        <div class="form-check">
            <input class="form-check-input" type="radio" name="pergunta_3" id="pergunta_3_{{ valor }}" value="{{ valor }}" required>
            <label class="form-check-label" for="pergunta_3_{{ valor }}">{{ valor }} - {{ label }}</label>
        </div>
        {% endfor %}
    </div>

        <!-- Descri칞칚o de Melhorias -->
        <div class="col-12">
            <label for="descricao_melhorias" class="form-label">Descreva as melhorias obtidas/resultados:</label>
            {{ form.descricao_melhorias }}
        </div>


      <!-- Campo oculto para Avalia칞칚o Geral -->
    <input type="hidden"  name="avaliacao_geral" id="avaliacao_geral" value="12">

        <!-- Campo vis칤vel para o Status da Avalia칞칚o -->
        <div class="col-md-6">
            <label for="avaliacao_status" class="form-label">Status da Avalia칞칚o:</label>
            <span id="avaliacao_status" class="form-control-plaintext">Eficaz</span> <!-- Status inicial -->
        </div>
            

                   <!-- Bot칫es de a칞칚o -->
        <div class="col-12 text-center mt-3">
            <div class="btn-group" role="group" aria-label="A칞칫es do formul치rio">
                <!-- Bot칚o de Salvar -->
                <button type="submit" class="btn btn-primary me-2"><i class="bi bi-save"></i> Salvar</button>

                <!-- Bot칚o de Cancelar -->
                <a href="{% url 'lista_avaliacoes' %}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Cancelar</a>
            </div>
        </div>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Fun칞칚o para calcular a avalia칞칚o geral
        function calcularAvaliacaoGeral() {
            let total = 0;
            let poucoEficaz = false;

            // Calcula o total somando os valores das respostas e verifica se h치 alguma resposta "Pouco Eficaz"
            document.querySelectorAll('input[type="radio"]:checked').forEach(function (input) {
                const valor = parseInt(input.value);
                if (valor === 1) {
                    poucoEficaz = true; // Define como pouco eficaz se qualquer resposta for 1
                }
                total += valor; // Soma os valores das respostas
            });

            const avaliacaoGeralInput = document.getElementById("avaliacao_geral");
            const avaliacaoStatus = document.getElementById("avaliacao_status"); // Certifique-se de que este elemento exista

            let valorAvaliacao;
            let statusAvaliacao;

            // Define a pontua칞칚o e o status da avalia칞칚o com base no total acumulado
            if (poucoEficaz) {
                valorAvaliacao = 1; // Pouco Eficaz
                statusAvaliacao = "Pouco Eficaz";
            } else if (total < 15) {
                valorAvaliacao = 2; // Eficaz
                statusAvaliacao = "Eficaz";
            } else if (total === 15) { // 5 + 5 + 5 para tr칡s respostas excelentes
                valorAvaliacao = 5; // Muito Eficaz
                statusAvaliacao = "Muito Eficaz";
            } else {
                valorAvaliacao = 0; // Valor padr칚o caso nenhuma condi칞칚o seja atendida
                statusAvaliacao = "Indeterminado"; // Mensagem padr칚o
            }

            // Atualiza o valor do campo de avalia칞칚o geral e o status no DOM
            if (avaliacaoGeralInput) {
                avaliacaoGeralInput.value = valorAvaliacao;
            }
            if (avaliacaoStatus) {
                avaliacaoStatus.textContent = statusAvaliacao;
            }

            console.log("Avalia칞칚o geral:", valorAvaliacao, "Status:", statusAvaliacao);
        }

        // Fun칞칚o para verificar o status do prazo
        function verificarPrazo() {
            const dataAvaliacao = document.getElementById("data_avaliacao").value;
            const periodoAvaliacao = parseInt(document.getElementById("periodo_avaliacao").value);
            const statusPrazoDiv = document.getElementById("status_prazo");

            if (dataAvaliacao && !isNaN(periodoAvaliacao)) {
                const dataAvaliacaoDate = new Date(dataAvaliacao);
                const dataLimite = new Date(dataAvaliacaoDate);
                dataLimite.setDate(dataLimite.getDate() + periodoAvaliacao);

                const hoje = new Date();
                let status = "";
                let cor = "";
                let emoji = "";

                if (hoje <= dataLimite) {
                    status = "Dentro do Prazo";
                    cor = "alert-success";
                    emoji = "游땎";
                } else {
                    status = "Fora do Prazo";
                    cor = "alert-danger";
                    emoji = "游땞";
                }

                statusPrazoDiv.className = `alert ${cor}`;
                statusPrazoDiv.textContent = `${status} ${emoji}`;
                console.log("Status do prazo:", status);
            } else {
                statusPrazoDiv.className = "alert alert-secondary";
                statusPrazoDiv.textContent = "Defina a data de avalia칞칚o e o per칤odo.";
            }
        }

        // Eventos para atualizar o status do prazo ao alterar data ou per칤odo
        document.getElementById("data_avaliacao").addEventListener("change", verificarPrazo);
        document.getElementById("periodo_avaliacao").addEventListener("input", verificarPrazo);

        // Configura칞칚o do Select2 para Funcion치rio e Treinamento
        const funcionarioSelect = $("#funcionario"); // Usando Select2
        const treinamentoSelect = $("#treinamento"); // Usando Select2 tamb칠m

        // Inicializa o Select2 no campo de funcion치rio
        funcionarioSelect.select2({
            placeholder: "Selecione um Funcion치rio",
            allowClear: true
        });

        // Inicializa o Select2 no campo de treinamento
        treinamentoSelect.select2({
            placeholder: "Selecione o Treinamento",
            allowClear: true
        });

        // Evento de mudan칞a no Select2 do funcion치rio
        funcionarioSelect.on("select2:select", function (e) {
            const funcionarioId = e.params.data.id; // ID do funcion치rio selecionado
            console.log("Funcion치rio selecionado:", funcionarioId);

            if (funcionarioId) {
                // Atualiza o Select2 com um placeholder enquanto carrega
                treinamentoSelect.html('<option value="">Carregando...</option>').trigger("change");

                // Faz a requisi칞칚o para buscar os treinamentos
                fetch(`/get-treinamentos-funcionarios/${funcionarioId}/`)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`Erro na API: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log("Dados recebidos da API:", data);

                        // Limpa as op칞칫es do Select2 e popula com os novos dados
                        treinamentoSelect.empty().append('<option value="">Selecione o Treinamento</option>');
                        if (data.length === 0) {
                            treinamentoSelect.append('<option value="">Nenhum treinamento encontrado</option>');
                        } else {
                            data.forEach((treinamento) => {
                                console.log("Adicionando treinamento:", treinamento); // Log dos dados
                                const option = new Option(
                                    `${treinamento.nome_curso} (${treinamento.data_fim || "Sem data"})`,
                                    treinamento.id,
                                    false,
                                    false
                                );
                                treinamentoSelect.append(option);
                            });
                        }

                        // Atualiza o Select2
                        treinamentoSelect.trigger("change");
                    })
                    .catch((error) => {
                        console.error("Erro ao carregar treinamentos:", error);
                        treinamentoSelect.html('<option value="">Erro ao carregar treinamentos</option>').trigger("change");
                    });
            } else {
                // Caso nenhum funcion치rio seja selecionado, limpa o Select2
                treinamentoSelect.html('<option value="">Selecione o Treinamento</option>').trigger("change");
            }
        });

        // Adiciona eventos de mudan칞a para calcular avalia칞칚o geral
        document.querySelectorAll('input[type="radio"]').forEach(function (input) {
            input.addEventListener("change", calcularAvaliacaoGeral);
        });

        // Inicializa os valores de prazo e avalia칞칚o geral ao carregar a p치gina
        verificarPrazo();
        calcularAvaliacaoGeral();
    });
</script>


{% endblock %}
