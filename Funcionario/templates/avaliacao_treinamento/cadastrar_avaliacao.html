{% extends 'base.html' %}

{% block title %}Cadastro de Avalia칞칚o de Treinamentos{% endblock %}

{% block content %}
{% load custom_filters %}

    <div class="container mt-5">
        <h2 class="text-center mb-4">Cadastro de Avalia칞칚o de Treinamentos</h2>

        <!-- Valida칞칚o de Erros do Formul치rio -->
    {% if form.errors %}
        <div class="alert alert-danger">
            <strong>Erro!</strong> Por favor, corrija os seguintes erros:
            <ul>
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>
                            {{ field|capfirst }}: {{ error }}
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    

    <form method="post" action="{% url 'avaliacao_create' %}" class="row g-3">
        {% csrf_token %}

        

        <!-- Data da Avalia칞칚o -->
        <div class="col-md-6">
            <label for="data_avaliacao" class="form-label">Data da Avalia칞칚o:</label>
            <input type="date" class="form-control" id="data_avaliacao" name="data_avaliacao" required>
        </div>

        <!-- Per칤odo da Avalia칞칚o em Dias -->
        <div class="col-md-6">
            <label for="periodo_avaliacao" class="form-label">Per칤odo da Avalia칞칚o (em dias):</label>
            <input type="number" class="form-control" id="periodo_avaliacao" name="periodo_avaliacao" value="60" required>
        </div>

        <!-- Status do Prazo -->
        <div class="col-12 mt-3">
            <label class="form-label">Status do Prazo:</label>
            <div id="status_prazo" class="alert" role="alert">
                <!-- O status do prazo ser치 exibido aqui -->
            </div>
        </div>

        <div class="row">
            <!-- Nome do Funcion치rio -->
            <div class="col-md-6">
                <label for="funcionario" class="form-label">Funcion치rio:</label>
                <select class="form-select" id="funcionario" name="funcionario" required>
                    <option selected>Selecione o funcion치rio</option>
                    {% for funcionario in funcionarios %}
                        <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Treinamento/Curso -->
            <div class="col-md-6">
                <label for="treinamento" class="form-label">Treinamento/Curso:</label>
                <select class="form-select" id="treinamento" name="treinamento" required>
                    <option selected>Selecione o treinamento</option>
                    <!-- op칞칫es de treinamento ser칚o carregadas aqui via JavaScript -->
                </select>
            </div>
        </div>


        <!-- Respons치veis pela Avalia칞칚o -->
        <div class="col-12">
            <label for="responsaveis" class="form-label">Respons치veis pela Avalia칞칚o:</label>
        </div>

        <!-- Primeiro Respons치vel -->
        <div class="col-md-6">
            <label for="responsavel_1" class="form-label">Primeiro Respons치vel:</label>
            {{ form.responsavel_1 }}
        </div>

        <!-- Segundo Respons치vel -->
        <div class="col-md-6">
            <label for="responsavel_2" class="form-label">Segundo Respons치vel:</label>
            {{ form.responsavel_2 }}
        </div>

        <!-- Terceiro Respons치vel -->
        <div class="col-md-6">
            <label for="responsavel_3" class="form-label">Terceiro Respons치vel:</label>
            {{ form.responsavel_3 }}
        </div>



        <!-- Question치rios -->
          <!-- Pergunta 1 -->
        <div class="col-12">
            <label class="form-label">I- Com rela칞칚o ao grau de conhecimento atual dos participantes da metodologia provida pelo treinamento?:</label>
            {% for valor, label in opcoes_conhecimento %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="pergunta_1" id="pergunta_1_{{ valor }}" value="{{ valor }}" required>
                <label class="form-check-label" for="pergunta_1_{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

    <!-- Pergunta 2 -->
    <div class="col-12">
        <label class="form-label">II- Com rela칞칚o a aplica칞칚o pelos participantes, quando necess치rio, dos conceitos da metodologia:</label>
        {% for valor, label in opcoes_aplicacao %}
        <div class="form-check">
            <input class="form-check-input" type="radio" name="pergunta_2" id="pergunta_2_{{ valor }}" value="{{ valor }}" required>
            <label class="form-check-label" for="pergunta_2_{{ valor }}">{{ valor }} - {{ label }}</label>
        </div>
        {% endfor %}
    </div>

    <!-- Pergunta 3 -->
    <div class="col-12">
        <label class="form-label">III- Com rela칞칚o aos resultados obtidos com a aplica칞칚o da metologia na melhoria das atividades, processos, servi칞os ou produtos da 치rea ou empresa:</label>
        {% for valor, label in opcoes_resultados %}
        <div class="form-check">
            <input class="form-check-input" type="radio" name="pergunta_3" id="pergunta_3_{{ valor }}" value="{{ valor }}" required>
            <label class="form-check-label" for="pergunta_3_{{ valor }}">{{ valor }} - {{ label }}</label>
        </div>
        {% endfor %}
    </div>

        <!-- Descri칞칚o de Melhorias -->
        <div class="col-12">
            <label for="descricao_melhorias" class="form-label">Descreva as melhorias obtidas/resultados:</label>
            {{ form.descricao_melhorias }}
        </div>


      <!-- Campo oculto para Avalia칞칚o Geral -->
    <input type="hidden"  name="avaliacao_geral" id="avaliacao_geral" value="12">

        <!-- Campo vis칤vel para o Status da Avalia칞칚o -->
        <div class="col-md-6">
            <label for="avaliacao_status" class="form-label">Status da Avalia칞칚o:</label>
            <span id="avaliacao_status" class="form-control-plaintext">Eficaz</span> <!-- Status inicial -->
        </div>
            

                   <!-- Bot칫es de a칞칚o -->
        <div class="col-12 text-center mt-3">
            <div class="btn-group" role="group" aria-label="A칞칫es do formul치rio">
                <!-- Bot칚o de Salvar -->
                <button type="submit" class="btn btn-primary me-2"><i class="bi bi-save"></i> Salvar</button>

                <!-- Bot칚o de Cancelar -->
                <a href="{% url 'lista_avaliacoes' %}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Cancelar</a>
            </div>
        </div>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fun칞칚o para calcular a avalia칞칚o geral
        function calcularAvaliacaoGeral() {
            let total = 0;
            let poucoEficaz = false;

            // Calcula o total somando os valores das respostas e verifica se h치 alguma resposta "Pouco Eficaz"
            document.querySelectorAll('input[type="radio"]:checked').forEach(function (input) {
                const valor = parseInt(input.value);
                if (valor === 1) {
                    poucoEficaz = true; // Define como pouco eficaz se qualquer resposta for 1
                }
                total += valor; // Soma os valores das respostas
            });

            const avaliacaoGeralInput = document.getElementById('avaliacao_geral');
            const avaliacaoStatus = document.getElementById('avaliacao_status'); // Certifique-se de que este elemento exista

            let valorAvaliacao;
            let statusAvaliacao;

            // Define a pontua칞칚o e o status da avalia칞칚o com base no total acumulado
            if (poucoEficaz) {
                valorAvaliacao = 1; // Pouco Eficaz
                statusAvaliacao = 'Pouco Eficaz';
            } else if (total < 15) {
                valorAvaliacao = 2; // Eficaz
                statusAvaliacao = 'Eficaz';
            } else if (total === 15) {  // 5 + 5 + 5 para tr칡s respostas excelentes
                valorAvaliacao = 5; // Muito Eficaz
                statusAvaliacao = 'Muito Eficaz';
            } else {
                valorAvaliacao = 0; // Valor padr칚o caso nenhuma condi칞칚o seja atendida
                statusAvaliacao = 'Indeterminado'; // Mensagem padr칚o
            }

            // Atualiza o valor do campo de avalia칞칚o geral e o status no DOM
            if (avaliacaoGeralInput) {
                avaliacaoGeralInput.value = valorAvaliacao;
            }
            if (avaliacaoStatus) {
                avaliacaoStatus.textContent = statusAvaliacao;
            }

            console.log("Avalia칞칚o geral:", valorAvaliacao, "Status:", statusAvaliacao);
        }

        // Fun칞칚o para verificar o status do prazo
        function verificarPrazo() {
            const dataAvaliacao = document.getElementById('data_avaliacao').value;
            const periodoAvaliacao = parseInt(document.getElementById('periodo_avaliacao').value);
            const statusPrazoDiv = document.getElementById('status_prazo');

            if (dataAvaliacao && !isNaN(periodoAvaliacao)) {
                const dataAvaliacaoDate = new Date(dataAvaliacao);
                const dataLimite = new Date(dataAvaliacaoDate);
                dataLimite.setDate(dataLimite.getDate() + periodoAvaliacao);

                const hoje = new Date();
                let status = '';
                let cor = '';
                let emoji = '';

                if (hoje <= dataLimite) {
                    status = 'Dentro do Prazo';
                    cor = 'alert-success';
                    emoji = '游땎';
                } else {
                    status = 'Fora do Prazo';
                    cor = 'alert-danger';
                    emoji = '游땞';
                }

                statusPrazoDiv.className = `alert ${cor}`;
                statusPrazoDiv.textContent = `${status} ${emoji}`;
                console.log("Status do prazo:", status);
            } else {
                statusPrazoDiv.className = 'alert alert-secondary';
                statusPrazoDiv.textContent = 'Defina a data de avalia칞칚o e o per칤odo.';
            }
        }

       
        // Adiciona o evento de mudan칞a no funcion치rio para carregar os treinamentos
        const funcionarioSelect = document.getElementById('funcionario');
        const treinamentoSelect = document.getElementById('treinamento');

        if (funcionarioSelect && treinamentoSelect) {
            funcionarioSelect.addEventListener('change', function () {
                const funcionarioId = funcionarioSelect.value;
                console.log("Funcion치rio selecionado para treinamentos:", funcionarioId);

                treinamentoSelect.innerHTML = '<option selected>Selecione o treinamento</option>';

                if (funcionarioId) {
                    fetch(`/get-treinamentos/${funcionarioId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(treinamento => {
                                const option = document.createElement('option');
                                option.value = treinamento.id;

                                const [year, month, day] = treinamento.data_realizacao.split('-');
                                const formattedDate = `${day}/${month}/${year}`;

                                option.textContent = ` ${formattedDate} - ${treinamento.assunto}`;
                                treinamentoSelect.appendChild(option);
                            });
                            console.log("Treinamentos carregados para o funcion치rio:", data);
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                        });
                }
            });
        } else {
            console.error("Erro: Elementos 'funcionario' ou 'treinamento' n칚o encontrados no DOM.");
        }

        // Adiciona os eventos necess치rios
        document.querySelectorAll('input[type="radio"]').forEach(function (input) {
            input.addEventListener('change', calcularAvaliacaoGeral);
        });

        document.getElementById('data_avaliacao').addEventListener('change', verificarPrazo);
        document.getElementById('periodo_avaliacao').addEventListener('input', verificarPrazo);

        // Chamada inicial para verificar o status do prazo ao carregar a p치gina
        verificarPrazo();

        // Preenche os cargos ao carregar a p치gina
        for (let i = 1; i <= 3; i++) {
            preencherCargo(i);
        }
    });
</script>








{% endblock %}
