{% extends 'base.html' %}

{% block title %}Edição de Avaliação de Treinamentos{% endblock %}

{% block content %}
{% load custom_filters %}

<div class="container mt-5">
    <h2 class="text-center mb-4">Edição de Avaliação de Treinamentos</h2>

    <!-- Validação de Erros do Formulário -->
    {% if form.errors %}
    <div class="alert alert-danger">
        <strong>Erro!</strong> Por favor, corrija os seguintes erros:
        <ul>
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>
                        {{ field|capfirst }}: {{ error }}
                    </li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" action="{% url 'editar_avaliacao' avaliacao.id %}" class="row g-3">
        {% csrf_token %}

        <!-- Data da Avaliação -->
        <div class="col-md-6">
            <label for="data_avaliacao" class="form-label">Data da Avaliação:</label>
            <input type="date" class="form-control" id="data_avaliacao" name="data_avaliacao" value="{{ avaliacao.data_avaliacao|date:'Y-m-d' }}" required>
        </div>

        <!-- Período da Avaliação em Dias -->
        <div class="col-md-6">
            <label for="periodo_avaliacao" class="form-label">Período da Avaliação (em dias):</label>
            <input type="number" class="form-control" id="periodo_avaliacao" name="periodo_avaliacao" value="{{ avaliacao.periodo_avaliacao }}" required>
        </div>

        <!-- Nome do Funcionário -->
        <div class="col-md-6">
            <label for="funcionario" class="form-label">Funcionário:</label>
            <select class="form-select select2" id="funcionario" name="funcionario" required>
                <option value="">Selecione o funcionário</option>
                {% for funcionario in funcionarios %}
                    <option value="{{ funcionario.id }}" {% if funcionario.id == avaliacao.funcionario.id %}selected{% endif %}>{{ funcionario.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Treinamento/Curso -->
        <div class="col-md-6">
            <label for="treinamento" class="form-label">Treinamento/Curso:</label>
            <select class="form-select select2" id="treinamento" name="treinamento" required>
                <option value="">Selecione o treinamento</option>
                {% for treinamento in treinamentos %}
                    <option value="{{ treinamento.id }}" {% if treinamento.id == avaliacao.treinamento.id %}selected{% endif %}>{{ treinamento.assunto }}</option>
                {% endfor %}
            </select>
        </div>

          <!-- Responsáveis pela Avaliação -->
        <div class="col-12">
            <label class="form-label">Responsáveis pela Avaliação:</label>
        </div>

        <!-- Primeiro Responsável -->
        <div class="col-md-6">
            <label for="responsavel_1" class="form-label">Primeiro Responsável:</label>
            {{ form.responsavel_1 |add_class:"form-select select2"}}
        </div>

        <!-- Segundo Responsável -->
        <div class="col-md-6">
            <label for="responsavel_2" class="form-label">Segundo Responsável:</label>
            {{ form.responsavel_2 |add_class:"form-select select2"}}
        </div>

        <!-- Terceiro Responsável -->
        <div class="col-md-6">
            <label for="responsavel_3" class="form-label">Terceiro Responsável:</label>
            {{ form.responsavel_3 |add_class:"form-select select2"}}
        </div>

        <!-- Perguntas do Questionário -->
        <!-- Pergunta 1 -->
        <div class="col-12">
            <label class="form-label">I - Grau de conhecimento atual dos participantes da metodologia:</label>
            {% for valor, label in opcoes_conhecimento %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="pergunta_1" id="pergunta_1_{{ valor }}" value="{{ valor }}" {% if valor == avaliacao.pergunta_1 %}checked{% endif %} required>
                <label class="form-check-label" for="pergunta_1_{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

        <!-- Pergunta 2 -->
        <div class="col-12">
            <label class="form-label">II - Aplicação dos conceitos da metodologia:</label>
            {% for valor, label in opcoes_aplicacao %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="pergunta_2" id="pergunta_2_{{ valor }}" value="{{ valor }}" {% if valor == avaliacao.pergunta_2 %}checked{% endif %} required>
                <label class="form-check-label" for="pergunta_2_{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

        <!-- Pergunta 3 -->
        <div class="col-12">
            <label class="form-label">III - Resultados obtidos com a aplicação da metodologia:</label>
            {% for valor, label in opcoes_resultados %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="pergunta_3" id="pergunta_3_{{ valor }}" value="{{ valor }}" {% if valor == avaliacao.pergunta_3 %}checked{% endif %} required>
                <label class="form-check-label" for="pergunta_3_{{ valor }}">{{ valor }} - {{ label }}</label>
            </div>
            {% endfor %}
        </div>

       <!-- Descrição de Melhorias -->
            <div class="col-12">
                <label for="descricao_melhorias" class="form-label">Descreva as melhorias obtidas/resultados:</label>
                {{ form.descricao_melhorias }}
            </div>


        <!-- Campo oculto para Avaliação Geral -->
        <input type="hidden" name="avaliacao_geral" id="avaliacao_geral" value="{{ avaliacao.avaliacao_geral }}">
              <!-- Botões de ação centralizados com espaçamento -->
<div class="col-12 d-flex justify-content-center gap-3 mt-3">
    <!-- Botão de Salvar -->
    <button type="submit" class="btn btn-primary">
        <i class="bi bi-save"></i> Salvar Avaliação
    </button>

    <!-- Botão de Cancelar -->
    <a href="{% url 'lista_avaliacoes' %}" class="btn btn-secondary">
        <i class="bi bi-x-circle"></i> Cancelar
    </a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function preencherCargo(numero) {
            const responsavelSelect = document.getElementById(`responsavel_${numero}_nome`);
            const cargoInput = document.getElementById(`responsavel_${numero}_cargo`);
            responsavelSelect.addEventListener('change', function () {
                const selectedOption = responsavelSelect.options[responsavelSelect.selectedIndex];
                cargoInput.value = selectedOption.getAttribute('data-cargo');
            });
        }

        for (let i = 1; i <= 3; i++) preencherCargo(i);
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const funcionarioSelect = $('#funcionario'); // Select2 do funcionário
        const treinamentoSelect = $('#treinamento'); // Select2 do treinamento

        // Função para carregar os treinamentos do funcionário selecionado
        function carregarTreinamentos(funcionarioId, treinamentoSelecionado = null) {
            treinamentoSelect.html('<option value="">Selecione o treinamento</option>'); // Limpa as opções anteriores

            if (funcionarioId) {
                fetch(`/get-treinamentos/${funcionarioId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(treinamento => {
                            const option = new Option(
                                `${treinamento.data_realizacao} - ${treinamento.assunto}`,
                                treinamento.id,
                                treinamento.id === treinamentoSelecionado, // Se for igual ao selecionado, marque como selected
                                treinamento.id === treinamentoSelecionado
                            );
                            treinamentoSelect.append(option);
                        });
                    })
                    .catch(error => console.error('Erro ao carregar treinamentos:', error));
            }
        }

        // Carrega os treinamentos ao alterar o funcionário
        funcionarioSelect.on('select2:select', function (e) {
            const funcionarioId = e.params.data.id; // ID do funcionário selecionado
            carregarTreinamentos(funcionarioId);
        });

        // Carrega os treinamentos no carregamento da página (pré-selecionados)
        const funcionarioIdInicial = '{{ avaliacao.funcionario.id }}';
        const treinamentoSelecionado = '{{ avaliacao.treinamento.id }}';
        if (funcionarioIdInicial) {
            carregarTreinamentos(funcionarioIdInicial, treinamentoSelecionado);
        }
    });
</script>


{% endblock %}
