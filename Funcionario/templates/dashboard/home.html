{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard RH{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <!-- Cabeçalho da Página -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">
      <i class="bi bi-people text-primary me-2"></i> Dashboard de Recursos Humanos
    </h4>
  </div>

  <!-- 🔍 Indicadores Principais -->
  <div class="row g-4 mb-4">
    {% if perms.Funcionario.view_funcionario %}
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 text-center">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <i class="bi bi-people-fill fs-1 text-primary mb-3"></i>
          <h6 class="card-title">Total de Colaboradores</h6>
          <p class="fs-4 fw-bold">{{ total_colaboradores }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    {% if perms.Funcionario.view_avaliacaoanual %}
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 text-center">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <i class="bi bi-clipboard-check-fill fs-1 text-success mb-3"></i>
          <h6 class="card-title">Avaliações Pendentes</h6>
          <p class="fs-4 fw-bold">{{ avaliacoes_pendentes }}</p>
          {% if avaliacoes_pendentes > 0 %}
          <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#modalAvaliacoesPendentes">
            <i class="bi bi-eye-fill"></i> Ver detalhes
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 text-center">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <i class="bi bi-bar-chart-line-fill fs-1 text-info mb-3"></i>
          <h6 class="card-title">Avaliações por Desempenho</h6>
          <ul class="list-unstyled mb-0">
            <li><i class="bi bi-emoji-smile text-success me-1"></i> Ótimo: <strong>{{ classificacao_otimo }}</strong></li>
            <li><i class="bi bi-emoji-neutral text-primary me-1"></i> Bom: <strong>{{ classificacao_bom }}</strong></li>
            <li><i class="bi bi-emoji-expressionless text-warning me-1"></i> Regular: <strong>{{ classificacao_regular }}</strong></li>
            <li><i class="bi bi-emoji-frown text-danger me-1"></i> Ruim: <strong>{{ classificacao_ruim }}</strong></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 text-center">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <i class="bi bi-calendar-check-fill fs-1 text-warning mb-3"></i>
          <h6 class="card-title">Treinamentos Agendados</h6>
          <p class="fs-4 fw-bold">{{ treinamentos_agendados }}</p>
          {% if treinamentos_agendados > 0 %}
          <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#modalTreinamentos">
            <i class="bi bi-eye-fill"></i> Ver detalhes
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 🎂 Aniversariantes do Mês -->
  <div class="row mb-4">
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-light d-flex align-items-center gap-2">
          <i class="bi bi-calendar-event-fill text-primary"></i>
          <strong>Aniversariantes do Mês</strong>
        </div>
        <div class="card-body">
          {% if aniversariantes %}
          {% for aniversariante in aniversariantes %}
          <div class="d-flex align-items-center mb-3">
            {% if aniversariante.foto %}
            <img src="{{ aniversariante.foto.url }}" class="rounded-circle me-3" width="45" height="45" alt="{{ aniversariante.nome }}">
            {% else %}
            <i class="bi bi-person-circle fs-3 me-3"></i>
            {% endif %}
            <div>
              <strong>{{ aniversariante.nome }}</strong><br>
              <span class="text-muted small">{{ aniversariante.data_nascimento|date:"d/m" }}</span>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-muted text-center">Nenhum aniversariante este mês</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Últimos Comunicados -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-light d-flex align-items-center gap-2">
          <i class="bi bi-megaphone-fill text-primary"></i>
          <strong>Últimos Comunicados</strong>
        </div>
        <div class="card-body">
          {% if comunicados %}
          <ul class="list-group list-group-flush">
            {% for item in comunicados|slice:":3" %}
            <li class="list-group-item">
              <strong>{{ item.assunto }}</strong><br>
              <small class="text-muted">{{ item.data|date:"d/m/Y" }} - {{ item.departamento_responsavel }}</small><br>
              <button type="button" class="btn btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#modalGenerico" data-id="{{ item.id }}" data-titulo="{{ item.assunto }}">
                <i class="bi bi-eye"></i> Ver
              </button>
              <template id="conteudo-{{ item.id }}">{{ item.descricao|safe }}</template>
            </li>
            {% endfor %}
          </ul>
          <a href="{% url 'lista_comunicados' %}" class="btn btn-sm btn-outline-primary mt-3 float-end">Ver todos</a>
          {% else %}
          <p class="text-muted">Nenhum comunicado recente.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 👷 Avaliações Baixas -->
  <div class="row mb-4">
    <div class="col">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-light d-flex align-items-center gap-2">
          <i class="bi bi-exclamation-triangle-fill text-danger"></i>
          <strong>Colaboradores com Avaliação Baixa</strong>
        </div>
        <div class="card-body">
          {% if funcionarios_avaliacao_baixa %}
          <div class="row g-3">
            {% for item in funcionarios_avaliacao_baixa|slice:":4" %}
            <div class="col-md-6 d-flex align-items-center">
              {% if item.foto %}
              <img src="{{ item.foto }}" class="rounded-circle me-3" width="50" height="50" alt="{{ item.nome }}">
              {% else %}
              <i class="bi bi-person-circle fs-3 me-3"></i>
              {% endif %}
              <div>
                <strong>{{ item.nome }}</strong><br>
                <small>Classificação: {{ item.classificacao|floatformat:1 }}% - 
                  {% if item.status == 'Ruim' %}
                  <span class="text-danger">😕 Ruim</span>
                  {% elif item.status == 'Regular' %}
                  <span class="text-warning">😊 Regular</span>
                  {% elif item.status == 'Bom' %}
                  <span class="text-success">😃 Bom</span>
                  {% else %}
                  <span class="text-muted">🤔 Indefinido</span>
                  {% endif %}
                </small><br>
                <button class="btn btn-sm btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#modalGenerico" data-id="{{ item.id }}" data-titulo="Avaliação: {{ item.nome }}">
                  <i class="bi bi-eye"></i> Detalhes
                </button>
                <template id="conteudo-{{ item.id }}">
                  <p><strong>Classificação:</strong> {{ item.classificacao|floatformat:1 }}%</p>
                  <p><strong>Status:</strong> {{ item.status }}</p>
                  <a href="{% url 'visualizar_avaliacao_anual' item.id %}" class="btn btn-sm btn-outline-primary mt-2">Ver Completa</a>
                </template>
              </div>
            </div>
            {% endfor %}
          </div>
          <a href="{% url 'lista_avaliacoes' %}" class="btn btn-sm btn-outline-secondary mt-3 float-end">Ver todos</a>
          {% else %}
          <p class="text-muted">Nenhum colaborador em baixa.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal: Treinamentos Agendados -->
<div class="modal fade" id="modalTreinamentos" tabindex="-1" aria-labelledby="modalTreinamentosLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTreinamentosLabel">
          <i class="bi bi-journal-text me-2"></i> Treinamentos Agendados
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        {% if treinamentos %}
          <div class="list-group">
            {% for treinamento in treinamentos %}
              <div class="list-group-item">
                <h6 class="mb-1">
                  <i class="bi bi-mortarboard-fill me-1 text-primary"></i>
                  {{ treinamento.nome_curso }}
                </h6>
                <p class="mb-1 small text-muted">
                  <i class="bi bi-calendar-event me-1"></i>
                  {{ treinamento.data_inicio|date:"d/m/Y" }} até {{ treinamento.data_fim|date:"d/m/Y" }} |
                  <i class="bi bi-clock me-1"></i> {{ treinamento.carga_horaria }} horas
                </p>
                <strong>Participantes:</strong>
                {% if treinamento.funcionarios.all|length > 0 %}
                <ul class="mb-0 small ps-3">
                    {% for participante in treinamento.funcionarios.all %}
                      <li>{{ participante.nome }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="text-muted small">Nenhum participante registrado.</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted text-center mb-0">Nenhum treinamento agendado.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Avaliações Pendentes -->
<div class="modal fade" id="modalAvaliacoesPendentes" tabindex="-1" aria-labelledby="modalAvaliacoesPendentesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAvaliacoesPendentesLabel">
          <i class="bi bi-list-check me-2 text-warning"></i> Colaboradores com Avaliação Pendente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        {% if funcionarios_pendentes %}
          <ul class="list-group">
            {% for funcionario in funcionarios_pendentes %}
              <li class="list-group-item d-flex align-items-center">
                {% if funcionario.foto %}
                  <img src="{{ funcionario.foto.url }}" class="rounded-circle me-3" width="40" height="40" alt="{{ funcionario.nome }}">
                {% else %}
                  <i class="bi bi-person-circle fs-4 me-3"></i>
                {% endif %}
                <div>
                  <strong>{{ funcionario.nome }}</strong><br>
                  <span class="text-muted small">Cargo: {{ funcionario.cargo_atual }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted text-center mb-0">Nenhum colaborador com avaliação pendente.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Fechar
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
