{% extends "base.html" %}
{% load static %}

{% block title %}Relat√≥rio de Avalia√ß√£o Semestral{% endblock %}

{% block content %}
<!-- Formul√°rio (s√≥ na tela) -->
<form method="post" class="mb-4 d-print-none">
  {% csrf_token %}
  <div class="row g-3">
    <div class="col-md-2">{{ form.ano.label_tag }} {{ form.ano }}</div>
    <div class="col-md-3">{{ form.semestre.label_tag }} {{ form.semestre }}</div>
    <div class="col-md-5">{{ form.fornecedor.label_tag }} {{ form.fornecedor }}</div>
    <div class="col-md-2">{{ form.tipo.label_tag }} {{ form.tipo }}</div>
  </div>
  <div class="mt-3 d-flex justify-content-between">
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-search"></i> Gerar Relat√≥rio
    </button>
    <button type="button" onclick="imprimirRelatorio()" class="btn btn-secondary">
      <i class="fas fa-print"></i> Imprimir
    </button>
  </div>
</form>

<!-- Conte√∫do que ser√° impresso -->
<div id="relatorio-area">
  <!-- Cabe√ßalho institucional -->
  <table class="w-100 mb-3">
    <tr>
      <td style="width:20%">
        <img src="{% static 'logo.png' %}" alt="Logo" style="max-height:50px;">
      </td>
      <td style="text-align:center">
        <div style="font-weight:bold; font-size:12pt;">üìà {{ titulo }}</div>
      </td>
    </tr>
  </table>

  {% if exibir %}
    <hr>
    <!-- Dados principais -->
    <table class="table table-sm table-bordered w-100 mb-4" style="font-size:0.9rem">
      <tbody>
        <tr><th>Fornecedor</th><td>{{ fornecedor.nome }}</td></tr>
        <tr><th>Contato</th><td>{{ contato }}</td></tr>
        <tr><th>Meta</th><td>> 75%</td></tr>
        <tr><th>IQG (Nota)</th><td>{{ iqg|floatformat:2 }}%</td></tr>
        <tr><th>Status</th>
          <td>
            {% if classificacao == "A" %}
              <span style="color:green">‚úîÔ∏è A - Qualificado</span>
            {% elif classificacao == "B" %}
              <span style="color:orange">‚ö†Ô∏è B - Condicional</span>
            {% else %}
              <span style="color:red">‚ùå C - N√£o Qualificado</span>
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>

    <p class="mt-3"><span>‚ÑπÔ∏è</span> {{ mensagem }}</p>

    <!-- Verifica√ß√µes T√©cnicas (s√≥ tela) -->
    <div class="nao-imprimir mt-4">
      <h5 class="text-primary"><i class="fas fa-flask"></i> Verifica√ß√µes T√©cnicas</h5>
      <table class="table table-sm table-bordered text-center w-75 mb-4">
        <thead class="table-light">
          <tr>
            <th>IQF (%)</th><th>IP (%)</th><th>IQS</th>
            <th>IQF(50%)</th><th>IP(30%)</th><th>IQS(20%)</th>
            <th>IQG</th><th>Class.</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ iqf|floatformat:2 }}</td>
            <td>{{ ip|floatformat:2 }}</td>
            <td>{{ pontuacao|floatformat:0 }}</td>
            <td>{{ iqf_pond|floatformat:2 }}</td>
            <td>{{ ip_pond|floatformat:2 }}</td>
            <td>{{ iqs|floatformat:2 }}</td>
            <td><strong>{{ iqg|floatformat:2 }}</strong></td>
            <td><strong>{{ classificacao }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Gr√°fico IQG -->
    <!-- Gr√°fico IQG -->
<div class="grafico-iqg-wrapper mb-4 text-center">
  <h6 style="font-weight: bold; margin-bottom: 6px;">
    <span style="font-size: 1.6rem;">üöÄ</span> Indicador de Desempenho (IQG)
  </h6>
  <img
    src="data:image/png;base64,{{ grafico_base64 }}"
    alt="IQG"
    class="d-block mx-auto"
    style="max-width: 240px;"
  />
</div>
<style>
    @media print {
  .grafico-iqg-wrapper {
    text-align: center !important;
    margin: 10px auto;
    width: 100%;
  }
  .grafico-iqg-wrapper img {
    display: block !important;
    margin: 0 auto !important;
    max-width: 240px !important;
  }
}
</style>


   <!-- Classifica√ß√£o e A√ß√µes Recomendadas -->
<div style="font-size:8pt; border-top:1px solid #000; padding-top:6px; margin-top:12px;">
  <p style="font-weight:bold; font-size:9pt; margin-bottom:4px;">
    üìå Classifica√ß√£o e A√ß√µes Recomendadas
  </p>
  <ul style="margin-left:1rem; line-height:1.2; font-size:8pt;">
    <li>
      <strong style="color:#28a745;">A ‚Äì 75 ‚Äì 100 ‚Äì Qualificado:</strong>
      Continuar monitoramento.
    </li>
    <li>
      <strong style="color:#ffc107;">B ‚Äì 50 ‚Äì 74 ‚Äì Qualificado Condicionalmente:</strong>
      O fornecedor deve apresentar um Plano de A√ß√£o.
    </li>
    <li>
      <strong style="color:#df5353;">C ‚Äì 0 ‚Äì 49 ‚Äì N√£o Qualificado:</strong>
      Submeter √† aprova√ß√£o da Diretoria e apresentar Plano de A√ß√£o para continuidade.
    </li>
  </ul>
</div>

<!-- √çndices utilizados -->
<div style="font-size:8pt; border-top:1px solid #000; padding-top:6px; margin-top:12px;">
  <p style="font-weight:bold; font-size:9pt; margin-bottom:4px;">
    üìä √çndices utilizados
  </p>
  <ul style="margin-left:1rem; line-height:1.2; font-size:8pt;">
    <li>
      <strong>IQF:</strong> √çndice de Qualidade de Fornecimento (qualidade dos materiais e produtos entregues).
    </li>
    <li>
      <strong>IP:</strong> √çndice de Pontualidade (atrasos nas entregas).
    </li>
    <li>
      <strong>IQS:</strong> √çndice de Qualidade de Sistema (certificado de Sistema de Gest√£o da Qualidade).
    </li>
    <li>
      <strong>IQG (√çndice de Qualidade Geral) Mensal:</strong> 
      (0,50 √ó IQF) + (0,30 √ó IP) + (0,20 √ó IQS).
    </li>
  </ul>
</div>

<!-- Requisitos espec√≠ficos Bras-Mol -->
<p style="font-size:9pt; font-weight:bold; margin-top:12px;">
  üìã Requisitos espec√≠ficos Bras-Mol
</p>
<ul style="margin-left:1rem; line-height:1.2; font-size:8pt;">
  <li>
    <strong>M.Q.F:</strong> Manual da Qualidade para Fornecedores ‚Äì √∫ltima vers√£o.
  </li>
  <li>
    <strong>C.E.C:</strong> C√≥digo de √âtica e Conduta ‚Äì √∫ltima vers√£o.
  </li>
</ul>


<!-- Contatos -->
<div style="font-size:8pt; margin-top:12px;">
  <p style="font-weight:bold; font-size:9pt; margin-bottom:4px;">
    üìû D√∫vidas ou Questionamentos?
  </p>
  <ul style="margin-left:1rem; line-height:1.2; font-size:8pt;">
    <li>Anderson Goveia ‚Äì (11) 4648-2611 Ramal 137 ‚Äì anderson.goveia@brasmol.com.br</li>
    <li>Douglas Pereira ‚Äì (11) 4648-2611 Ramal 158 ‚Äì douglas.pereira@brasmol.com.br</li>
  </ul>
</div>


  {% endif %}
</div>

<script>
function imprimirRelatorio() {
  const conteudo = document.getElementById('relatorio-area').outerHTML;
  const rodapeHtml = `
    <div class="rodape-linha-final">
      <div class="rodape-flex">
        <span><strong>Sistema de Qualidade - Bras-Mol Molas e Estampados Ltda</strong></span>
        <span><strong>F228 ‚Äì Rev. 00</strong></span>
      </div>
    </div>`;
  const estilos = `
    <style>
      @page { size:A4 portrait; margin:12mm; }
      body { font-family:Arial,sans-serif; font-size:9pt; margin:0; padding:0; }
      .nao-imprimir, .d-print-none { display:none!important; }
      table { width:100%; border-collapse:collapse; }
      th,td { border:.3pt solid #888; padding:4px; text-align:center; }
      /* Aumenta o t√≠tulo do gr√°fico na impress√£o */
    .grafico-iqg-wrapper h6 {
      font-size: 0.9rem !important;
      margin-bottom: 8px !important;
      font-weight: bold !important;
    }
    .grafico-iqg-wrapper span {
      font-size: 1.2rem !important;
    }
      .rodape-linha-final {
        position: fixed; bottom:0; left:0; right:0;
        padding:4px 12mm 0; border-top:1px solid #000;
        background:#fff; z-index:9999;
      }
      .rodape-flex { display:flex; justify-content:space-between; font-size:7pt; }
    </style>`;
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">${estilos}</head><body>${conteudo}${rodapeHtml}</body></html>`);
  win.document.close();
  win.onload = () => { win.print(); win.close(); };
}
</script>
{% endblock %}
