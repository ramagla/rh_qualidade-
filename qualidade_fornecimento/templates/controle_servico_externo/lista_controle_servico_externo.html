{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Controle de Servi√ßo Externo{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
{% include "partials/global/_styles_componentes.html" %}

{% include "partials/global/_header_titulo.html" with titulo="Controle de Servi√ßo Externo" %}


 {% include "partials/global/_toast_mensagens.html" %}


 <div class="card mb-4">
  <div class="card-header">
    <i class="bi bi-funnel me-1" aria-hidden="true"></i> Filtros
  </div>
  <div class="card-body">
    <form method="get">
      <div class="row g-3">

        <div class="col-md-3">
          <label for="pedido" class="form-label">Pedido</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-receipt"></i></span>
            <input type="text" class="form-control" id="pedido" name="pedido" placeholder="Ex: 12345" value="{{ request.GET.pedido }}">
          </div>
        </div>

        <div class="col-md-3">
          <label for="codigo_bm" class="form-label">C√≥digo BM</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
            <input type="text" class="form-control" id="codigo_bm" name="codigo_bm" placeholder="Ex: BM001" value="{{ request.GET.codigo_bm }}">
          </div>
        </div>

        <div class="col-md-3">
          <label for="fornecedor" class="form-label">Fornecedor</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-truck"></i></span>
            <input type="text" class="form-control" id="fornecedor" name="fornecedor" placeholder="Ex: Fornecedor XYZ" value="{{ request.GET.fornecedor }}">
          </div>
        </div>

        <div class="col-md-3">
          <label for="status2" class="form-label">Status2</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-check-circle"></i></span>
            <select class="form-select" id="status2" name="status2">
              <option value="">-- Todos --</option>
              <option value="OK" {% if request.GET.status2 == "OK" %}selected{% endif %}>OK</option>
              <option value="Aten√ß√£o Saldo" {% if request.GET.status2 == "Aten√ß√£o Saldo" %}selected{% endif %}>Aten√ß√£o Saldo</option>
            </select>
          </div>
        </div>

     {% include "partials/global/_botao_filtrar.html" %}



      </div>
    </form>
  </div>
</div>


  <div class="d-flex flex-wrap justify-content-end align-items-end gap-2 mb-4">

  {% if request.user|has_permission:'qualidade_fornecimento.add_controleservicoexterno' %}
  <a href="{% url 'cadastrar_controle_servico_externo' %}" 
     class="btn btn-success d-inline-flex align-items-center" 
     aria-label="Cadastrar novo servi√ßo externo">
    <i class="bi bi-plus-circle me-2" aria-hidden="true"></i> Novo Servi√ßo Externo
  </a>
  {% endif %}

  {% if request.user|has_permission:'qualidade_fornecimento.add_relatorioinspecaoservico' %}
  <button type="button" 
          class="btn btn-primary d-inline-flex align-items-center" 
          data-bs-toggle="modal" 
          data-bs-target="#modalNovaInspecao" 
          aria-label="Cadastrar nova inspe√ß√£o de servi√ßo">
    <i class="bi bi-clipboard-check me-2" aria-hidden="true"></i> Nova Inspe√ß√£o
  </button>
  {% endif %}

</div>


<div class="modal fade" 
     id="modalNovaInspecao" 
     tabindex="-1" 
     aria-labelledby="modalNovaInspecaoLabel" 
     aria-modal="true" 
     aria-hidden="true" 
     role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalNovaInspecaoLabel">Selecionar Servi√ßo para Inspe√ß√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar modal"></button>
      </div>
      
      <div class="modal-body">
        <label for="servicoSelect" class="form-label">Selecione o Servi√ßo</label>
        <select id="servicoSelect" class="form-select select2" style="width:100%;">
          {% for servico in servicos_disponiveis %}
            <option value="{{ servico.id }}">
              Pedido {{ servico.pedido }} ‚Äì {{ servico.fornecedor.nome }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancelar sele√ß√£o">Cancelar</button>
        <button id="btnContinuarInspecao" class="btn btn-primary" onclick="continuarInspecao()" aria-label="Continuar para inspe√ß√£o">Continuar</button>
      </div>
      
    </div>
  </div>
</div>





 <div class="row mb-4">
  {% include "partials/global/_card_indicador.html" with titulo="Total Enviados" valor=total_enviados subtitulo="Pedidos registrados" cor="info" %}
  {% include "partials/global/_card_indicador.html" with titulo="Total OK" valor=total_ok subtitulo="Pedidos conclu√≠dos" cor="success" %}
  {% include "partials/global/_card_indicador.html" with titulo="Pendentes" valor=total_pendentes subtitulo="Pedidos com saldo" cor="danger" %}
  {% include "partials/global/_card_indicador.html" with titulo="Com Atraso" valor=total_atrasados subtitulo="Entregas atrasadas" cor="warning" %}
</div>




  {% if servicos_paginados %}
    <div class="table-responsive">
      <table class="table table-hover table-bordered text-center align-middle">
  <caption class="visually-hidden">Lista de Servi√ßos Externos Controlados</caption>
  <h5 class="mb-3">
  <i class="bi bi-table me-2 text-muted" aria-hidden="true"></i>
  üìÑ Lista de Servi√ßos
</h5>

  <thead class="table-light">
  <tr>
    <th class="py-2"><i class="bi bi-receipt me-1"></i> Pedido</th>
    <th class="py-2"><i class="bi bi-upc-scan me-1"></i> C√≥digo BM</th>
    <th class="py-2"><i class="bi bi-people-fill me-1"></i> Fornecedor</th>
    <th class="py-2"><i class="bi bi-truck me-1"></i> Entrega</th>
    <th class="py-2"><i class="bi bi-collection-fill me-1"></i> Total (kg/pe√ßas)</th>
    <th class="py-2"><i class="bi bi-check-circle-fill me-1"></i> Status</th>
    <th class="py-2"><i class="bi bi-clipboard-check me-1"></i> Status Inspe√ß√£o</th>
    <th class="py-2"><i class="bi bi-alarm me-1"></i> Atraso (dias)</th>
    <th class="py-2"><i class="bi bi-bar-chart-line me-1"></i> IP</th>
    <th class="py-2"><i class="bi bi-calendar-plus me-1"></i> Data Envio</th>
    <th class="py-2"><i class="bi bi-calendar-minus me-1"></i> Data Retorno</th>
    <th class="py-2"><i class="bi bi-gear-fill me-1"></i> A√ß√µes</th>
  </tr>
</thead>

        <tbody>
  {% for servico in servicos_paginados %}
    <tr>
      <td>{{ servico.pedido }}</td>
      <td>{{ servico.codigo_bm.codigo }}</td>
      <td>{{ servico.fornecedor.nome }}</td>
      <td>
        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEntrega{{ servico.id }}">
          <i class="bi bi-truck"></i>
        </button>
      </td>
      <td>{{ servico.quantidade_enviada|default:"-" }}</td>

      <td>
        {% if servico.status2 == "OK" %}
          <span class="badge bg-success">OK</span>
        {% elif servico.status2 == "Aten√ß√£o Saldo" %}
          <span class="badge bg-warning text-dark">Aten√ß√£o Saldo</span>
        {% else %}
          <span class="badge bg-secondary">-</span>
        {% endif %}
      </td>
        <td>
          {% if servico.inspecao %}
            {% if servico.inspecao.status_geral == "Aprovado" %}
              <span class="badge bg-success">Aprovado</span>
            {% elif servico.inspecao.status_geral == "Reprovado" %}
              <span class="badge bg-danger">Reprovado</span>
            {% elif servico.inspecao.status_geral == "Aprovado Condicionalmente" %}
<span class="badge badge-condicional">Aprovado Condicionalmente</span>
            {% else %}
              <span class="badge bg-secondary">-</span>
            {% endif %}
         {% else %}
  <span class="badge bg-secondary">Aguardando Inspe√ß√£o</span>
{% endif %}

        </td>
      <td>{{ servico.atraso_em_dias|default:"0" }}</td>
      <td>{{ servico.ip|default:"0" }}</td>
      <td>{{ servico.data_envio|date:"d/m/Y" }}</td>
      <td>{{ servico.data_retorno|date:"d/m/Y" }}</td>
     <td class="text-center align-middle">
  <div class="d-inline-flex flex-wrap justify-content-center gap-2">

    {% if request.user|has_permission:'qualidade_fornecimento.change_controleservicoexterno' %}
    <a href="{% url 'editar_controle_servico_externo' servico.id %}" 
       class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1" 
       data-bs-toggle="tooltip" 
       title="Editar pedido {{ servico.pedido }}" 
       aria-label="Editar pedido {{ servico.pedido }}">
      <i class="bi bi-pencil-square" aria-hidden="true"></i>
      <span class="visually-hidden">Editar pedido {{ servico.pedido }}</span>
    </a>
    {% endif %}

    {% if servico.inspecao and servico.inspecao.pdf %}
      <a href="{{ servico.inspecao.pdf.url }}" 
         target="_blank" 
         class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1" 
         data-bs-toggle="tooltip" 
         title="Visualizar PDF da inspe√ß√£o do pedido {{ servico.pedido }}" 
         aria-label="Visualizar PDF da inspe√ß√£o do pedido {{ servico.pedido }}">
        <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i>
        <span class="visually-hidden">Visualizar PDF do pedido {{ servico.pedido }}</span>
      </a>
    {% endif %}

    {% if request.user|has_permission:'qualidade_fornecimento.delete_controleservicoexterno' %}
    <button type="button" 
            class="btn btn-sm btn-danger d-inline-flex align-items-center gap-1" 
            data-bs-toggle="modal"
            data-bs-target="#modalExcluir{{ servico.id }}" 
            title="Excluir pedido {{ servico.pedido }}" 
            aria-label="Excluir pedido {{ servico.pedido }}">
      <i class="bi bi-trash" aria-hidden="true"></i>
      <span class="visually-hidden">Excluir pedido {{ servico.pedido }}</span>
    </button>

    {% include 'partials/global/_modal_exclusao.html' with objeto=servico url_excluir='excluir_controle_servico_externo' %}
    {% endif %}

  </div>
</td>


    </tr>

    {# Modal de Entregas para este servi√ßo #}
    <div class="modal fade" id="modalEntrega{{ servico.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              Entregas do Pedido {{ servico.pedido }} / NF {{ servico.nota_fiscal }}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
  {% if servico.retornos.all %}
    <ul class="list-unstyled mb-0">
      {% for retorno in servico.retornos.all %}
        <li>
          <strong>{{ retorno.data|date:"d/m/Y" }}</strong>: {{ retorno.quantidade|floatformat:2 }} kg/pe√ßas
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted mb-0">Nenhuma entrega registrada.</p>
  {% endif %}
</div>

          <div class="modal-footer">
            <a href="#" class="btn btn-outline-primary btn-sm">Visualizar Detalhes</a>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    

  {% endfor %}
</tbody>

      </table>
    </div>
  {% else %}
{% include "partials/global/_sem_resultados.html" %}
  {% endif %}

  {# Pagina√ß√£o #}
  
{% include "partials/global/_paginacao.html" with page_obj=servicos_paginados %}

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Inicializar select2
    $('#servicoSelect').select2({
      dropdownParent: $('#modalNovaInspecao'),
      width: '100%',
      allowClear: true,
      placeholder: 'Selecione...'
    });
  });

  function continuarInspecao() {
    const id = document.getElementById('servicoSelect').value;
    if (id) {
      const url = '{% url "cadastrar_inspecao_servico_externo" 0 %}'.replace('/0/', '/' + id + '/');
      window.location.href = url;
    } else {
      alert("Selecione um servi√ßo v√°lido!");
    }
  }
</script>

{% if request.session.inspecao_pending %}
<script>
(function pollInspecaoPDF(){
  fetch("{% url 'inspecao_status' request.session.inspecao_pending %}")
    .then(res => res.json())
    .then(data => {
      if (data.ready) {
        alert("PDF da Inspe√ß√£o de Servi√ßo Externo est√° pronto!\nClique aqui para baixar: " + data.url);
      } else {
        setTimeout(pollInspecaoPDF, 5000);
      }
    })
    .catch(console.error);
})();
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const botao = document.getElementById("btn-filtrar");
    const spinner = document.getElementById("spinner-filtrar");

    if (form && botao && spinner) {
      botao.disabled = false; // Ativa ap√≥s carregamento da p√°gina

      form.addEventListener("submit", function () {
        botao.disabled = true;
        spinner.classList.remove("d-none");
      });
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>


{% endif %}


{% endblock %}
