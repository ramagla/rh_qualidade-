{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}TB050 - Rela√ß√£o de Mat√©rias‚ÄëPrimas{% endblock %}

{% block content %}

{% include "partials/global/_header_titulo.html" with titulo="TB050 - Rela√ß√£o de Mat√©rias-Primas" %}


  {# ---------------- TOAST de Mensagens ---------------- #}
  {% if messages %}
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      {% for message in messages %}
        <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# ----------------- CARD de Filtros ------------------ #}
<div class="card mb-4">
  <div class="card-header">Filtros</div>
  <div class="card-body">
    <form method="get" class="row g-3">

      <div class="col-md-2">
        <label for="data_inicial" class="form-label">Data Inicial</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-date" aria-hidden="true"></i></span>
          <input type="date" class="form-control" id="data_inicial" name="data_inicial" value="{{ data_inicial|default_if_none:'' }}">
        </div>
      </div>

      <div class="col-md-2">
        <label for="data_final" class="form-label">Data Final</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-check" aria-hidden="true"></i></span>
          <input type="date" class="form-control" id="data_final" name="data_final" value="{{ data_final|default_if_none:'' }}">
        </div>
      </div>

      <div class="col-md-2">
        <label for="status" class="form-label">Status</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-check2-square" aria-hidden="true"></i></span>
          <select class="form-select" id="status" name="status">
            <option value="">-- Todos --</option>
            {% for st in filter_status %}
              <option value="{{ st }}" {% if status_filter == st %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="col-md-2">
  <label for="nro_rolo" class="form-label">N¬∫ Rolo</label>
  <div class="input-group">
    <span class="input-group-text"><i class="bi bi-upc-scan" aria-hidden="true"></i></span>
    <input type="text" class="form-control" id="nro_rolo" name="nro_rolo"
           placeholder="Ex: 12345" value="{{ request.GET.nro_rolo }}">
  </div>
</div>

<div class="col-md-2">
  <label for="nro_relatorio" class="form-label">N¬∫ Relat√≥rio</label>
  <div class="input-group">
    <span class="input-group-text"><i class="bi bi-file-earmark-text" aria-hidden="true"></i></span>
    <input type="text" class="form-control" id="nro_relatorio" name="nro_relatorio"
           placeholder="Ex: 2025-0001" value="{{ request.GET.nro_relatorio }}">
  </div>
</div>

<div class="col-md-2">
  <label for="nro_certificado" class="form-label">N¬∫ Certificado</label>
  <div class="input-group">
    <span class="input-group-text"><i class="bi bi-award" aria-hidden="true"></i></span>
    <input type="text" class="form-control" id="nro_certificado" name="nro_certificado"
           placeholder="Ex: CERT-1234" value="{{ request.GET.nro_certificado }}">
  </div>
</div>


      <div class="col-md-3">
  <label for="fornecedor" class="form-label">
    <i class="bi bi-truck me-1" aria-hidden="true"></i> Fornecedor
  </label>
  <select class="form-select select2" id="fornecedor" name="fornecedor">
    <option value="">-- Todos --</option>
    {% for forn in lista_fornecedores %}
      <option value="{{ forn.pk }}" {% if request.GET.fornecedor == forn.pk|stringformat:"s" %}selected{% endif %}>
        {{ forn.nome }}
      </option>
    {% endfor %}
  </select>
</div>

<div class="col-md-3">
  <label for="materia_prima" class="form-label">
    <i class="bi bi-boxes me-1" aria-hidden="true"></i> Mat√©ria‚ÄëPrima
  </label>
  <select class="form-select select2" id="materia_prima" name="materia_prima">
    <option value="">-- Todas --</option>
    {% for mp in lista_materiasprimas %}
      <option value="{{ mp.pk }}" {% if request.GET.materia_prima == mp.pk|stringformat:"s" %}selected{% endif %}>
        {{ mp.codigo }} - {{ mp.descricao }}
      </option>
    {% endfor %}
  </select>
</div>


      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" id="btnFiltrar" class="btn btn-primary w-100">
          <span id="spinnerFiltrar" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          Filtrar
        </button>
      </div>

    </form>
  </div>
</div>


  {# ----------------- Bot√µes de A√ß√£o ------------------- #}
<div class="d-flex justify-content-end mb-4 gap-2">

  {% if request.user|has_permission:'qualidade_fornecimento.importar_excel_tb050' %}
  <a href="{% url 'tb050_cadastrar' %}"
     class="btn btn-success d-inline-flex align-items-center"
     aria-label="Cadastrar nova rela√ß√£o de mat√©rias‚Äëprimas"
     data-bs-toggle="tooltip"
     title="Cadastrar nova rela√ß√£o de mat√©rias‚Äëprimas">
    <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
    <span>Novo</span>
  </a>

  <a href="{% url 'tb050_importar_excel' %}"
     class="btn btn-secondary d-inline-flex align-items-center"
     aria-label="Importar Excel"
     data-bs-toggle="tooltip"
     title="Importar dados a partir de planilha Excel">
    <i class="bi bi-file-earmark-excel me-1" aria-hidden="true"></i>
    <span>Importar Excel</span>
  </a>
  {% endif %}

  {% if request.user|has_permission:"qualidade_fornecimento.f045_status" %}
  <button type="button"
          class="btn btn-warning d-inline-flex align-items-center"
          data-bs-toggle="modal"
          data-bs-target="#modalF045"
          aria-label="Gerar relat√≥rio F045"
          title="Gerar relat√≥rio F045">
    <i class="bi bi-file-earmark-text me-1" aria-hidden="true"></i>
    <span>Gerar F045</span>
  </button>
  {% endif %}

</div>
<!-- Modal de Alerta para Norma N√£o Aprovada -->
<div class="modal fade" id="modalNormaNaoAprovada" tabindex="-1" aria-labelledby="modalNormaNaoAprovadaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalNormaNaoAprovadaLabel">
          <i class="bi bi-exclamation-triangle me-2"></i> Norma N√£o Aprovada
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body text-center">
    <p>üö´ A norma t√©cnica <strong id="nomeNormaNaoAprovada"></strong> vinculada a esta mat√©ria-prima ainda <strong>n√£o est√° aprovada</strong>.</p>
        <p class="mt-2">Entre em contato com o <strong>Departamento T√©cnico</strong> para verificar a aprova√ß√£o da norma.</p>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Fechar
        </button>
      </div>
    </div>
  </div>
</div>



  {# ---------------- Cards de Indicadores -------------- #}
  <div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-white bg-info card-status">
      <div class="card-header text-center">Total de Registros</div>
      <div class="card-body text-center">
        <h5 class="card-title">{{ total_registros }}</h5>
        <p class="card-text">Cadastrados no sistema.</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-success card-status">
      <div class="card-header text-center">Aprovados</div>
      <div class="card-body text-center">
        <h5 class="card-title">{{ total_aprovados }}</h5>
        <p class="card-text">Materiais aprovados.</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-danger card-status">
      <div class="card-header text-center">Reprovados</div>
      <div class="card-body text-center">
        <h5 class="card-title">{{ total_reprovados }}</h5>
        <p class="card-text">Materiais reprovados.</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-warning card-status">
      <div class="card-header text-center">Atrasados</div>
      <div class="card-body text-center">
        <h5 class="card-title">{{ total_atrasados }}</h5>
        <p class="card-text">Mat√©rias‚Äëprimas em atraso.</p>
      </div>
    </div>
  </div>
</div>


  {# --------------- TABELA de Resultados --------------- #}
  {% if materias_primas_paginadas %}
  <h5 class="mb-3">
  <i class="bi bi-table me-2 text-muted" aria-hidden="true"></i>
  üìÑ Lista de Materiais
</h5>

    <div class="table-responsive">
<table class="table table-bordered table-hover zebra-tabela text-center align-middle">
        <thead class="table-light">
  <tr>
    <th class="text-center align-middle">
      <i class="bi bi-file-earmark-text me-1 text-muted" aria-hidden="true"></i> Relat√≥rio
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-calendar-date me-1 text-muted" aria-hidden="true"></i> Data Entrada
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-truck me-1 text-muted" aria-hidden="true"></i> Fornecedor
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-boxes me-1 text-muted" aria-hidden="true"></i> Mat√©ria-Prima
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-award me-1 text-muted" aria-hidden="true"></i> N¬∫ Certificado
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-info-circle me-1 text-muted" aria-hidden="true"></i> Status
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-clock-history me-1 text-muted" aria-hidden="true"></i> Atraso (dias)
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-upc me-1 text-muted" aria-hidden="true"></i> Rolos
    </th>
    <th class="text-center align-middle">
      <i class="bi bi-gear-fill me-1 text-muted" aria-hidden="true"></i> A√ß√µes
    </th>
  </tr>
</thead>

        <tbody>
          {% for item in materias_primas_paginadas %}
            <tr>
              <td>{{ item.nro_relatorio }}</td>
              <td>{{ item.data_entrada|date:"d/m/Y" }}</td>
              <td>{{ item.fornecedor.nome }}</td>
              <td>{{ item.materia_prima.codigo }} - {{ item.materia_prima.descricao }}</td>
              <td>{{ item.numero_certificado|default:"-" }}</td>
              <td>
  {% if item.status == "Aprovado" %}
    <span class="badge bg-success text-white badge-status">
      <i class="bi bi-check-circle me-1" aria-hidden="true"></i>{{ item.status }}
    </span>
  {% elif item.status == "Reprovado" %}
    <span class="badge bg-danger text-white badge-status">
      <i class="bi bi-x-circle me-1" aria-hidden="true"></i>{{ item.status }}
    </span>
  {% elif item.status == "Aprovado Condicionalmente" %}
    <span class="badge bg-warning text-dark badge-status">
      <i class="bi bi-exclamation-triangle me-1" aria-hidden="true"></i>{{ item.status }}
    </span>
  {% elif item.status == "Aguardando F045" %}
    <span class="badge bg-secondary text-white badge-status">
      <i class="bi bi-hourglass-split me-1" aria-hidden="true"></i>{{ item.status }}
    </span>
  {% else %}
    <span class="text-muted">‚Äî</span>
  {% endif %}
</td>

<td>{{ item.atraso_em_dias|default:"0" }}</td>

{# -------- Coluna Rolos (modal) -------- #}
<td>
  {% if item.rolos.count > 0 %}
    <button class="btn btn-sm btn-info"
            data-bs-toggle="modal"
            data-bs-target="#modalRolos{{ item.pk }}"
            aria-label="Visualizar rolos">
      <i class="bi bi-eye"></i>
    </button>
  {% else %}
    <span class="text-muted">-</span>
  {% endif %}
</td>

{# --------------- A√á√ïES ---------------- #}
<td class="text-center align-middle">
  <div class="d-inline-flex flex-wrap justify-content-center gap-1">

    {% if request.user|has_permission:'qualidade_fornecimento.view_tb050' %}
    <a href="{% url 'tb050_visualizar' item.pk %}"
       class="btn btn-sm btn-secondary"
       data-bs-toggle="tooltip"
       title="Visualizar relat√≥rio"
       aria-label="Visualizar relat√≥rio">
      <i class="bi bi-eye" aria-hidden="true"></i>
    </a>
    {% endif %}

    {% if request.user|has_permission:'qualidade_fornecimento.change_tb050' %}
    <a href="{% url 'tb050_editar' item.pk %}"
       class="btn btn-sm btn-warning"
       data-bs-toggle="tooltip"
       title="Editar relat√≥rio"
       aria-label="Editar relat√≥rio">
      <i class="bi bi-pencil" aria-hidden="true"></i>
    </a>

    <a href="{% url 'tb050_selecionar_etiquetas' item.pk %}"
       class="btn btn-sm btn-info"
       data-bs-toggle="tooltip"
       title="Imprimir etiquetas"
       aria-label="Imprimir etiquetas">
      <i class="bi bi-printer" aria-hidden="true"></i>
    </a>
    {% endif %}

    {% if item.f045 and item.f045.pdf %}
    <a href="{{ item.f045.pdf.url }}" target="_blank"
       class="btn btn-sm btn-outline-primary"
       data-bs-toggle="tooltip"
       title="Visualizar F045 em PDF"
       aria-label="Visualizar F045 em PDF">
      <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i>
    </a>
    {% endif %}

    {% if item.anexo_certificado %}
    <a href="{{ item.anexo_certificado.url }}" target="_blank"
       class="btn btn-sm btn-outline-success"
       data-bs-toggle="tooltip"
       title="Download do certificado"
       aria-label="Download do certificado">
      <i class="bi bi-paperclip" aria-hidden="true"></i>
    </a>
    {% endif %}

    {% if request.user|has_permission:'qualidade_fornecimento.delete_tb050' %}
    <button type="button"
            class="btn btn-sm btn-danger"
            data-bs-toggle="modal"
            data-bs-target="#modalExcluir{{ item.pk }}"
            title="Excluir relat√≥rio"
            aria-label="Excluir relat√≥rio">
      <i class="bi bi-trash" aria-hidden="true"></i>
    </button>
    {% include 'partials/global/_modal_exclusao.html' with objeto=item url_excluir='tb050_excluir' %}

    {% endif %}

  </div>
</td>

</tr>



              </div>

            {# -------- Modal Rolos -------- #}
            <div class="modal fade" id="modalRolos{{ item.pk }}" tabindex="-1"
                 aria-labelledby="modalRolosLabel{{ item.pk }}" aria-hidden="true">
              <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalRolosLabel{{ item.pk }}">
                      Rolos do Relat√≥rio #{{ item.nro_relatorio }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    {% if item.rolos.all %}
                      <ul class="list-group">
                        {% for rolo in item.rolos.all %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            Rolo: <strong>{{ rolo.nro_rolo }}</strong>
                            <span class="badge bg-primary rounded-pill">
                              Peso: {{ rolo.peso }}¬†kg
                            </span>
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <p class="text-muted">N√£o h√° rolos cadastrados para este relat√≥rio.</p>
                    {% endif %}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
{% include 'partials/global/_sem_resultados.html' %}
  {% endif %}

  {# --------------- Pagina√ß√£o -------------------------- #}

  {% include "partials/global/_paginacao.html" with page_obj=materias_primas_paginadas %}

  
{# =============== MODAL ‚ÄúGerar F045‚Äù ================== #}
<div class="modal fade" id="modalF045" tabindex="-1" aria-labelledby="modalF045Label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning border-2 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="modalF045Label">
          <i class="bi bi-file-earmark-text-fill me-2"></i>
          Gerar Relat√≥rio F045
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <label for="relacaoSelect" class="form-label">Selecione o n¬∫ do Relat√≥rio</label>
        <select id="relacaoSelect" class="form-select select2" style="width:100%;">
          {% for rel in relacoes %}
            <option value="{{ rel.id }}">
              #{{ rel.nro_relatorio }} ‚Äì {{ rel.materia_prima.descricao|truncatechars:40 }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>
        <button id="btnContinuarF045" class="btn btn-primary" onclick="continuarGeracaoF045()">
          <i class="bi bi-check2-circle me-1"></i> Continuar
        </button>
      </div>
    </div>
  </div>
</div>


<style>
  .btn-hover-outline {
    background-color: white;
    color: inherit;
    border: 1px solid transparent;
    transition: all 0.2s ease-in-out;
  }

  .btn-hover-outline:hover {
    color: #fff !important;
    transform: scale(1.05);
  }

  .btn-outline-secondary.btn-hover-outline:hover {
    background-color: #6c757d;
    border-color: #6c757d;
  }

  .btn-outline-warning.btn-hover-outline:hover {
    background-color: #ffc107;
    border-color: #ffc107;
  }

  .btn-outline-info.btn-hover-outline:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
  }

  .btn-outline-danger.btn-hover-outline:hover {
    background-color: #dc3545;
    border-color: #dc3545;
  }

  .btn-outline-primary.btn-hover-outline:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }

  .btn-outline-success.btn-hover-outline:hover {
    background-color: #198754;
    border-color: #198754;
  }
  .card-status {
  opacity: 0.92;
  transition: all 0.3s ease-in-out;
}
.card-status:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  opacity: 1;
}
.badge-status {
  padding: 0.4rem 0.75rem !important;
  box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  font-weight: 500;
  border-radius: 0.5rem;
}
.zebra-tabela tbody tr:nth-child(odd) {
  background-color: #f9f9f9;
}
.zebra-tabela tbody tr:hover {
  background-color: #f1f1f1 !important;
  cursor: pointer;
}


</style>

<style>
  .modal-backdrop.show {
    z-index: 1049 !important; /* abaixo da nova modal */
  }

  #modalNormaNaoAprovada {
    z-index: 1065 !important; /* acima do modalF045 (1050) */
  }

  /* Garante que o dropdown do Select2 fique acima da modal */
.select2-container--open {
  z-index: 9999 !important;
}

.modal .select2-container--open {
  z-index: 1060 !important; /* acima da .modal-dialog (z-index: 1055) */
}

</style>


{# ------------ Select2 para campos + modal ------------ #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Carrega select2 para filtros
    $('#fornecedor, #materia_prima').select2({
      width: '100%',
      allowClear: true,
      placeholder: 'Selecione...'
    });

    // Select2 para a modal de gera√ß√£o F045
    $('#modalF045').on('shown.bs.modal', function () {
      $('#relacaoSelect').select2({
        dropdownParent: $('#modalF045'),
        width: '100%',
        allowClear: true,
        placeholder: 'Selecione...'
      });
    });

    // ENTER tamb√©m dispara continuar
    $(document).on('keypress', '#relacaoSelect', function (e) {
      if (e.which === 13) {
        e.preventDefault();
        document.getElementById('btnContinuarF045').click();
      }
    });

    // Se selecionar no select2, j√° continua
    $(document).on('select2:select', '#relacaoSelect', function () {
      document.getElementById('btnContinuarF045').click();
    });
  });

  function continuarGeracaoF045() {
  const id = document.getElementById('relacaoSelect').value;

  if (!id) {
    alert("Selecione um relat√≥rio v√°lido!");
    return;
  }

  fetch(`/qualidade/norma-aprovada/${id}/`)
    .then(response => response.json())
    .then(data => {
  if (data.aprovada === true) {
    const url = '{% url "tb050_f045" 0 %}'.replace('/0/', '/' + id + '/');
    window.location.href = url;
  } else {
    const nomeSpan = document.getElementById('nomeNormaNaoAprovada');
    nomeSpan.textContent = data.nome || "(Norma n√£o identificada)";

    const modal = new bootstrap.Modal(document.getElementById('modalNormaNaoAprovada'));
    modal.show();
  }
})

    .catch(error => {
      console.error("Erro ao verificar norma:", error);
      alert("Erro ao validar a norma. Entre em contato com o departamento t√©cnico.");
    });
}

</script>


{% if f045_pending %}
<!-- Modal de Sucesso F045 -->
<div class="modal fade" id="modalSucessoF045" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-success shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle-fill me-2"></i> PDF Gerado com Sucesso!
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body text-center">
        <p>O relat√≥rio F045 foi gerado com sucesso.</p>
        <p class="small text-muted">Clique abaixo para baixar o PDF:</p>
        <a id="linkDownloadF045" href="#" class="btn btn-outline-primary" target="_blank">
          <i class="bi bi-file-earmark-pdf me-1"></i> Baixar PDF
        </a>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-success" onclick="location.reload();">
          <i class="bi bi-check2-circle me-1"></i> OK
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function pollF045(){
  fetch("{% url 'f045_status' f045_pending %}")
    .then(res => res.json())
    .then(data => {
      if (data.ready) {
        document.getElementById('linkDownloadF045').href = data.url;
        const modal = new bootstrap.Modal(document.getElementById('modalSucessoF045'));
        modal.show();
      } else {
        setTimeout(pollF045, 5000);
      }
    })
    .catch(console.error);
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const formFiltrar = document.getElementById('btnFiltrar').closest('form');
  const btnFiltrar = document.getElementById('btnFiltrar');
  const spinnerFiltrar = document.getElementById('spinnerFiltrar');

  formFiltrar.addEventListener('submit', function (e) {
    btnFiltrar.disabled = true;
    spinnerFiltrar.classList.remove('d-none');

    const formAction = formFiltrar.getAttribute('action') || window.location.href;
    const formData = new FormData(formFiltrar);

    fetch(formAction + '?' + new URLSearchParams(formData), {
      method: 'GET'
    })
    .then(response => {
      if (!response.ok) throw new Error('Erro na resposta do servidor');
      return response.text();
    })
    .then(html => {
      document.documentElement.innerHTML = html;
    })
    .catch(error => {
      console.error(error);
      btnFiltrar.disabled = false;
      spinnerFiltrar.classList.add('d-none');
      alert("Erro ao tentar filtrar. Verifique sua conex√£o ou tente novamente.");
    });

    e.preventDefault();
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (el) {
    new bootstrap.Tooltip(el);
  });
});
</script>
{% endif %}




{% endblock %}
