{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard da Qualidade{% endblock %}

{% block content %}
{% include 'partials/global/_styles_componentes.html' %}

<style>
  .welcome-banner{
    border-radius:12px;
    background:linear-gradient(90deg,#0d6efd 0%,#0dcaf0 100%);
    color:#fff; padding:1.25rem 1.5rem; margin-bottom:1.5rem;
    box-shadow:0 .5rem 1rem rgba(0,0,0,.08);
  }
  .kpi-card{ border:none; border-radius:14px; background:#f8fafc;
    transition:transform .2s ease, box-shadow .2s ease; }
  .kpi-card:hover{ transform:translateY(-3px); box-shadow:0 6px 22px rgba(0,0,0,.08); }
  .kpi-value{ font-size:2rem; font-weight:800; }
  .table-card{ border-radius:12px; overflow:hidden; }
  .table thead th{ white-space:nowrap; }
  .acessos-rapidos .card{ border:0; border-radius:14px; background:#f8fafc; }
  .acessos-rapidos .card:hover{ transform:translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,.08); }
  .icon-badge{ width:48px; height:48px; display:inline-flex; align-items:center; justify-content:center;
    border-radius:12px; background:#e9f2ff; font-size:1.4rem; }
</style>

<div class="container mt-4">

  <!-- Banner no padr√£o Metrologia -->
  <div class="welcome-banner d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <i class="bi bi-clipboard-data fs-1"></i>
      <div>
        <h5 class="mb-0">Bem-vindo ao Painel de Qualidade de Fornecimento</h5>
        <small class="opacity-75">Acompanhe os principais indicadores dos Relat√≥rios F045 e Inspe√ß√µes de Servi√ßo Externo.</small>
      </div>
    </div>

    <!-- Bot√µes r√°pidos (atalhos) -->
    <div class="d-flex align-items-center gap-2">
      <a href="{% url 'relatorio_avaliacao' %}" class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2 rounded-pill shadow-sm">
        <i class="bi bi-graph-up fs-5"></i><span>Relat√≥rio de Avalia√ß√£o</span>
      </a>
      <a href="{% url 'relatorio_tb001' %}" class="btn btn-info d-flex align-items-center gap-2 px-3 py-2 rounded-pill shadow-sm text-white">
        <i class="bi bi-kanban fs-5"></i><span>TB001</span>
      </a>
      <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFiltros">
        <i class="bi bi-sliders"></i> Filtros
      </button>
    </div>
  </div>

  <!-- KPIs principais (mesmo estilo do painel de Metrologia) -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Relat√≥rios F045</div>
            <div class="kpi-value text-dark">{{ kpi_f045_total|default:0 }}</div>
          </div>
          <i class="bi bi-file-earmark-bar-graph fs-1 text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Servi√ßo Externo</div>
            <div class="kpi-value text-success">{{ kpi_servico_total|default:0 }}</div>
          </div>
          <i class="bi bi-tools fs-1 text-success"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">IQG Semestral</div>
            <div class="kpi-value text-warning">{{ kpi_iqg|default:0|stringformat:"d" }}<small class="ms-1">%</small></div>
          </div>
          <i class="bi bi-speedometer2 fs-1 text-warning"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">IQF/IP Semestral</div>
            <div class="kpi-value text-secondary">
              {{ kpi_iqf|default:0|stringformat:"d" }} / {{ kpi_ip|default:0|stringformat:"d" }}<small class="ms-1">%</small>
            </div>
          </div>
          <i class="bi bi-check2-circle fs-1 text-secondary"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr√°fico IQG -->
  <div class="row my-4">
    <div class="col text-center">
      <h5 class="mb-3">üöÄ Indicador de Desempenho (IQG)</h5>
      <img src="data:image/png;base64,{{ grafico_velocimetro }}" alt="Gr√°fico de desempenho IQG"
           class="img-fluid d-block mx-auto" style="max-width:400px;">
    </div>
  </div>

  <!-- Listagens em cards (tabelas com mesmo acabamento) -->
  <div class="row g-4">
    <div class="col-xl-6">
      <div class="card table-card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-file-earmark-text"></i> √öltimos Relat√≥rios F045</strong>
          <small class="text-muted">Hoje: {{ today|date:"d/m/Y" }}</small>
        </div>
        <div class="card-body p-0">
          {% if ultimos_relatorios %}
            <div class="table-responsive" style="max-height:300px; overflow:auto;">
              <table class="table table-hover table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>N¬∫</th><th>Fornecedor</th><th>Status</th><th>Data</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for rel in ultimos_relatorios %}
                    <tr>
                      <td>{{ rel.nro_relatorio }}</td>
                      <td>{{ rel.fornecedor }}</td>
                      <td>
                        {% if rel.status == "Aprovado" %}
                          <span class="badge bg-success">Aprovado</span>
                        {% elif rel.status == "Reprovado" %}
                          <span class="badge bg-danger">Reprovado</span>
                        {% elif rel.status == "Aprovado Condicionalmente" %}
                          <span class="badge bg-warning text-dark">Condicional</span>
                        {% elif rel.status == "Aguardando F045" %}
                          <span class="badge bg-secondary">Aguardando F045</span>
                        {% else %}
                          <span class="badge bg-secondary">{{ rel.status }}</span>
                        {% endif %}
                      </td>
                      <td>{{ rel.assinado_em|date:"d/m/Y" }}</td>
                      <td>
                        {% if rel.status == "Aprovado" %}
                          <a href="{% url 'visualizar_f045' rel.id %}" class="btn btn-sm btn-outline-primary mt-1" target="_blank" title="Visualizar F045" aria-label="Visualizar F045">
                            <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i>
                          </a>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            {% include 'partials/global/_sem_resultados.html' with item_nome="relat√≥rio F045" %}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-xl-6">
      <div class="card table-card shadow-sm">
        <div class="card-header bg-light">
          <strong><i class="bi bi-tools"></i> √öltimas Inspe√ß√µes Servi√ßo Externo</strong>
        </div>
        <div class="card-body p-0">
          {% if ultimas_inspecoes %}
            <div class="table-responsive" style="max-height:300px; overflow:auto;">
              <table class="table table-hover table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Pedido</th><th>Fornecedor</th><th>Status</th><th>Data</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for inspecao in ultimas_inspecoes %}
                    <tr>
                      <td>{{ inspecao.servico.pedido }}</td>
                      <td>{{ inspecao.servico.fornecedor }}</td>
                      <td>
                        {% if inspecao.status_geral == "Aprovado" %}<span class="badge bg-success">Aprovado</span>
                        {% elif inspecao.status_geral == "Reprovado" %}<span class="badge bg-danger">Reprovado</span>
                        {% elif inspecao.status_geral == "Aprovado Condicionalmente" %}<span class="badge bg-warning text-dark">Condicional</span>
                        {% else %}<span class="badge bg-secondary">{{ inspecao.status_geral }}</span>{% endif %}
                      </td>
                      <td>{{ inspecao.criado_em|date:"d/m/Y" }}</td>
                      <td>
                        {% if inspecao.status_geral == "Aprovado" %}
                          <a href="{% url 'visualizar_inspecao_servico_externo' inspecao.id %}" class="btn btn-sm btn-outline-primary mt-1" target="_blank" title="Visualizar inspe√ß√£o" aria-label="Visualizar inspe√ß√£o">
                            <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i>
                          </a>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            {% include 'partials/global/_sem_resultados.html' with item_nome="inspe√ß√£o" %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Offcanvas de Filtros para manter o mesmo padr√£o dos dashboards -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFiltros" aria-labelledby="offcanvasFiltrosLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasFiltrosLabel"><i class="bi bi-sliders"></i> Filtros</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get">
      <div class="mb-3">
        <label class="form-label">Per√≠odo (M√™s/Ano)</label>
        <input type="month" name="periodo" class="form-control" value="{{ request.GET.periodo }}">
      </div>
      <div class="d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel"></i> Aplicar filtros
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
