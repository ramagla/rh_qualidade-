{# templates/estoque_intermediario/list_em_fabrica.html ‚Äî PARA #}
{% extends "base.html" %}

{% block title %}Estoque Intermedi√°rio ‚Äî Em F√°brica{% endblock %}

{% block content %}
{% load static %}
{% load custom_filters %}

{# === mesmos includes do padr√£o do sistema === #}
{% include "partials/global/_styles_componentes.html" %}
{% include "partials/global/_estilos_botoes_acoes.html" %}
{% include "partials/global/_toast_mensagens.html" %}

<div class="container-fluid mt-5">

  {# Header padronizado #}
  {% include "partials/global/_header_titulo.html" with titulo="Estoque Intermedi√°rio ‚Äî Em F√°brica" icone="bi bi-box-seam" emoji="üè≠" %}

  {# Barra de a√ß√µes com os mesmos componentes #}
  <div class="d-flex justify-content-end flex-wrap gap-2 mb-4">
    {% include "partials/global/_botao_filtros_offcanvas.html" %}

    {% if request.user|has_permission:"qualidade_fornecimento.add_estoqueintermediario" %}
      <a href="{% url 'ei_create' %}" class="btn btn-cadastrar-personalizado d-inline-flex align-items-center">
        <i class="bi bi-plus-circle-fill me-2" aria-hidden="true"></i> Novo Envio
      </a>
    {% endif %}

    {% if request.user|has_permission:"qualidade_fornecimento.view_estoqueintermediario" %}
      <a href="{% url 'ei_list_historico' %}" class="btn btn-info btn-acao-personalizado d-inline-flex align-items-center">
        <i class="bi bi-clock-history me-2" aria-hidden="true"></i> Hist√≥rico
      </a>
    {% endif %}
  </div>

  {# KPIs no mesmo design dos cards de indicador #}
  <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
    {% include "partials/global/_card_indicador.html" with cor="primary" titulo="Itens em F√°brica" valor=kpis.total subtitulo="" icone="bi-box-seam" %}
    {% include "partials/global/_card_indicador.html" with cor="warning" titulo="Acima de 10 dias" valor=kpis.acima_20dias subtitulo="" icone="bi-hourglass-split" %}
    {% include "partials/global/_card_indicador.html" with cor="info" titulo="Dias M√©dios" valor=kpis.media_dias subtitulo="" icone="bi-speedometer2" %}
  </div>

  {# Lista (tabela) #}
  <h5 class="mb-3">
    <i class="bi bi-table me-2 text-muted" aria-hidden="true"></i>
    üì¶ Itens em F√°brica
  </h5>

  <div class="table-responsive zebra-tabela mt-4">
  <table class="table table-bordered table-striped align-middle text-center">
    <caption class="visually-hidden">Tabela de Itens em F√°brica</caption>
    <thead class="table-light">
      <tr>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-hash mb-1" aria-hidden="true"></i>
            <small>OP</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-tag mb-1" aria-hidden="true"></i>
            <small>Mat√©ria-prima</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-layers mb-1" aria-hidden="true"></i>
            <small>Lotes</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-graph-up mb-1" aria-hidden="true"></i>
            <small>Previs√£o (kg +5%)</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-arrow-up-right-square mb-1" aria-hidden="true"></i>
            <small>Enviado (kg)</small>
          </div>
        </th>
        {# >>> NOVA COLUNA: SALDO = enviado - previsto_kg <<< #}
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-calculator mb-1" aria-hidden="true"></i>
            <small>Saldo (kg)</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-calendar2-week mb-1" aria-hidden="true"></i>
            <small>Data envio</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-stopwatch mb-1" aria-hidden="true"></i>
            <small>Dias</small>
          </div>
        </th>
        <th class="align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-gear mb-1" aria-hidden="true"></i>
            <small>A√ß√µes</small>
          </div>
        </th>
      </tr>
    </thead>

    <tbody>
      {% for i in page_obj %}
      <tr>
        <td class="text-start fw-semibold">{{ i.op }}</td>
        <td>{{ i.materia_prima }}</td>
        <td>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            data-bs-toggle="modal"
            data-bs-target="#modalLotes{{ i.pk }}"
            title="{{ i.itens.count }} lote{% if i.itens.count != 1 %}s{% endif %}">
            <i class="bi bi-eye"></i>
          </button>
        </td>

        {# Previs√£o (kg +5%) via property do modelo #}
        <td>{{ i.previsto_kg|floatformat:3 }}</td>

        <td>{{ i.enviado|floatformat:3 }}</td>

        {# SALDO = Enviado - Previsto (kg +5%) via property do modelo #}
        <td>
          {% with saldo=i.saldo_kg %}
            <span class="{% if saldo < 0 %}text-danger{% elif saldo > 0 %}text-success{% else %}text-muted{% endif %}">
              {{ saldo|floatformat:3 }}
            </span>
          {% endwith %}
        </td>

        <td>
          {% if i.data_envio %}
            {{ i.data_envio|date:"d/m/Y H:i" }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>

        {# Dias com alerta visual #}
        <td>
          {% with dias=i.dias_em_fabrica %}
            {% if dias > 10 %}
              <span class="badge bg-danger d-inline-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ dias }}
              </span>
            {% elif dias > 5 %}
              <span class="badge bg-warning text-dark d-inline-flex align-items-center">
                <i class="bi bi-exclamation-circle me-1"></i>{{ dias }}
              </span>
            {% else %}
              <span class="badge bg-success d-inline-flex align-items-center">
                <i class="bi bi-check2-circle me-1"></i>{{ dias }}
              </span>
            {% endif %}
          {% endwith %}
        </td>

        <td>
          <div class="d-inline-flex flex-wrap gap-1 justify-content-center">
            {% if request.user|has_permission:"qualidade_fornecimento.change_estoqueintermediario" %}
              {% include "partials/global/_botao_editar.html" with url_editar="ei_update" objeto=i label="envio" %}
            {% endif %}

            {% if request.user|has_permission:"qualidade_fornecimento.change_estoqueintermediario" %}
              {% include "partials/global/_botao_visualizar.html" with url_visualizar="ei_retorno" objeto=i label="retorno" icone="bi bi-arrow-return-left" %}
            {% endif %}
          </div>
        </td>

      </tr>
      {% empty %}
        {% include "partials/global/_sem_resultados.html" with colspan=9 mensagem="Nenhum item em f√°brica." %}
      {% endfor %}
    </tbody>
  </table>

  {# Pagina√ß√£o padr√£o #}
  {% include "partials/global/_paginacao.html" %}
</div>


  {# ===== Modais de LOTES ‚Äî completa, com alinhamento vertical e t√≠tulo destacado ===== #}
{% for i in page_obj %}
<div class="modal fade" id="modalLotes{{ i.pk }}" tabindex="-1" aria-labelledby="modalLotesLabel{{ i.pk }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-box-seam fs-5 text-primary"></i>
          <h5 class="modal-title mb-0" id="modalLotesLabel{{ i.pk }}">
            <span class="me-1  text-center fw-semibold">OP</span>
            <span class="badge bg-primary">{{ i.op }}</span>
          </h5>
        </div>

        <div class="d-flex flex-wrap gap-2 ms-3">
          <span class="badge bg-light text-dark d-inline-flex align-items-center">
            <i class="bi bi-tag me-1"></i> {{ i.materia_prima }}
          </span>
          <span class="badge bg-light text-dark d-inline-flex align-items-center">
            <i class="bi bi-layers me-1"></i> {{ i.itens.count }} lote{% if i.itens.count != 1 %}s{% endif %}
          </span>
          <span class="badge bg-info text-dark d-inline-flex align-items-center">
            <i class="bi bi-graph-up me-1"></i> Prev. {{ i.previsto_kg|floatformat:3 }} kg
          </span>
          <span class="badge bg-secondary d-inline-flex align-items-center">
            <i class="bi bi-box-arrow-in-right me-1"></i> Env. {{ i.enviado|floatformat:3 }} kg
          </span>
        </div>

        <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="table-responsive zebra-tabela">
          <table class="table table-sm table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr class="text-center align-middle">
                <th class="align-middle" style="width:35%;">
                  <i class="bi bi-upc-scan me-1"></i> Lote / Rolo
                </th>
                <th class="align-middle" style="width:45%;">
                  <i class="bi bi-truck me-1"></i> Fornecedor
                </th>
                <th class="text-end align-middle" style="width:20%;">
                  <i class="bi bi-box-arrow-in-right me-1"></i> Enviado (kg)
                </th>
              </tr>
            </thead>

            <tbody>
              {% for it in i.itens.all %}
              <tr class="align-middle">
                <td class="text-center align-middle">
                  <span class="d-inline-flex align-items-center">
                    <i class="bi bi-upc-scan text-muted me-1"></i>
                    {{ it.lote.nro_rolo|default:it.lote }}
                  </span>
                </td>
                <td class="text-center align-middle">
                  <span class="d-inline-flex align-items-center">
                    <i class="bi bi-truck text-muted me-1"></i>
                    {% if it.tb050 and it.tb050.fornecedor %}
                      {{ it.tb050.fornecedor }}
                    {% elif it.lote and it.lote.tb050 and it.lote.tb050.fornecedor %}
                      {{ it.lote.tb050.fornecedor }}
                    {% elif it.lote and it.lote.fornecedor %}
                      {{ it.lote.fornecedor }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </span>
                </td>
                <td class="text-center align-middle">
                  <span class="d-inline-flex align-items-center justify-content-center w-100">
                    <i class="bi bi-weight text-muted me-1"></i>
                    {{ it.enviado|floatformat:3 }}
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr class="align-middle">
                <td colspan="3" class="text-center text-muted">
                  <i class="bi bi-info-circle me-1"></i> Sem lotes.
                </td>
              </tr>
              {% endfor %}
            </tbody>

            <tfoot class="table-light">
              <tr class="align-middle">
                <th colspan="2" class="text-end align-middle">
                  <span class="d-inline-flex align-items-center">
                    <i class="bi bi-sum me-1"></i> Total enviado:
                  </span>
                </th>
                <th class="text-center align-middle">
                  <span class="fw-semibold">{{ i.enviado|floatformat:3 }}</span>
                </th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Fechar
        </button>
      </div>

    </div>
  </div>
</div>
{% endfor %}


  {# ===== Offcanvas de Filtros no mesmo padr√£o ===== #}
  <div class="offcanvas offcanvas-end offcanvas-modern" tabindex="-1" id="filtrosOffcanvas" aria-labelledby="filtrosOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="filtrosOffcanvasLabel">
        <i class="bi bi-funnel-fill me-2"></i>Filtros de Estoque Intermedi√°rio
      </h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>

    <div class="offcanvas-body">
      <form method="get" class="row g-3">

        <div class="col-12 filtro-wrapper">
          <label for="f_op"><i class="bi bi-hash me-1"></i> OP</label>
          <input id="f_op" type="text" name="op" value="{{ request.GET.op }}" class="form-control" placeholder="Ex.: 24-000123">
        </div>

        <div class="col-12 filtro-wrapper">
          <label for="f_mp"><i class="bi bi-tag me-1"></i> Mat√©ria-prima</label>
          <select id="f_mp" name="mp" class="form-select select2" data-dropdown_parent="#filtrosOffcanvas" data-dropdown-parent="#filtrosOffcanvas">
            <option value="">Todas</option>
            {% for m in materias_primas %}
              <option value="{{ m.id }}" {% if request.GET.mp == m.id|stringformat:"s" %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 filtro-wrapper">
          <label for="f_de"><i class="bi bi-calendar-date me-1"></i> De (envio)</label>
          <input id="f_de" type="date" name="de" value="{{ request.GET.de }}" class="form-control">
        </div>

        <div class="col-6 filtro-wrapper">
          <label for="f_ate"><i class="bi bi-calendar-date me-1"></i> At√© (envio)</label>
          <input id="f_ate" type="date" name="ate" value="{{ request.GET.ate }}" class="form-control">
        </div>

        <div class="col-12 filtro-wrapper">
          <label for="f_acima"><i class="bi bi-hourglass-split me-1"></i> Acima de N dias</label>
          <input id="f_acima" type="number" min="1" step="1" name="acima_dias" value="{{ request.GET.acima_dias }}" class="form-control" placeholder="Ex.: 10">
        </div>

        <div class="col-12 mt-3">
          {% include "partials/global/_botao_filtrar.html" %}
        </div>
      </form>
    </div>
  </div>

</div> {# /container-fluid #}

{# Inicializa√ß√£o Select2 (segue padr√£o do seu projeto) #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window.jQuery && jQuery.fn.select2) {
      $('.select2').select2({
        placeholder: "Selecione uma op√ß√£o",
        allowClear: true,
        width: '100%'
      });
    }
  });
</script>
{% endblock %}
