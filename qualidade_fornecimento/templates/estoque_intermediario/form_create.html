{# templates/estoque_intermediario/form_create.html ‚Äî PARA #}
{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Novo Envio ‚Äî Estoque Intermedi√°rio{% endblock %}

{% block content %}
{% include "partials/global/_styles_componentes.html" %}
{% include "partials/global/_estilos_botoes_acoes.html" %}
{% include "partials/global/_toast_mensagens.html" %}

<div class="container-fluid mt-5">

  {# Cabe√ßalho padronizado com √≠cone/emoji #}
  {% include "partials/global/_header_titulo.html" with titulo="Novo Envio ‚Äî Estoque Intermedi√°rio" icone="bi bi-send-check" emoji="üì§" %}

  {# Barra de a√ß√µes #}
  <div class="d-flex justify-content-end flex-wrap gap-2 mb-4">
    <a href="{% url 'ei_list_em_fabrica' %}"
       class="btn btn-outline-secondary btn-acao-personalizado d-inline-flex align-items-center">
      <i class="bi bi-arrow-left-circle me-2" aria-hidden="true"></i> Voltar
    </a>
  </div>

  <form method="post" enctype="multipart/form-data" id="eiForm">
    {% csrf_token %}
 {% if form.non_field_errors %}
    <div class="alert alert-danger mb-3">
      {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
    </div>
  {% endif %}
  {% if formset.non_form_errors %}
    <div class="alert alert-danger mb-3">
      {% for e in formset.non_form_errors %}<div>{{ e }}</div>{% endfor %}
    </div>
  {% endif %}
    <div class="card shadow-sm">
      <div class="card-body">

        <div class="accordion" id="accordionEI">

          {# 1) DADOS DO ENVIO #}
          <div class="accordion-item">
            <h2 class="accordion-header" id="accDadosHeader">
              <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse"
                      data-bs-target="#accDados" aria-expanded="true" aria-controls="accDados">
                <i class="bi bi-clipboard-plus me-2"></i> Dados do Envio
              </button>
            </h2>
            <div id="accDados" class="accordion-collapse collapse show" aria-labelledby="accDadosHeader"
                 data-bs-parent="#accordionEI">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-hash me-1"></i> OP *</label>
{% if form.op.errors %}
  {{ form.op|add_class:"form-control is-invalid" }}
  {% for e in form.op.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
{% else %}
  {{ form.op|add_class:"form-control" }}
{% endif %}

                  </div>

                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-tag me-1"></i> Mat√©ria-prima *</label>
                    {{ form.materia_prima|add_class:"form-select select2" }}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-calendar2-week me-1"></i> Data de envio</label>
                    {{ form.data_envio|add_class:"form-control" }}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-archive me-1"></i> Qtd MP prevista (kg) *</label>
                    {{ form.qtde_op_prevista|add_class:"form-control" }}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-123 me-1"></i> Pe√ßas planejadas OP *</label>
                    {{ form.pecas_planejadas_op|add_class:"form-control" }}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-cpu me-1"></i> M√°quina</label>
                    {{ form.maquina|add_class:"form-select select2" }}
                  </div>

                  <div class="col-12">
                    <label class="form-label"><i class="bi bi-card-text me-1"></i> Observa√ß√µes</label>
                    {{ form.observacoes|add_class:"form-control" }}
                  </div> 

                  {# Anexo padronizado #}
                </div>
              </div>
            </div>
          </div>

          {# 2) LOTES / ROLOS #}
          <div class="accordion-item">
            <h2 class="accordion-header" id="accLotesHeader">
              <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#accLotes" aria-expanded="false" aria-controls="accLotes">
                <i class="bi bi-upc-scan me-2"></i> Lotes / Rolos
              </button>
            </h2>
            <div id="accLotes" class="accordion-collapse collapse" aria-labelledby="accLotesHeader"
                 data-bs-parent="#accordionEI">
              <div class="accordion-body">
                {{ formset.management_form }}
                <div id="itens-wrapper" class="table-responsive zebra-tabela">
                  <table class="table table-bordered table-striped align-middle text-center">
                    <thead class="table-light">
                      <tr>
                        <th style="width:40%">
                          <div class="d-flex flex-column align-items-center">
                            <i class="bi bi-upc mb-1"></i><small>Lote / Rolo</small>
                          </div>
                        </th>
                        <th style="width:30%">
                          <div class="d-flex flex-column align-items-center">
                            <i class="bi bi-file-earmark-text mb-1"></i><small>TB050</small>
                          </div>
                        </th>
                        <th style="width:20%">
                          <div class="d-flex flex-column align-items-center">
                            <i class="bi bi-box-arrow-in-right mb-1"></i><small>Enviado (kg)</small>
                          </div>
                        </th>
                        <th style="width:10%"></th>
                      </tr>
                    </thead>
                    <tbody id="itens-body">
                      {% for f in formset %}
                      <tr class="eiitem-row">
                        <td>
                          {{ f.lote }} {{ f.id }}
                          {% for e in f.lote.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                        </td>
                        <td>
                          {{ f.tb050 }}
                          {% for e in f.tb050.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                        </td>
                        <td>
                          {{ f.enviado }}
                          {% for e in f.enviado.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                        </td>
                        <td>
                          {% if formset.can_delete %}
                          <div class="form-check">
                            {{ f.DELETE }} <label class="form-check-label">Remover</label>
                          </div>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

                <button type="button" class="btn btn-outline-primary btn-acao-personalizado btn-sm" id="btn-add-item">
                  <i class="bi bi-plus-circle me-1"></i> Adicionar lote
                </button>
              </div>
            </div>
          </div>

          {# 3) PAR√ÇMETROS #}
          <div class="accordion-item">
            <h2 class="accordion-header" id="accParamsHeader">
              <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#accParams" aria-expanded="false" aria-controls="accParams">
                <i class="bi bi-sliders me-2"></i> Par√¢metros
              </button>
            </h2>
            <div id="accParams" class="accordion-collapse collapse" aria-labelledby="accParamsHeader"
                 data-bs-parent="#accordionEI">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-percent me-1"></i> Toler√¢ncia de sucata (%)</label>
                    {{ form.tolerancia_sucata_percentual|add_class:"form-control" }}
                  </div>
                  <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-cash-coin me-1"></i> Custo por kg (opcional)</label>
                    {{ form.custo_kg|add_class:"form-control" }}
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>{# /accordion #}

      </div>{# /card-body #}

      <div class="card-footer d-flex justify-content-end">
        {# Bot√µes padronizados #}
        {% include "partials/global/_botoes_salvar_cancelar.html" with edicao=False url_voltar='ei_list_em_fabrica' %}
      </div>
    </div>{# /card #}

  </form>
</div>

{# === Scripts: Select2 + din√¢mica do formset (mantendo o padr√£o do projeto) === #}
<script>
(function(){
  function init() {
    if (!window.jQuery) return setTimeout(init, 100);
    var $ = jQuery;

    // Select2 gen√©rico
    if ($.fn.select2) {
      $('.select2').each(function(){
        if (!$(this).hasClass('select2-hidden-accessible')) {
          $(this).select2({ width: '100%', language: 'pt-BR', allowClear: true });
        }
      });
    }

    const $mp = $('#id_materia_prima');

    function initRow($row){
      const $lote = $row.find('select.eiitem-lote');
      const $tb50 = $row.find('select.eiitem-tb50');

      if (!$.fn.select2) return;

      if ($lote.hasClass('select2-hidden-accessible')) { try{$lote.select2('destroy');}catch(e){} }

      $lote.select2({
        placeholder: "‚Äî selecione ‚Äî",
        allowClear: true,
        width: '100%',
        language: {
          errorLoading: () => "Erro ao carregar",
          loadingMore: () => "Carregando mais‚Ä¶",
          noResults: () => $mp.val() ? "Nenhum rolo encontrado para esta MP" : "Selecione a Mat√©ria-prima acima",
          searching: () => "Buscando‚Ä¶"
        },
        minimumInputLength: 0,
        ajax: {
          url: "{% url 'api_rolos_por_mp' %}",
          dataType: 'json',
          delay: 200,
          data: function(params){
            return { mp: $mp.val() || "", q: params.term || "", _ts: Date.now() };
          },
          processResults: function(data){
            var res = (data && data.results) ? data.results : [];
            return { results: res.map(function(r){
              return { id: r.id, text: r.texto, tb050_id: r.tb050_id, tb050_label: r.tb050_label };
            }) };
          },
          cache: false
        }
      });

      if (!$tb50.hasClass('select2-hidden-accessible')) {
        $tb50.select2({ width:'100%', placeholder:'Selecione...', language:'pt-BR', allowClear: true });
      }

      // Autopreenche TB050 ao escolher o rolo
      $lote.on('select2:select', function(e){
        var d = e.params.data || {};
        if (!d.tb050_id) { $tb50.val(null).trigger('change'); return; }
        if ($tb50.find('option[value="'+ d.tb050_id +'"]').length === 0) {
          var opt = new Option(d.tb050_label || String(d.tb050_id), d.tb050_id, true, true);
          $tb50.append(opt).trigger('change');
        } else {
          $tb50.val(String(d.tb050_id)).trigger('change');
        }
      });

      $lote.on('select2:clear', function(){ $tb50.val(null).trigger('change'); });
    }

    // Inicializa linhas j√° renderizadas
    $('#itens-body tr.eiitem-row').each(function(){ initRow($(this)); });

    // Bot√£o ‚ÄúAdicionar lote‚Äù
    $('#btn-add-item').on('click', function(){
      var $tbody = $('#itens-body');
      var formIdx = $('#id_itens-TOTAL_FORMS').val();
      var tmpl = `
        <tr class="eiitem-row">
          <td>
            ${'{{ formset.empty_form.lote|escapejs }}'.replace(/__prefix__/g, formIdx)}
            ${'{{ formset.empty_form.id|escapejs }}'.replace(/__prefix__/g, formIdx)}
          </td>
          <td>${'{{ formset.empty_form.tb050|escapejs }}'.replace(/__prefix__/g, formIdx)}</td>
          <td>${'{{ formset.empty_form.enviado|escapejs }}'.replace(/__prefix__/g, formIdx)}</td>
          <td>
            <div class="form-check">
              ${'{{ formset.empty_form.DELETE|escapejs }}'.replace(/__prefix__/g, formIdx)}
              <label class="form-check-label">Remover</label>
            </div>
          </td>
        </tr>`;
      $tbody.append(tmpl);
      $('#id_itens-TOTAL_FORMS').val(parseInt(formIdx, 10) + 1);
      initRow($tbody.find('tr.eiitem-row').last());
    });

    // Ao trocar a MP: limpa e recria selects dos lotes/TB050
    $mp.on('change', function(){
      $('#itens-body').find('tr.eiitem-row').each(function(){
        var $row = $(this);
        var $lote = $row.find('select.eiitem-lote');
        var $tb50 = $row.find('select.eiitem-tb50');

        if ($.fn.select2 && $lote.hasClass('select2-hidden-accessible')) {
          try{$lote.select2('destroy');}catch(e){}
          $lote.val("");
        } else {
          $lote.empty().append(new Option("‚Äî selecione ‚Äî", ""));
        }
        $tb50.val(null).trigger('change');

        initRow($row);
      });
    });
  }
  init();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // foca no primeiro inv√°lido
  const firstInvalid = document.querySelector('.is-invalid');
  if (firstInvalid) {
    try { firstInvalid.focus(); } catch(e) {}
    // abre o acorde√£o onde o campo est√° (se estiver fechado)
    const collapse = firstInvalid.closest('.accordion-collapse');
    if (collapse && !collapse.classList.contains('show')) {
      const btn = document.querySelector('[data-bs-target="#' + collapse.id + '"]');
      if (btn) btn.click();
    }
    // scroll suave at√© o campo
    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
});
</script>
{% endblock %}
