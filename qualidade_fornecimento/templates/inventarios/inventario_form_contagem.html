{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-2">
  <h4 class="m-0">
    {{ ordem_label }} — {{ inventario.titulo }}
    <span class="badge rounded-pill bg-success ms-2" id="badge-count">0</span>
  </h4>
  <a class="btn btn-outline-secondary" href="{% url 'inventario_detail' inventario.pk %}">Voltar</a>
</div>

<p class="text-muted mb-3">
  Tipo: <strong>{{ inventario.get_tipo_display }}</strong> ·
  Status: <strong>{{ inventario.get_status_display }}</strong> ·
  Data de corte: {{ inventario.data_corte|date:"d/m/Y" }}
</p>

<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Leitura por Câmera (QR Code)</h6>

        <!-- Pré-visualização + HUD de feedback -->
        <div class="ratio ratio-4x3 border rounded position-relative overflow-hidden">
          <video id="preview" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover;"></video>

          <!-- HUD: aparece por ~600ms ao ler -->
          <div id="scan-hud" class="position-absolute top-0 start-0 w-100 h-100 d-none
                      justify-content-center align-items-center">
            <div id="scan-hud-mark" class="rounded-circle border border-3 d-flex
                        justify-content-center align-items-center"
                 style="width:120px; height:120px; font-size:64px; font-weight:700;">
              ✓
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-2 align-items-center">
          <button id="btn-start" class="btn btn-primary">Iniciar câmera</button>
          <button id="btn-stop" class="btn btn-outline-secondary" disabled>Parar</button>
        </div>

        <div class="form-text mt-2">
          A cada QR lido, o item é registrado automaticamente (ordem {{ ordem }}).
          Se o QR trouxer o <em>peso</em> no 3º campo, ele será usado como quantidade.
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Entrada Manual (opcional)</h6>
        <form id="form-manual" class="row g-2" autocomplete="off">
          {% csrf_token %}
          <div class="col-12">
            <label class="form-label">QR/Texto da Etiqueta</label>
            {{ form.origem_qrcode }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Quantidade</label>
            {{ form.quantidade }}
          </div>
          <input type="hidden" id="ordem" name="ordem" value="{{ ordem }}"/>
          <div class="col-12">
            <button type="button" id="btn-manual" class="btn btn-outline-primary">Registrar manualmente</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Últimos lidos -->
<div class="card mt-3 shadow-sm">
  <div class="card-body">
    <h6 class="mb-2">Últimos lidos</h6>
    <div id="lista-lidos" class="small text-muted">Nenhuma leitura ainda.</div>
  </div>
</div>

<!-- Finalizar contagem -->
<form class="mt-3" method="post" action="{% url 'finalizar_contagem' inventario.pk ordem %}">
  {% csrf_token %}
  <button type="submit" class="btn btn-success btn-lg">Finalizar {{ ordem_label }}</button>
</form>

<!-- Toast (Bootstrap) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="scanToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="scanToastBody">
        Leitura registrada.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<style>
/* HUD animação */
#scan-hud.show-success #scan-hud-mark{
  background: rgba(25,135,84,.15);
  color: #198754;
  border-color: #198754 !important;
  animation: hud-pop .6s ease-out;
}
#scan-hud.show-error #scan-hud-mark{
  background: rgba(220,53,69,.15);
  color: #dc3545;
  border-color: #dc3545 !important;
  animation: hud-pop .6s ease-out;
}
@keyframes hud-pop {
  0%   { transform: scale(.6); opacity:.0; }
  40%  { transform: scale(1.05); opacity:1; }
  100% { transform: scale(1.0); opacity:1; }
}
/* destaque da última linha */
.lido-novo { background: #e7f7ef; transition: background .8s; }
.lido-novo.fadeout { background: transparent; }
</style>

<!-- Se você estiver usando html5-qrcode/jsQR/BarcodeDetector, mantenha sua parte de leitura.
     Abaixo está o JS genérico: ele dá feedback em QUALQUER fluxo que chamar enviarLeitura(). -->

<script>
// ===== utilidades =====
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  return '';
}
function beep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sine'; o.frequency.value = 1000; g.gain.value = 0.06;
    o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 120);
  } catch(e){}
}
function vibrate(ms=60){ if (navigator.vibrate) navigator.vibrate(ms); }

// ===== feedback visual =====
const hud = document.getElementById('scan-hud');
const hudMark = document.getElementById('scan-hud-mark');
let hudTimer = null;

function showHUD(kind='success', text='✓') {
  if (!hud) return;
  hud.classList.remove('d-none','show-success','show-error');
  hud.classList.add('d-flex', kind === 'success' ? 'show-success' : 'show-error');
  if (hudMark) hudMark.textContent = (kind === 'success') ? '✓' : '!';
  clearTimeout(hudTimer);
  hudTimer = setTimeout(()=>{
    hud.classList.add('d-none');
    hud.classList.remove('d-flex','show-success','show-error');
  }, 600);
}

// toast (Bootstrap com fallback)
function showToast(msg, ok=true) {
  const el = document.getElementById('scanToast');
  const body = document.getElementById('scanToastBody');
  if (!el || !body) return;
  body.textContent = msg || (ok ? 'Leitura registrada.' : 'Falha ao registrar.');
  el.classList.toggle('text-bg-success', ok);
  el.classList.toggle('text-bg-danger', !ok);
  try {
    if (window.bootstrap?.Toast) {
      new bootstrap.Toast(el, { delay: 1500 }).show();
    } else {
      // fallback simples
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 1500);
    }
  } catch(e){}
}

// contador de lidos + destaque
function bumpCounter() {
  const badge = document.getElementById('badge-count');
  const n = parseInt(badge.textContent || '0', 10) + 1;
  badge.textContent = n;
}
function appendLido(qr, qtd) {
  const el = document.getElementById('lista-lidos');
  const now = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.textContent = `[${now}] ${qr}  —  qtd: ${qtd || 'auto'}`;
  line.classList.add('lido-novo');
  if (el && el.textContent === 'Nenhuma leitura ainda.') el.textContent = '';
  if (el) {
    el.prepend(line);
    setTimeout(()=> line.classList.add('fadeout'), 600);
  }
  bumpCounter();
}

// ===== envio =====
async function enviarLeitura(qrcode, quantidade, ordem) {
  try {
    const resp = await fetch("{% url 'api_scan_qrcode' inventario.pk %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
      },
      body: new URLSearchParams({ qrcode, quantidade: quantidade || "", ordem })
    });
    const data = await resp.json();
    if (data.ok) {
      showHUD('success'); beep(); vibrate();
      showToast('Leitura registrada', true);
    } else {
      showHUD('error'); showToast(data.erro || 'Falha ao registrar.', false);
    }
    return data;
  } catch (e) {
    showHUD('error'); showToast('Erro de comunicação.', false);
    return { ok:false, erro:'erro de comunicação' };
  }
}

// ===== leitura manual =====
document.getElementById('btn-manual')?.addEventListener('click', async ()=>{
  const qr   = document.getElementById('id_origem_qrcode')?.value.trim();
  const qtd  = document.getElementById('id_quantidade')?.value.trim();
  const ordem= document.getElementById('ordem')?.value;
  if (!qr) { alert('Informe o QR/Texto.'); return; }
  const data = await enviarLeitura(qr, qtd, ordem);
  if (data.ok) {
    appendLido(qr, qtd);
    document.getElementById('id_origem_qrcode').value = '';
    document.getElementById('id_quantidade').value = '';
    document.getElementById('id_origem_qrcode').focus();
  }
});

// ===== sua lógica de câmera =====
// Se você já tem o código de captura (BarcodeDetector/jsQR/html5-qrcode), mantenha.
// Apenas garanta que, AO LER um QR válido, chame:
///   const ordem = "{{ ordem }}";
///   const data = await enviarLeitura(decodedValue, '', ordem);
///   if (data.ok) appendLido(decodedValue, 'auto');
//
// Exemplo mínimo de stub para não quebrar botões quando não houver scanner configurado:
let stream = null, detectTimer = null;
async function startCamera(){
  // aqui entra a sua rotina de leitura real (já implementada).
  // Este stub só cuida de estados dos botões.
  document.getElementById('btn-start').disabled = true;
  document.getElementById('btn-stop').disabled  = false;
}
function stopCamera(){
  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-stop').disabled  = true;
  if (detectTimer) cancelAnimationFrame(detectTimer);
  detectTimer = null;
}

document.getElementById('btn-start')?.addEventListener('click', (e)=>{ e.preventDefault(); startCamera(); });
document.getElementById('btn-stop') ?.addEventListener('click', (e)=>{ e.preventDefault(); stopCamera(); });
</script>

{% endblock %}
