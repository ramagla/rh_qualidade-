{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Lista de Documentos{% endblock %}

{% block content %}
{% include 'partials/global/_styles_componentes.html' %}
{% include 'partials/global/_toast_mensagens.html' %}
{% include 'partials/global/_header_titulo.html' with titulo="Lista de Documentos" icone="bi bi-journal-text" emoji="üìÑ" %}

<div class="container-fluid mt-5">

  {% include "partials/global/_estilos_botoes_acoes.html" %}

  <!-- Bot√µes superiores: Filtros (offcanvas) e Cadastro -->
  <div class="d-flex justify-content-end flex-wrap gap-2 mb-4">
    {% include "partials/global/_botao_filtros_offcanvas.html" %}

    {% if request.user|has_permission:'Funcionario.add_documento' %}
      <a href="{% url 'cadastrar_documento' %}" class="btn btn-cadastrar-personalizado d-inline-flex align-items-center">
        <i class="bi bi-plus-circle-fill me-2" aria-hidden="true"></i> Cadastrar
      </a>
    {% endif %}
  </div>

  <!-- Offcanvas de Filtros -->
<div class="offcanvas offcanvas-end offcanvas-modern" tabindex="-1" id="filtrosOffcanvas" aria-labelledby="filtrosOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtrosOffcanvasLabel">
      <i class="bi bi-funnel-fill me-2"></i>Filtros de Documentos
    </h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
  </div>

  <div class="offcanvas-body">
    <form method="get" class="row g-3">

      <!-- Nome -->
      <div class="col-12">
        <label for="nome" class="form-label"><i class="bi bi-fonts me-1"></i> Nome</label>
        <select name="nome" id="nome" class="form-select select2" data-dropdown-parent="#filtrosOffcanvas">
          <option value="">Todos</option>
          {% for documento in documentos_distinct %}
            <option value="{{ documento.nome }}" {% if request.GET.nome == documento.nome %}selected{% endif %}>
              {{ documento.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- C√≥digo -->
      <div class="col-12">
        <label for="codigo" class="form-label"><i class="bi bi-upc-scan me-1"></i> C√≥digo</label>
        <select name="codigo" id="codigo" class="form-select select2" data-dropdown-parent="#filtrosOffcanvas">
          <option value="">Todos</option>
          {% for codigo in codigos_distinct %}
            <option value="{{ codigo.codigo }}" {% if request.GET.codigo == codigo.codigo %}selected{% endif %}>
              {{ codigo.codigo }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Departamento -->
      <div class="col-12">
        <label for="departamento" class="form-label"><i class="bi bi-diagram-3 me-1"></i> Departamento</label>
        <select name="departamento" id="departamento" class="form-select select2" data-dropdown-parent="#filtrosOffcanvas">
          <option value="">Todos</option>
          {% for dep_id, dep_nome in departamentos_distinct %}
            <option value="{{ dep_id }}" {% if request.GET.departamento == dep_id|stringformat:"s" %}selected{% endif %}>
              {{ dep_nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Status -->
      <div class="col-12">
        <label for="status" class="form-label"><i class="bi bi-check2-square me-1"></i> Status</label>
        <select name="status" id="status" class="form-select select2" data-dropdown-parent="#filtrosOffcanvas">
          <option value="">Todos</option>
          {% for key, value in status_choices %}
            <option value="{{ key }}" {% if request.GET.status == key %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Per√≠odo da √öltima Revis√£o (opcional) -->
      <div class="col-12">
        <label class="form-label"><i class="bi bi-calendar-range me-1"></i> Per√≠odo da √öltima Revis√£o</label>
        <div class="row g-2">
          <div class="col-6">
            <input type="date" name="data_inicio" class="form-control" value="{{ request.GET.data_inicio }}">
          </div>
          <div class="col-6">
            <input type="date" name="data_fim" class="form-control" value="{{ request.GET.data_fim }}">
          </div>
        </div>
      </div>

      <!-- Bot√£o Filtrar -->
      <div class="col-12 mt-3">
        {% include 'partials/global/_botao_filtrar.html' %}
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    $('.select2').each(function () {
      const $el = $(this);
      $el.select2({
        placeholder: "Selecione uma op√ß√£o",
        allowClear: true,
        width: '100%',
        dropdownParent: $($el.data('dropdown-parent') || document.body)
      });
    });
  });
</script>


  <!-- Indicadores -->
  <div class="row g-3 mb-4">
    {% include 'partials/global/_card_indicador.html' with cor="primary" titulo="üìÅ Total de Documentos" valor=total_documentos subtitulo="Documentos cadastrados." %}
    {% include 'partials/global/_card_indicador.html' with cor="success" titulo="‚úîÔ∏è Aprovados" valor=total_aprovados subtitulo="Documentos aprovados." %}
    {% include 'partials/global/_card_indicador.html' with cor="warning" titulo="‚è≥ Em Revis√£o" valor=total_em_revisao subtitulo="Aguardando revis√£o." %}
    {% include 'partials/global/_card_indicador.html' with cor="danger" titulo="‚ùå Inativos" valor=total_inativos subtitulo="Documentos inativos." %}
  </div>

  <!-- Tabela de Documentos -->
  <div class="table-responsive zebra-tabela mt-4">
  <table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-light">
      <tr>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-upc mb-1"></i>
            <small>C√≥digo</small>
          </div>
        </th>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-journal-text mb-1"></i>
            <small>Nome</small>
          </div>
        </th>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-person-badge mb-1"></i>
            <small>Respons√°vel</small>
          </div>
        </th>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-flag mb-1"></i>
            <small>Status</small>
          </div>
        </th>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-card-checklist mb-1"></i>
            <small>√öltima Revis√£o</small>
          </div>
        </th>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-calendar-event mb-1"></i>
            <small>Atualiza√ß√£o</small>
          </div>
        </th>
        <th class="text-center align-middle">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-gear mb-1"></i>
            <small>A√ß√µes</small>
          </div>
        </th>
      </tr>
    </thead>

      <tbody>
        {% if page_obj %}
            {% for documento in page_obj %}
            <tr>
              <td>{{ documento.codigo }}</td>

              <td>{{ documento.nome }}</td>
              <td>{{ documento.responsavel_recuperacao.nome }}</td>
              <td>
                {% if documento.status == 'aprovado' %}
                  <span class="badge bg-success">{{ documento.get_status_display }}</span>
                {% elif documento.status == 'em_revisao' %}
                  <span class="badge bg-warning text-dark">{{ documento.get_status_display }}</span>
                {% elif documento.status == 'inativo' %}
                  <span class="badge bg-danger">{{ documento.get_status_display }}</span>
                {% else %}
                  <span class="badge bg-secondary">Indefinido</span>
                {% endif %}
              </td>
              <td>
                {% with documento.revisoes.all|first as ultima_revisao %}
  {% if ultima_revisao %}
    {{ ultima_revisao.numero_revisao }}
  {% else %}
    <span class="text-muted">Sem revis√£o</span>
  {% endif %}
{% endwith %}

              </td>
              <td>
  {% if documento.revisoes.first %}
    {{ documento.revisoes.first.data_revisao|date:"d/m/Y" }}
  {% else %}
    <span class="text-muted">Sem atualiza√ß√£o</span>
  {% endif %}
</td>
              <td>
                <div class="d-flex justify-content-center flex-wrap gap-2">
                  {% if request.user|has_permission:'Funcionario.change_documento' %}
                    {% include 'partials/global/_botao_editar.html' with objeto=documento url_editar='editar_documento' %}
                  {% endif %}

                  {% if request.user|has_permission:'Funcionario.view_revisao' %}
                  <a href="{% url 'historico_documentos' documento.id %}" class="btn btn-sm btn-info mt-1" title="Hist√≥rico de Revis√µes" aria-label="Hist√≥rico de {{ documento.nome }}">
                    <i class="bi bi-clock-history" aria-hidden="true"></i>
                  </a>
                  {% endif %}

                  {% if documento.arquivo and request.user|has_permission:'Funcionario.view_documento' %}
                  <a href="{{ documento.arquivo.url }}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-dark mt-1" title="Visualizar Documento" aria-label="Visualizar {{ documento.nome }}">
                    <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
                  </a>
                  {% endif %}

                  {% if request.user|has_permission:'Funcionario.delete_documento' %}
                    {% include 'partials/global/_botao_excluir.html' with objeto=documento url_excluir='excluir_documento' %}
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
            <tr>
              <td colspan="7">
                {% include 'partials/global/_sem_resultados.html' with item_nome="documento" %}
              </td>
            </tr>
          {% endif %}

      </tbody>
    </table>
  </div>

  <!-- Pagina√ß√£o -->
  {% include 'partials/global/_paginacao.html' %}

</div>

<!-- Inicializa√ß√£o Select2 -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    $('.select2').select2({
      placeholder: "Selecione uma op√ß√£o",
      allowClear: true,
      width: '100%'
    });
  });
</script>
{% endblock %}
