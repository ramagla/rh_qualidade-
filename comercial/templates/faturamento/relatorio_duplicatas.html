{% extends 'base.html' %}
{% load custom_filters %}
{% load time_extras %}
{% load conversores %}
{% load humanize %}
{% load filters_gerais %}

{% block content %}
{% include 'partials/global/_styles_componentes.html' %}
{% include 'partials/global/_toast_mensagens.html' %}
{% include 'partials/global/_estilos_impressao.html' %}

<div class="print-container container mt-5">

  {% include 'partials/global/_botao_impressao.html' %}

  <form method="GET" class="mb-4 row g-2 d-print-none">
    <div class="col-md-3">
      <label for="data_inicio" class="form-label">
        <i class="bi bi-calendar2-week me-1"></i> Data Início (Vencimento)
      </label>
      <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
    </div>
    <div class="col-md-3">
      <label for="data_fim" class="form-label">
        <i class="bi bi-calendar2-week me-1"></i> Data Fim (Vencimento)
      </label>
      <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </div>
  </form>

  {% load static %}
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle text-center mb-0" style="table-layout:fixed;">
      <tr>
        <td style="width:20%;">
          <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height:64px;">
        </td>
        <td style="width:55%;" class="px-2 py-1 text-center align-middle">
          <div class="text-center">
            <strong>RELATÓRIO DE DUPLICATAS</strong><br>
            <span class="text-uppercase">Resumo por período de vencimento</span>
          </div>
        </td>
        <td style="width:25%; padding:0; vertical-align:middle;">
          <div class="text-center p-1">
            <strong class="d-block">Período</strong>
            <span>
              {{ data_inicio|default_if_none:""|data_br|default:"—" }}
              até
              {{ data_fim|default_if_none:""|data_br|default:"—" }}
            </span>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- KPIs -->
  <div class="print-cards mb-3 d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
    <div class="card shadow-sm h-100 no-break border-primary">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-primary mb-1">
          {{ total_periodo|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-cash-coin me-1"></i> Total no Período
        </div>
      </div>
    </div>

    <div class="card shadow-sm h-100 no-break border-danger">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-danger mb-1">
          {{ total_tributos|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-receipt-cutoff me-1"></i> Total de Tributos (ICMS + IPI)
        </div>
      </div>
    </div>

    <div class="card shadow-sm h-100 no-break border-warning">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-warning mb-1">
          {{ total_mes|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-calendar2-event me-1"></i> Com Vencimento Este Mês
        </div>
      </div>
    </div>

    <div class="card shadow-sm h-100 no-break border-success">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-success mb-1">
          {{ total_avista|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-cash-stack me-1"></i> Pagamento à Vista
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela principal (sem totalizador) -->
  <div class="card shadow-sm mb-3 border-primary">
    <div class="card-header bg-white fw-semibold py-2 text-primary">
      <i class="bi bi-receipt me-2"></i>Duplicatas — Detalhamento
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover table-striped align-middle mb-0">
          <thead class="table-primary">
  <tr>
    <th class="text-center align-middle"><i class="bi bi-receipt d-block fs-6"></i>Nº NF</th>
    <th class="text-center align-middle"><i class="bi bi-calendar-event d-block fs-6"></i>Data</th>
    <th class="text-center align-middle"><i class="bi bi-person-badge d-block fs-6"></i>Cliente</th>
    <th class="text-center align-middle"><i class="bi bi-calendar-check d-block fs-6"></i>Vencimento</th>
    <th class="text-center align-middle"><i class="bi bi-cash-coin d-block fs-6"></i>Valor</th>
    <th class="text-center align-middle"><i class="bi bi-percent d-block fs-6"></i>Valor ICMS</th>
    <th class="text-center align-middle"><i class="bi bi-percent d-block fs-6"></i>Valor IPI</th>
    <th class="text-center align-middle"><i class="bi bi-file-earmark-text d-block fs-6"></i>Natureza</th>
    <th class="text-center align-middle"><i class="bi bi-upc-scan d-block fs-6"></i>CFOP</th>
    <th class="text-center align-middle"><i class="bi bi-cash-stack d-block fs-6"></i>Valor PIS</th>
    <th class="text-center align-middle"><i class="bi bi-cash-stack d-block fs-6"></i>Valor COFINS</th>
    <th class="text-center align-middle"><i class="bi bi-calculator d-block fs-6"></i>Valor Total (Valor + IPI)</th>
  </tr>
</thead>


          <tbody>
            {% if linhas %}
              {% for l in linhas %}
              <tr>
                <td class="text-nowrap">{{ l.nfe }}</td>
                <td class="text-nowrap">{% if l.data %}{{ l.data|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                <td class="text-start">{{ l.cliente|primeiro_nome }}</td>
                <td class="text-nowrap">{{ l.vencimento|date:"d/m/Y" }}</td>
                <td class="text-end">{{ l.valor|formatar_reais }}</td>
                <td class="text-end">{{ l.valor_icms|formatar_reais }}</td>
                <td class="text-end">{{ l.valor_ipi|formatar_reais }}</td>
                <td class="text-start">{{ l.natureza }}</td>
                <td class="text-nowrap">{{ l.cfop }}</td>
                <td class="text-end">{{ l.valor_pis|formatar_reais }}</td>
                <td class="text-end">{{ l.valor_cofins|formatar_reais }}</td>
                <td class="text-end fw-semibold">{{ l.valor_total|formatar_reais }}</td>

              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="8" class="text-muted text-center">Sem duplicatas no período.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TOTALIZADORES EM CARDS (mesmo design dos KPIs do topo) -->
<div class="card shadow-sm mb-3 border-success no-break">
  <div class="card-header bg-white fw-semibold py-2 text-success">
    <i class="bi bi-calculator me-2"></i>Totalizadores do Período
  </div>
  <div class="card-body">
    <div class="print-cards d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
      <div class="card shadow-sm h-100 border-primary">
        <div class="card-body text-center py-3">
          <div class="kpi-number fs-4 fw-bold text-primary mb-1">
      {{ qtde_duplicatas|default_if_none:0|default:0 }}
    </div>
    <div class="kpi-label text-secondary small">
      <i class="bi bi-receipt me-1"></i>Quantidade de Duplicatas
    </div>
        </div>
      </div>

      <div class="card shadow-sm h-100 border-info">
        <div class="card-body text-center py-3">
          <div class="kpi-number fs-4 fw-bold text-info mb-1">
            {{ total_icms|default_if_none:0|default:0|formatar_reais }}
          </div>
          <div class="kpi-label text-secondary small">
            <i class="bi bi-percent me-1"></i>Total ICMS
          </div>
        </div>
      </div>

      <div class="card shadow-sm h-100 border-warning">
        <div class="card-body text-center py-3">
          <div class="kpi-number fs-4 fw-bold text-warning mb-1">
            {{ total_ipi|default_if_none:0|default:0|formatar_reais }}
          </div>
          <div class="kpi-label text-secondary small">
            <i class="bi bi-basket2 me-1"></i>Total IPI
          </div>
        </div>
      </div>

      <div class="card shadow-sm h-100 border-success">
        <div class="card-body text-center py-3">
          <div class="kpi-number fs-4 fw-bold text-success mb-1">
            {{ total_geral|default_if_none:0|default:0|formatar_reais }}
          </div>
          <div class="kpi-label text-secondary small">
            <i class="bi bi-calculator me-1"></i>Total Geral (Valor + IPI)
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <style media="print">
  /* evita barras de rolagem e cortes */
  .table-responsive{ overflow:visible !important; height:auto !important; max-height:none !important; }
  thead, tbody, tr, td, th{ break-inside:avoid !important; page-break-inside:avoid !important; }

  /* deixa a tabela “respirar” e não cortar valores longos */
  .table{ table-layout:auto !important; width:100% !important; font-size:9px !important; }
  .table th, .table td{
    padding:2px 6px !important;
    line-height:1.15 !important;
    white-space:normal !important;
    word-break:break-word !important;
    overflow:visible !important;
  }

  /* gráfico menor e sem distorção no print */
  .chart-card{ page-break-inside:avoid; }
  .chart-print-box{ height:160px !important; }
  #chart_dup_clientes{ width:100% !important; height:160px !important; max-height:160px !important; }
</style>

  <!-- Gráfico: Top 10 por Cliente (primeiro nome) -->
  <div class="card shadow-sm mb-3 border-info chart-card">
    <div class="card-header bg-white fw-semibold py-2 text-info">
      <i class="bi bi-bar-chart-line me-2"></i>Top 10 Clientes (Primeiro Nome) — Valor de Duplicatas
    </div>
    <div class="chart-print-box">
<canvas id="chart_dup_clientes" width="560" height="160"></canvas>
    </div>
  </div>

  <p class="mt-2 small text-muted">
    <i class="bi bi-info-circle me-1"></i>
    Os valores consideram o campo <b>valor_duplicata</b> das duplicatas vinculadas à NF.
    O “Pagamento à Vista” considera quando a data de emissão é a mesma do vencimento ou quando o vencimento ocorre 1 dia após a emissão.
  </p>

</div>

  {# Rodapé (forçado a imprimir) #}
  <div class="formulario-rodape d-none d-print-block">
    {% include 'partials/global/_formulario_rodape.html' with numero_formulario="Duplicatas" %}
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  const el = document.getElementById('chart_dup_clientes');
  if (!el || typeof Chart === 'undefined') return;

  const labels = [
    {% for p in chart_data %}"{{ p.cliente|primeiro_nome }}"{% if not forloop.last %},{% endif %}{% endfor %}
  ];
  const rawVals = [
    {% for p in chart_data %}"{{ p.valor|floatformat:2 }}"{% if not forloop.last %},{% endif %}{% endfor %}
  ];
  const dataVals = rawVals.map(v => parseFloat(String(v).replace(',', '.')) || 0);

  new Chart(el, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Valor de Duplicatas',
        data: dataVals
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(ctx.parsed.y)
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: (val) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(val)
          }
        }
      }
    }
  });
})();
</script>


<script>
window.addEventListener('load', function () {
  const el = document.getElementById('chart_dup_clientes');
  if (!el || typeof Chart === 'undefined') return;

  const labels = [
    {% for p in chart_data %}"{{ p.cliente|primeiro_nome }}"{% if not forloop.last %},{% endif %}{% endfor %}
  ];
  const rawVals = [
    {% for p in chart_data %}"{{ p.valor|floatformat:2 }}"{% if not forloop.last %},{% endif %}{% endfor %}
  ];
  const dataVals = rawVals.map(v => parseFloat(String(v).replace(',', '.')) || 0);

  const chart = new Chart(el, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Valor de Duplicatas', data: dataVals, borderWidth: 1 }] },
    options: {
      // Mantém tamanho do <canvas> (evita “esticar” no print)
      responsive: false,
      maintainAspectRatio: false,
      animation: false,
      indexAxis: 'y', // barras HORIZONTAIS
      layout: { padding: { top: 4, right: 8, bottom: 4, left: 8 } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(ctx.parsed.x)
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            font: { size: 9 },
            callback: (val) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(val)
          },
          grid: { drawBorder: false }
        },
        y: {
          ticks: { font: { size: 9 }, autoSkip: false, maxTicksLimit: 10 },
          grid: { display: false }
        }
      }
    }
  });

  // Tamanho estável durante a impressão
  function resizeForPrint(){ try{ chart.resize(560, 160); }catch(e){} }
  function resizeForScreen(){ try{ chart.resize(560, 160); }catch(e){} }

  if ('onbeforeprint' in window) {
    window.addEventListener('beforeprint', resizeForPrint);
    window.addEventListener('afterprint', resizeForScreen);
  }
  const mql = window.matchMedia && window.matchMedia('print');
  if (mql && mql.addEventListener) {
    mql.addEventListener('change', e => e.matches ? resizeForPrint() : resizeForScreen());
  } else if (mql && mql.addListener) {
    mql.addListener(e => e.matches ? resizeForPrint() : resizeForScreen());
  }
});
</script>


<style>
  .table thead th i { opacity:.85; }
  .table thead th { vertical-align:bottom; }
  .sticky-top { top:0; z-index:2; }

  .print-container { max-width:1100px; }
  .print-cards{ display:grid; grid-template-columns:1fr; gap:.5rem; }
  @media (min-width:992px){ .print-cards{ grid-template-columns:repeat(4,1fr);} }
  .kpi-number{ font-size:clamp(1.25rem,3vw,2.25rem); line-height:1.1; }
  .kpi-label{ font-size:.9rem; }

  @page { size:A4 portrait; margin:10mm; }

  @media print{
    html, body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }

    .d-print-none{ display:none!important; }
    .sticky-top{ position:static!important; }
    .print-container{ padding:8px; max-width:820px; }

    .print-cards{
      display:grid!important; grid-template-columns:repeat(4,1fr)!important;
      gap:6px!important; margin-bottom:8px;
    }

    .card, .shadow-sm{ box-shadow:none!important; border:1px solid #dcdcdc; }
    .card-header{ padding:6px 10px!important; font-size:11px!important; }
    .card-body{ padding:8px 10px!important; }

    .kpi-number{ font-size:18px!important; }
    .kpi-label{ font-size:10px!important; }

    .table{ font-size:9px!important; table-layout:fixed; }
    .table th, .table td{ padding:2px 6px!important; line-height:1.15!important; white-space:nowrap; }
    .table thead th{ font-size:9.5px!important; }

    /* Sem scroll na impressão */
    .table-responsive{ overflow:visible!important; height:auto!important; max-height:none!important; }
    thead, tbody, tr, td, th{ break-inside:avoid!important; page-break-inside:avoid!important; }
    .no-break{ break-inside:avoid!important; page-break-inside:avoid!important; }
  }
</style>
{% endblock %}
