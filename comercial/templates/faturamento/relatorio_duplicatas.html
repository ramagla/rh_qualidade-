{% extends 'base.html' %}
{% load custom_filters %}
{% load time_extras %}
{% load conversores %}
{% load humanize %}
{% load filters_gerais %}
{% load static %}

{% block content %}
{% include 'partials/global/_styles_componentes.html' %}
{% include 'partials/global/_toast_mensagens.html' %}
{% include 'partials/global/_estilos_impressao.html' %}

<div class="print-container container mt-5">

  {# Botão imprimir #}
  {% include 'partials/global/_botao_impressao.html' %}

  <div class="mb-4 row g-2 d-print-none">
    <!-- Filtro (GET) -->
  <form method="GET" class="mb-4 row g-2 d-print-none">
    <div class="col-md-3">
        <label for="data_inicio" class="form-label">
          <i class="bi bi-calendar2-week me-1"></i> Data Início
        </label>
        <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
      </div>
    <div class="col-md-3">
        <label for="data_fim" class="form-label">
          <i class="bi bi-calendar2-week me-1"></i> Data Fim
        </label>
        <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
      </div>
    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel"></i> Filtrar
        </button>
      </div>
    </form>

    <!-- Sincronizar Notas (POST) -->
    <form id="form-sync-notas" method="POST" action="{% url 'sync_faturamento_notas' %}" class="col-12 col-lg-4 d-flex align-items-end">
      {% csrf_token %}
      <input type="hidden" id="hidden_data_inicio" name="data_inicio" value="">
      <input type="hidden" id="hidden_data_fim" name="data_fim" value="">
      <button type="submit" class="btn btn-outline-secondary w-100">
        <i class="bi bi-receipt"></i> Sincronizar Notas (API)
      </button>
    </form>
  </div>

  <script>
  (function () {
    const formSync = document.getElementById('form-sync-notas');
    if (!formSync) return;
    formSync.addEventListener('submit', function (ev) {
      const di = (document.getElementById('data_inicio') || {}).value || '';
      const df = (document.getElementById('data_fim') || {}).value || '';
      if (!di || !df) {
        ev.preventDefault();
        alert('Informe o período (Data Início e Data Fim).');
        return false;
      }
      document.getElementById('hidden_data_inicio').value = di;
      document.getElementById('hidden_data_fim').value = df;
    });
  })();
  </script>


  
  <!-- Cabeçalho -->
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle text-center mb-0" style="table-layout:fixed;">
      <tr>
        <td style="width:20%;">
          <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height:64px;">
        </td>
        <td style="width:55%;" class="px-2 py-1 text-center align-middle">
          <div class="text-center">
            <strong>RELATÓRIO DE DUPLICATAS</strong><br>
            <span class="text-uppercase">Resumo por período de emissão</span>
          </div>
        </td>
        <td style="width:25%; padding:0; vertical-align:middle;">
          <div class="text-center p-1">
            <strong class="d-block">Período</strong>
            <span>
              {{ data_inicio|default_if_none:""|data_br|default:"—" }}
              até
              {{ data_fim|default_if_none:""|data_br|default:"—" }}
            </span>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- KPIs -->
<div class="print-cards print-4 mb-3 d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
    <div class="card shadow-sm h-100 no-break border-primary">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-primary mb-1">
          {{ total_periodo|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-cash-coin me-1"></i> Total no Período
        </div>
      </div>
    </div>
    <div class="card shadow-sm h-100 no-break border-danger">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-danger mb-1">
          {{ total_tributos|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-receipt-cutoff me-1"></i> Total de Tributos (ICMS + IPI)
        </div>
      </div>
    </div>
    <div class="card shadow-sm h-100 no-break border-warning">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-warning mb-1">
          {{ total_mes|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-calendar2-event me-1"></i> Com Vencimento Este Mês
        </div>
      </div>
    </div>
    <div class="card shadow-sm h-100 no-break border-success">
      <div class="card-body text-center py-3">
        <div class="kpi-number fs-4 fw-bold text-success mb-1">
          {{ total_avista|default_if_none:0|formatar_reais }}
        </div>
        <div class="kpi-label text-secondary small">
          <i class="bi bi-cash-stack me-1"></i> Pagamento à Vista
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela -->
<div class="card shadow-sm mb-3 border-primary">
  <div class="card-header bg-white fw-semibold py-2 text-primary">
      <i class="bi bi-receipt me-2"></i>Duplicatas — Detalhamento
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover table-striped align-middle text-center mb-0 tabela-dup">
        <thead class="table-primary">
          <tr>
            <th><i class="bi bi-receipt d-block mb-1"></i>Nº NF</th>
            <th><i class="bi bi-calendar-event d-block mb-1"></i>Data</th>
            <th><i class="bi bi-person-badge d-block mb-1"></i>Cliente</th>
            <th><i class="bi bi-calendar-check d-block mb-1"></i>Venc.</th>
            <th><i class="bi bi-cash-coin d-block mb-1"></i>Valor</th>
            <th><i class="bi bi-percent d-block mb-1"></i>ICMS</th>
            <th><i class="bi bi-percent d-block mb-1"></i>IPI</th>
            <th><i class="bi bi-journal-text d-block mb-1"></i>Natureza</th>
            <th><i class="bi bi-upc-scan d-block mb-1"></i>CFOP</th>              
            <th><i class="bi bi-calculator d-block mb-1"></i>Total</th>
          </tr>
        </thead>
        <tbody>
          {% if linhas %}
            {% for l in linhas %}
            <tr>
              <td>{{ l.nfe }}</td>
              <td>{% if l.data %}{{ l.data|date:"d/m/Y" }}{% else %}—{% endif %}</td>
              <td>
                {% if l.cliente_display %}{{ l.cliente_display }}{% else %}—{% endif %}
              </td>
              <td>{{ l.vencimento|date:"d/m/Y" }}</td>
              <td>
                {% if l.mostrar_impostos %}
                  {{ l.valor|formatar_reais }}
                {% else %}
                  <span class="tarja-preta" aria-label="Valor oculto"></span>
                {% endif %}
              </td>
              <td>
                {% if l.mostrar_impostos %}
                  {{ l.valor_icms|formatar_reais }}
                {% else %}
                  <span class="tarja-preta" aria-label="Valor oculto"></span>
                {% endif %}
              </td>
              <td>
                {% if l.mostrar_impostos %}
                  {{ l.valor_ipi|formatar_reais }}
                {% else %}
                  <span class="tarja-preta" aria-label="Valor oculto"></span>
                {% endif %}
              </td>
              <td>{{ l.natureza }}</td>
              <td>{{ l.cfop }}</td>               
              <td>
                {% if l.mostrar_impostos %}
                  {{ l.valor_total|formatar_reais }}
                {% else %}
                  <span class="tarja-preta" aria-label="Valor oculto"></span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="10" class="text-muted">Sem duplicatas no período.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>


  <!-- Totalizadores -->
  <div class="card shadow-sm mb-3 border-success no-break">
    <div class="card-header bg-white fw-semibold py-2 text-success">
      <i class="bi bi-calculator me-2"></i>Totalizadores do Período
    </div>
    <div class="card-body">
<div class="print-cards print-4 d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="card shadow-sm h-100 border-primary">
          <div class="card-body text-center py-3">
            <div class="kpi-number fs-4 fw-bold text-primary mb-1">{{ qtde_duplicatas|default_if_none:0|default:0 }}</div>
            <div class="kpi-label text-secondary small">
              <i class="bi bi-receipt me-1"></i>Quantidade de Duplicatas
            </div>
          </div>
        </div>
        <div class="card shadow-sm h-100 border-info">
          <div class="card-body text-center py-3">
            <div class="kpi-number fs-4 fw-bold text-info mb-1">{{ total_icms|formatar_reais}}</div>
            <div class="kpi-label text-secondary small">
              <i class="bi bi-percent me-1"></i>Total ICMS
            </div>
          </div>
        </div>
        <div class="card shadow-sm h-100 border-warning">
          <div class="card-body text-center py-3">
            <div class="kpi-number fs-4 fw-bold text-warning mb-1">{{ total_ipi|formatar_reais}}</div>
            <div class="kpi-label text-secondary small">
              <i class="bi bi-basket2 me-1"></i>Total IPI
            </div>
          </div>
        </div>
        <div class="card shadow-sm h-100 border-success">
          <div class="card-body text-center py-3">
            <div class="kpi-number fs-4 fw-bold text-success mb-1">{{ total_geral|formatar_reais }}</div>
            <div class="kpi-label text-secondary small">
              <i class="bi bi-calculator me-1"></i>Total Geral (Valor + IPI)
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="card shadow-sm mb-3 border-info chart-card">
    <div class="card-header bg-white fw-semibold py-2 text-info">
      <i class="bi bi-bar-chart-line me-2"></i>Top 10 Clientes — Valor de Duplicatas
    </div>
    <div class="chart-print-box">
      <canvas id="chart_dup_clientes" width="560" height="160"></canvas>
    </div>
  </div>

  <!-- Observações -->
  <p class="mt-2 small text-muted">
    <i class="bi bi-info-circle me-1"></i>
    Os valores consideram o campo <b>valor_duplicata</b> das duplicatas vinculadas à NF.
    O “Pagamento à Vista” considera quando a data de emissão é a mesma do vencimento ou quando o vencimento ocorre 1 dia após a emissão.
    <br>
    <strong>Importante:</strong> os totalizadores <em>(Total no Período, Total ICMS, Total IPI)</em> consideram apenas as notas com CFOP
    <b>{{ cfops_totalizadores }}</b>. A tabela acima lista <u>todas</u> as NFs, independentemente do CFOP.
  </p>

  <!-- Rodapé forçado na impressão -->
  <div class="formulario-rodape d-none d-print-block">
    {% include 'partials/global/_formulario_rodape.html' with numero_formulario="Duplicatas" %}
  </div>

</div> <!-- /.print-container -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  const el = document.getElementById('chart_dup_clientes');
  if (!el || typeof Chart === 'undefined') return;

const labels = [{% for p in chart_data %}"{{ p.cliente_display }}"{% if not forloop.last %},{% endif %}{% endfor %}];
  const rawVals = [{% for p in chart_data %}"{{ p.valor|floatformat:2 }}"{% if not forloop.last %},{% endif %}{% endfor %}];
  const dataVals = rawVals.map(v => parseFloat(String(v).replace(',', '.')) || 0);

  const chart = new Chart(el, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Valor de Duplicatas', data: dataVals, borderWidth: 1 }] },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      animation: false,
      indexAxis: 'y',
      layout: { padding: { top: 4, right: 8, bottom: 4, left: 8 } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(ctx.parsed.x)
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            font: { size: 9 },
            callback: (val) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(val)
          },
          grid: { drawBorder: false }
        },
        y: {
          ticks: { font: { size: 9 }, autoSkip: false, maxTicksLimit: 10 },
          grid: { display: false }
        }
      }
    }
  });

  function resizeForPrint(){ try{ chart.resize(560, 160); }catch(e){} }
  function resizeForScreen(){ try{ chart.resize(560, 160); }catch(e){} }

  if ('onbeforeprint' in window) {
    window.addEventListener('beforeprint', resizeForPrint);
    window.addEventListener('afterprint', resizeForScreen);
  }
  const mql = window.matchMedia && window.matchMedia('print');
  if (mql && mql.addEventListener) {
    mql.addEventListener('change', e => e.matches ? resizeForPrint() : resizeForScreen());
  } else if (mql && mql.addListener) {
    mql.addListener(e => e.matches ? resizeForPrint() : resizeForScreen());
  }
})();
</script>

<style>
  .table thead th i { opacity:.85; }
  .table thead th { vertical-align:bottom; }
  .sticky-top { top:0; z-index:2; }
.tarja-preta{
  display:inline-block;
  width:100%;
  height:12px;
  background:#000;
  border-radius:2px;
  vertical-align:middle;
}
  /* Layout padrão (tela) */
  .print-container { max-width:1100px; }
  .print-cards{ display:grid; grid-template-columns:1fr; gap:.5rem; }
  @media (min-width:992px){ .print-cards{ grid-template-columns:repeat(3,1fr);} }
  .kpi-number{ font-size:clamp(1.25rem,3vw,2.25rem); line-height:1.1; }
  .kpi-label{ font-size:.9rem; }

  /* Página A4 e compressão para caber em 1 folha */
  @page { size:A4 portrait; margin:10mm; }

  @media print{
  html, body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; overflow:visible!important; }

    .d-print-none{ display:none!important; }
    .sticky-top{ position:static!important; }  /* desativa sticky no print */
    .print-container{ padding:8px; max-width:820px; }

    /* Mantém grid, mas permite especificar 4 colunas quando desejado */
  .print-cards{
    display:grid!important; gap:6px!important; margin-bottom:8px;
  }
  /* Força 4 colunas na impressão para os grupos de KPIs */
  .print-cards.print-4{
    grid-template-columns:repeat(4,1fr)!important;
  }

    .card, .shadow-sm{ box-shadow:none!important; border:1px solid #dcdcdc; }
    .card-header{ padding:6px 10px!important; font-size:11px!important; }
    .card-body{ padding:8px 10px!important; }
    .kpi-number{ font-size:18px!important; }
    .kpi-label{ font-size:10px!important; }

    .table{ font-size:9px!important; table-layout:fixed; }
    .table th, .table td{
      padding:2px 6px!important; line-height:1.15!important; white-space:nowrap;
    }
    .table thead th{ font-size:9.5px!important; }

    .table-responsive, table, thead, tbody, tr, td, th{
      break-inside:avoid; page-break-inside:avoid;
    }
    .no-break{ break-inside:avoid; page-break-inside:avoid; }

    .mb-4{ margin-bottom:.5rem!important; }
    .mb-3{ margin-bottom:.4rem!important; }
    .mt-3{ margin-top:.4rem!important; }
    .ps-2{ padding-left:.25rem!important; }

    /* Garante que o partial do rodapé apareça mesmo com classes no próprio include */
    .formulario-rodape-wrapper, .formulario-rodape-wrapper *{ display:initial; visibility:visible; }
    .formulario-rodape-wrapper .d-print-none{ display:initial!important; }
    .tarja-preta{
    -webkit-print-color-adjust:exact;
    print-color-adjust:exact;
    background:#000 !important;
    height:10px;
  }
  }

</style>
{% endblock %}
