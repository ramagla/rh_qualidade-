{% extends 'base.html' %}
{% load custom_filters %}
{% load time_extras %}
{% load conversores %}
{% load humanize %}
{% load filters_gerais %}

{% block content %}
{% include 'partials/global/_styles_componentes.html' %}
{% include 'partials/global/_toast_mensagens.html' %}
{% include 'partials/global/_estilos_impressao.html' %}

<div class="print-container container mt-5">

  {# Botão imprimir #}
  {% include 'partials/global/_botao_impressao.html' %}

  {# Filtros (não imprime) #}
  <form method="GET" class="mb-4 row g-2 d-print-none">
    <div class="col-md-3">
      <label for="data_inicio" class="form-label">
        <i class="bi bi-calendar2-week me-1"></i> Data Início
      </label>
      <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
    </div>
    <div class="col-md-3">
      <label for="data_fim" class="form-label">
        <i class="bi bi-calendar2-week me-1"></i> Data Fim
      </label>
      <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </div>
  </form>

  {# ===== Cabeçalho no padrão F011 (logo + título + período) ===== #}
  {% load static %}
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle text-center mb-0" style="table-layout:fixed;">
      <tr>
        <td style="width:20%;">
          <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height:64px;">
        </td>
        <td style="width:55%;" class="px-2 py-1 text-center align-middle">
          <div class="text-center">
            <strong>RELATÓRIO DE FATURAMENTO</strong><br>
            <span class="text-uppercase">Resumo do Período</span>
          </div>
        </td>
        <td style="width:25%; padding:0; vertical-align:middle;">
          <div class="text-center p-1">
            <strong class="d-block">Período</strong>
<span>
  {{ data_inicio|default_if_none:""|data_br|default:"—" }}
  até
  {{ data_fim|default_if_none:""|data_br|default:"—" }}
</span>

          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="print-cards mb-3">
  <div class="card shadow-sm h-100 no-break border-primary">
    <div class="card-body text-center py-2">
      <div class="kpi-number fw-bold text-primary">
        {{ totais_vendas.valor_c_ipi|default_if_none:0|formatar_reais }}
      </div>
      <div class="kpi-label text-muted">
        <i class="bi bi-receipt-cutoff me-1"></i>Vendas NF (c/ IPI)
      </div>
    </div>
  </div>
  <div class="card shadow-sm h-100 no-break border-success">
    <div class="card-body text-center py-2">
      <div class="kpi-number fw-bold text-success">
        {{ total_vales|default_if_none:0|formatar_reais }}
      </div>
      <div class="kpi-label text-muted">
        <i class="bi bi-ticket-perforated me-1"></i>Vales
      </div>
    </div>
  </div>
  <div class="card shadow-sm h-100 no-break border-danger">
    <div class="card-body text-center py-2">
      <div class="kpi-number fw-bold text-danger">
        {{ total_devolucoes|default_if_none:0|formatar_reais }}
      </div>
      <div class="kpi-label text-muted">
        <i class="bi bi-arrow-counterclockwise me-1"></i>Devoluções
      </div>
    </div>
  </div>
</div>


  {# Tabela 1: Vendas (NF-e válidas) #}
<div class="card shadow-sm mb-3 border-primary">
  <div class="card-header bg-white fw-semibold py-2 text-primary">
    <i class="bi bi-graph-up-arrow me-2"></i>Vendas – NF-e válidas
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover table-striped align-middle text-center mb-0">
        <thead class="table-primary">
          <tr>
            <th><i class="bi bi-calendar3 d-block mb-1"></i>Dia</th>
            <th><i class="bi bi-cash-coin d-block mb-1"></i>Valor total c/ IPI</th>
            <th><i class="bi bi-percent d-block mb-1"></i>Valor do ICMS</th>
            <th><i class="bi bi-basket2 d-block mb-1"></i>Valor do IPI</th>
          </tr>
        </thead>
        <tbody>
          {% if tabela_vendas_por_dia %}
            {% for linha in tabela_vendas_por_dia %}
            <tr>
              <td class="text-nowrap">{{ linha.dia }}</td>
              <td>{{ linha.valor_c_ipi|default_if_none:0|formatar_reais }}</td>
              <td>{{ linha.valor_icms|default_if_none:0|formatar_reais }}</td>
              <td>{{ linha.valor_ipi|default_if_none:0|formatar_reais }}</td>
            </tr>
            {% endfor %}
            <tr class="table-secondary fw-bold text-primary">
              <td>Total</td>
              <td>{{ totais_vendas.valor_c_ipi|default_if_none:0|formatar_reais }}</td>
              <td>{{ totais_vendas.valor_icms|default_if_none:0|formatar_reais }}</td>
              <td>{{ totais_vendas.valor_ipi|default_if_none:0|formatar_reais }}</td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-muted">Sem dados no período.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

  {# Tabela 2: Vendas – Vale #}
<div class="card shadow-sm mb-3 border-success">
  <div class="card-header bg-white fw-semibold py-2 text-success">
    <i class="bi bi-receipt me-2"></i>Vendas – Vale
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover table-striped align-middle text-center mb-0">
        <thead class="table-success">
          <tr>
            <th><i class="bi bi-building d-block mb-1"></i>Cliente</th>
            <th><i class="bi bi-currency-exchange d-block mb-1"></i>Valor Total</th>
          </tr>
        </thead>
        <tbody>
          {% if tabela_vales %}
            {% for r in tabela_vales %}
            <tr>
              <td class="text-start">{{ r.cliente }}</td>
              <td>{{ r.valor|default_if_none:0|formatar_reais }}</td>
            </tr>
            {% endfor %}
            <tr class="table-secondary fw-bold text-success">
              <td>Total</td>
              <td>{{ total_vales|default_if_none:0|formatar_reais }}</td>
            </tr>
          {% else %}
            <tr><td colspan="2" class="text-muted">Sem lançamentos “Vale” no período.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>


  {# Tabela 3: Devoluções #}
<div class="card shadow-sm mb-3 border-danger">
  <div class="card-header bg-white fw-semibold py-2 text-danger">
    <i class="bi bi-arrow-return-left me-2"></i>Devoluções
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover table-striped align-middle text-center mb-0">
        <thead class="table-danger">
          <tr>
            <th><i class="bi bi-building d-block mb-1"></i>Cliente</th>
            <th><i class="bi bi-upc-scan d-block mb-1"></i>NF-e</th>
            <th><i class="bi bi-cash-stack d-block mb-1"></i>Valor</th>
          </tr>
        </thead>
        <tbody>
          {% if tabela_devolucoes %}
            {% for r in tabela_devolucoes %}
            <tr>
              <td class="text-start">{{ r.cliente }}</td>
              <td class="text-nowrap">{{ r.nfe }}</td>
              <td>{{ r.valor|default_if_none:0|formatar_reais }}</td>
            </tr>
            {% endfor %}
            <tr class="table-secondary fw-bold text-danger">
              <td colspan="2">Total</td>
              <td>{{ total_devolucoes|default_if_none:0|formatar_reais }}</td>
            </tr>
          {% else %}
            <tr><td colspan="3" class="text-muted">Sem devoluções no período.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>


  {# TOTALIZADOR FINAL #}
<div class="card shadow-sm border-success mb-3">
  <div class="card-body py-2">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
      <div class="mb-2 mb-sm-0">
        <div class="fw-semibold text-success">
          <i class="bi bi-calculator me-2"></i>Totalizador (Vendas NF + Vales − Devoluções)
        </div>
        <div class="small text-muted">
          {{ totais_vendas.valor_c_ipi|default_if_none:0|formatar_reais }}
          + {{ total_vales|default_if_none:0|formatar_reais }}
          − {{ total_devolucoes|default_if_none:0|formatar_reais }}
        </div>
      </div>
      <div class="display-6 fw-bold text-success text-end">
        {{ totalizador|default_if_none:0|formatar_reais }}
      </div>
    </div>
  </div>
</div>


  <p class="mt-2 small text-muted">
    <i class="bi bi-info-circle me-1"></i>
    Obs.: o ICMS é calculado pela alíquota do cliente vinculado sobre a base sem IPI.
  </p>

  {# Rodapé (forçado a imprimir) #}
  <div class="formulario-rodape d-none d-print-block">
  {% include 'partials/global/_formulario_rodape.html' with numero_formulario="Faturamento" %}
</div>

</div>

<style>
  .table thead th i { opacity:.85; }
  .table thead th { vertical-align:bottom; }
  .sticky-top { top:0; z-index:2; }

  /* Layout padrão (tela) */
  .print-container { max-width:1100px; }
  .print-cards{ display:grid; grid-template-columns:1fr; gap:.5rem; }
  @media (min-width:992px){ .print-cards{ grid-template-columns:repeat(3,1fr);} }
  .kpi-number{ font-size:clamp(1.25rem,3vw,2.25rem); line-height:1.1; }
  .kpi-label{ font-size:.9rem; }

  /* Página A4 e compressão para caber em 1 folha */
  @page { size:A4 portrait; margin:10mm; }

  @media print{
    html, body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }

    .d-print-none{ display:none!important; }
    .sticky-top{ position:static!important; }  /* desativa sticky no print */
    .print-container{ padding:8px; max-width:820px; }

    .print-cards{
      display:grid!important; grid-template-columns:repeat(3,1fr)!important;
      gap:6px!important; margin-bottom:8px;
    }

    .card, .shadow-sm{ box-shadow:none!important; border:1px solid #dcdcdc; }
    .card-header{ padding:6px 10px!important; font-size:11px!important; }
    .card-body{ padding:8px 10px!important; }
    .kpi-number{ font-size:18px!important; }
    .kpi-label{ font-size:10px!important; }

    .table{ font-size:9px!important; table-layout:fixed; }
    .table th, .table td{
      padding:2px 6px!important; line-height:1.15!important; white-space:nowrap;
    }
    .table thead th{ font-size:9.5px!important; }

    .table-responsive, table, thead, tbody, tr, td, th{
      break-inside:avoid; page-break-inside:avoid;
    }
    .no-break{ break-inside:avoid; page-break-inside:avoid; }

    .mb-4{ margin-bottom:.5rem!important; }
    .mb-3{ margin-bottom:.4rem!important; }
    .mt-3{ margin-top:.4rem!important; }
    .ps-2{ padding-left:.25rem!important; }

    /* Garante que o partial do rodapé apareça mesmo com classes no próprio include */
    .formulario-rodape-wrapper, .formulario-rodape-wrapper *{ display:initial; visibility:visible; }
    .formulario-rodape-wrapper .d-print-none{ display:initial!important; }
  }
</style>
{% endblock %}
