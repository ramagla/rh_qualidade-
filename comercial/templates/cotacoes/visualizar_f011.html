{% extends 'base.html' %}

{% block title %}F011 - Formul√°rio de Pr√©-C√°lculo N¬∫ {{ precalc.numero|default:"---" }}{% endblock %}
{% load humanize %}
{% load filters_gerais %}

{% block content %}
{% include 'partials/global/_estilos_impressao.html' %}
{% include 'partials/global/_botao_impressao.html' %}
{% include 'partials/global/_styles_componentes.html' %}
{% include 'partials/global/_header_titulo.html' with titulo="F011 - Pr√©-C√°lculo de Or√ßamento" icone="bi bi-file-earmark-text" emoji="üìÑ" %}

<div class="container pdf-container">
    {% load static %}

  <!-- Cabe√ßalho do Item (Layout conforme PDF) -->
<div class="table-responsive mb-4">
    <table class="table table-bordered align-middle text-center mb-0" style="table-layout: fixed;">
      <tr>
        <!-- Coluna Logo -->
        <td style="width: 20%;">
          <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height: 70px;">
        </td>
  
        <!-- T√≠tulo Central -->
        <td style="width: 60%;">
          <div>
            <strong>PR√â-C√ÅLCULO DE OR√áAMENTO</strong><br>
            <span class="text-uppercase">CARACTERIZA√á√ÉO DE MERCADO / PRODUTO</span>
          </div>
        </td>
  
        <!-- Coluna N¬∫ Cota√ß√£o e N¬∫ Pr√©-C√°lculo -->
        <td style="width: 20%; padding: 0;">
          <table class="table table-bordered text-center mb-0">
            <tr>
              <th class="p-1">N¬∫ Cota√ß√£o</th>
            </tr>
            <tr>
              <td class="text-danger fw-bold p-1">{{ precalc.cotacao.numero|stringformat:"04d" }}</td>
            </tr>
            <tr>
              <th class="p-1">N¬∫ Pr√©-C√°lculo</th>
            </tr>
            <tr>
              <td class="text-danger fw-bold p-1">{{ precalc.numero|stringformat:"05d" }}</td>
            </tr>
            <tr>
              <td class="p-1">P√°gina <span class="pageNumber"></span> de <span class="totalPages"></span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>
  
  
  <!-- Tabela com dados do cliente e item com √≠cones -->
<div class="table-responsive">
    <table class="table table-bordered align-middle small">
      <tr>
        <th><i class="bi bi-person-badge"></i> Cliente:</th>
        <td colspan="3">{{ precalc.analise_comercial_item.item.cliente }}</td>
        <th><i class="bi bi-check2-square"></i> Requisito espec√≠fico?</th>
        <td class="text-center">
          {% if precalc.analise_comercial_item.item.requisito_especifico == False %} ‚òí N√£o ‚òê Sim
          {% elif precalc.analise_comercial_item.item.requisito_especifico == True %} ‚òê N√£o ‚òí Sim
          {% else %} ‚òê N√£o ‚òê Sim
          {% endif %}
        </td>
      </tr>
      <tr>
        <th><i class="bi bi-car-front"></i> Automotivo OEM?</th>
        <td class="text-center">
          {% with oem=precalc.analise_comercial_item.automotivo_oem|default_if_none:False %}
            {% if oem %} ‚òê N√£o ‚òí Sim
            {% else %} ‚òí N√£o ‚òê Sim
            {% endif %}
          {% endwith %}
        </td>
        <th><i class="bi bi-shield-check"></i> Item de seguran√ßa?</th>
        <td class="text-center">
          {% if precalc.analise_comercial_item.item.item_seguranca == False %} ‚òí N√£o ‚òê Sim
          {% elif precalc.analise_comercial_item.item.item_seguranca == True %} ‚òê N√£o ‚òí Sim
          {% else %} ‚òê N√£o ‚òê Sim
          {% endif %}
        </td>
        <th><i class="bi bi-file-earmark"></i> Desenho:</th>
        <td>{{ precalc.analise_comercial_item.item.codigo_desenho|default:"---" }}</td>
      </tr>
      <tr>
        <th><i class="bi bi-list-ol"></i> Revis√£o:</th>
        <td>{{ precalc.analise_comercial_item.item.revisao|default:"---" }}</td>
        <th><i class="bi bi-calendar-date"></i> Data:</th>
        <td colspan="3">{{ precalc.analise_comercial_item.item.data_revisao|date:"d/m/Y"|default:"---" }}</td>
      </tr>
      <tr>
        <th><i class="bi bi-hash"></i> N¬∫ da pe√ßa:</th>
        <td colspan="2">{{ precalc.analise_comercial_item.item.descricao|default:"---" }}</td>
        <th><i class="bi bi-tag"></i> C√≥digo Bras-Mol:</th>
        <td colspan="2">{{ precalc.analise_comercial_item.item.codigo|default:"---" }}</td>
      </tr>
      <tr>
        <th><i class="bi bi-bar-chart"></i> Consumo estimado:</th>
        <td>{{ precalc.analise_comercial_item.consumo_estimado|default:"---" }}</td>
        <th><i class="bi bi-clock-history"></i> Per√≠odo:</th>
        <td>{{ precalc.analise_comercial_item.periodo|default:"---" }}</td>
        <th><i class="bi bi-gear"></i> Capacidade produtiva?</th>
        <td class="text-center">
          {% if precalc.analise_comercial_item.capacidade_produtiva == False %} ‚òí N√£o ‚òê Sim
          {% elif precalc.analise_comercial_item.capacidade_produtiva == True %} ‚òê N√£o ‚òí Sim
          {% else %} ‚òê N√£o ‚òê Sim
          {% endif %}
        </td>
      </tr>
      <tr>
        <th><i class="bi bi-person-circle"></i> Respons√°vel:</th>
        <td colspan="5">
          {% if precalc.analise_comercial_item.usuario and precalc.analise_comercial_item.usuario.funcionario %}
            {{ precalc.analise_comercial_item.usuario.get_full_name }} /
            {{ precalc.analise_comercial_item.usuario.funcionario.cargo_atual|default:"---" }}<br>
            <i class="bi bi-calendar-event"></i> {{ precalc.analise_comercial_item.assinado_em|date:"d/m/Y H:i" }}
          {% else %}
            {{ precalc.analise_comercial_item.assinatura_nome|default:"---" }}
          {% endif %}
        </td>
      </tr>
    </table>
  </div>
  
  

  <!-- Caracteriza√ß√£o Produto -->
  <h5 class="mt-4">1. Caracteriza√ß√£o de Produto</h5>
  <div class="table-responsive">
    <table class="table table-bordered">
      <tr>
        <th>Tipo de Embalagem</th>
        <td>{{ precalc.analise_comercial_item.tipo_embalagem_obs|default:"---" }}</td>
        <th>Periodicidade</th>
        <td>{{ precalc.analise_comercial_item.periodo|default:"---" }}</td>
      </tr>
      <tr>
        <th>Requisitos Espec√≠ficos</th>
        <td>{{ precalc.analise_comercial_item.requisito_especifico|yesno:"Sim,N√£o,N√£o Aplic√°vel" }}</td>
        <th>Item de Seguran√ßa?</th>
        <td>{{ precalc.avaliacao_tecnica_item.seguranca|yesno:"Sim,N√£o,N√£o Aplic√°vel" }}</td>
      </tr>
      <tr>
        <th>Peso L√≠quido</th>
        <td>{{ precalc.materiais.first.peso_liquido|default:"---" }} kg</td>
        <th>Material</th>
        <td>{{ precalc.materiais.first.nome_materia_prima|default:"---" }}</td>
      </tr>
    </table>
  </div>

  <!-- An√°lise Comercial -->
  <h5 class="mt-5">2. An√°lise Comercial</h5>
  <div class="table-responsive">
    <table class="table table-bordered">
      {% for campo, obs in campos_obs %}
        <tr>
            <th>{{ titulos_analise|dict_get:campo }}</th>
            <td>{{ precalc.analise_comercial_item|attr:campo|yesno:"Sim,N√£o" }}</td>
          <th>Observa√ß√µes</th>
          <td>{{ precalc.analise_comercial_item|attr:obs|default:"---" }}</td>
        </tr>
      {% endfor %}
      <tr>
        <th>Conclus√£o</th>
        <td colspan="3">{{ precalc.analise_comercial_item.conclusao }}</td>
      </tr>
    </table>
  </div>

  <!-- Avalia√ß√£o T√©cnica -->
  <h5 class="mt-5">3. Avalia√ß√£o T√©cnica</h5>
  <div class="table-responsive">
    <table class="table table-bordered">
      {% for campo, obs in campos_obs_tecnica %}
        <tr>
            <th>{{ titulos_avaliacao|dict_get:campo }}</th>
            <td>{{ precalc.avaliacao_tecnica_item|attr:campo|yesno:"Sim,N√£o" }}</td>
          <th>Observa√ß√µes</th>
          <td>{{ precalc.avaliacao_tecnica_item|attr:obs|default:"---" }}</td>
        </tr>
      {% endfor %}
      <tr>
        <th>Conclus√£o</th>
        <td colspan="3">{{ precalc.avaliacao_tecnica_item.conclusao_tec }}</td>
      </tr>
    </table>
  </div>

  <!-- Servi√ßos Externos -->
  <h5 class="mt-5">4. Servi√ßos Externos</h5>
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Descri√ß√£o</th>
          <th>Fornecedor</th>
          <th>Pre√ßo/kg</th>
        </tr>
      </thead>
      <tbody>
        {% for s in precalc.servicos.all %}
          <tr>
            <td>{{ s.codigo_materia_prima }}</td>
            <td>{{ s.descricao_materia_prima }}</td>
            <td>{{ s.fornecedor }}</td>
            <td>{{ s.preco_kg|floatformat:4 }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4">Nenhum servi√ßo externo registrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ferramentas -->
  <h5 class="mt-5">5. Ferramentas</h5>
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Ferramenta</th>
          <th>Tipo</th>
          <th>Valor Unit√°rio</th>
        </tr>
      </thead>
      <tbody>
        {% for f in precalc.ferramentas_item.all %}
          <tr>
            <td>{{ f.ferramenta }}</td>
            <td>{{ f.ferramenta.tipo }}</td>
            <td>{{ f.ferramenta.valor_total|formatar_reais }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3">Nenhuma ferramenta vinculada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pre√ßo Final -->
  <h5 class="mt-5">6. Pre√ßo Final</h5>
  <div class="table-responsive">
    <table class="table table-bordered">
      <tr>
        <th>Pre√ßo Manual</th>
        <td>{{ precalc.preco_manual|formatar_reais|default:"---" }}</td>
        <th>Pre√ßo Selecionado</th>
        <td>{{ precalc.preco_selecionado|formatar_reais|default:"---" }}</td>
      </tr>
    </table>
  </div>

</div>

{% include "partials/global/_formulario_rodape.html" with numero_formulario=numero_formulario %}


<script>
    document.addEventListener("DOMContentLoaded", function () {
      const totalPages = document.querySelectorAll(".totalPages");
      const pageNumbers = document.querySelectorAll(".pageNumber");
  
      // Se estiver usando m√∫ltiplas p√°ginas, use PDF.js ou HTML2PDF
      // Aqui estamos apenas simulando P√°gina 1 de 1
      totalPages.forEach(el => el.textContent = "1");
      pageNumbers.forEach(el => el.textContent = "1");
    });
  </script>
  
{% endblock %}
