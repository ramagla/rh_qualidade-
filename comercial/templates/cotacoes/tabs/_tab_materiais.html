{% load widget_tweaks %}


<style>
  .bg-lightblue {
    background-color: #d6f0ff !important;
  }

  .bg-lightyellow {
    background-color: #fff9d6 !important;
  }
</style>

<form method="post">
  <input type="hidden" name="aba" value="materiais">
  {% csrf_token %}

  <div class="row bg-materiais p-4 rounded shadow-sm">
    <div class="col-12">
      <div class="border p-4 rounded bg-white shadow-sm">
        <h5 class="mb-4">
          <i class="bi bi-box-seam text-success me-2"></i> Matéria-Prima Utilizada
        </h5>

        <div class="alert alert-info small py-3 px-4 rounded d-flex flex-column gap-3">
  <div class="d-flex align-items-start gap-2">
    <i class="bi bi-info-circle-fill fs-5 mt-1 text-info"></i>
    <div>
      <p class="mb-1">
        O campo <strong>Peso Bruto Total</strong> é calculado automaticamente como:
        <code>Peso Bruto × Qtde Estimada</code>.
      </p>
      <p class="mb-0">
        Os campos <strong>Peso Líquido</strong> e <strong>Peso Bruto</strong> devem ser preenchidos manualmente.
      </p>
    </div>
  </div>

  <div>
    <i class="bi bi-person-fill-check text-primary me-1"></i>
    <strong class="text-primary">Compras:</strong>
    Preenchem os campos <code>Lote Mínimo</code>, <code>Entrega (dias)</code>, <code>Fornecedor</code>,
    <code>ICMS (%)</code> e <code>Preço/kg</code>.
  </div>

  <div>
    <i class="bi bi-tools text-warning me-1"></i>
    <strong class="text-warning">Técnico:</strong>
    Preenche os campos <code>Desenv. (mm)</code>, <code>Peso Líquido</code> e <code>Peso Bruto</code>.
  </div>

  <div>
    <i class="bi bi-clock text-muted me-1"></i>
    O prazo de <strong>entrega</strong> informado é contado em <strong>dias corridos</strong>.
  </div>

  <div>
    <i class="bi bi-exclamation-triangle-fill text-danger me-1"></i>
    <strong class="text-danger">Atenção:</strong>
    Caso o <strong>Peso Bruto Total</strong> seja <u>menor</u> que o <strong>Lote Mínimo</strong>, 
    a linha será destacada em vermelho para revisão.
  </div>
</div>



        {% if fs_mat.non_form_errors %}
        <div class="alert alert-danger">
          <ul class="mb-0">
            {% for error in fs_mat.non_form_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}


  
        <table class="table table-bordered align-middle table-sm">
          <thead class="table-light align-middle text-center">
  <tr>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-check-circle mb-1"></i>
        <small>Selecionar</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-upc-scan mb-1"></i>
        <small>Código</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-boxes mb-1"></i>
        <small>Lote Mín.</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-truck mb-1"></i>
        <small>Prazo</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-building mb-1"></i>
        <small>Fornecedor</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-percent mb-1"></i>
        <small>ICMS</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-currency-dollar mb-1"></i>
        <small>Preço/kg</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-rulers mb-1"></i>
        <small>Desenv.(mm)</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-box mb-1"></i>
        <small>P.Líquido</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-box mb-1"></i>
        <small>P.Bruto</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-basket-fill mb-1"></i>
        <small>P.Total</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-flag mb-1"></i>
        <small>Status</small>
      </div>
    </th>
  </tr>
</thead>


          <tbody>
{% for form in fs_mat.forms %}
<tr>
{{ form.id }}
<td class="text-center align-middle"><input type="radio" name="material_selecionado" value="{{ form.prefix }}" class="form-check-input mt-1" {% if form.instance.selecionado %}checked{% endif %}></td>
<td>{{ form.codigo|add_class:"form-control form-control-sm codigo-input" }}</td>
<td class="bg-lightblue">
  {{ form.lote_minimo|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:decimal"|attr:"data-decimal:2"|attr:"autocomplete:off"|attr:"placeholder:Ex: 100,00" }}
</td>
<td class="bg-lightblue">
  {{ form.entrega_dias|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:numeric"|attr:"pattern:^\d{1,5}$"|attr:"autocomplete:off"|attr:"placeholder:Ex: 5" }}
</td>
<td class="bg-lightblue">{{ form.fornecedor|add_class:"form-select form-select-sm" }}</td>
<td class="bg-lightblue">
  {{ form.icms|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:decimal"|attr:"data-decimal:2"|attr:"autocomplete:off"|attr:"placeholder:Ex: 18,00" }}
</td>
<td class="bg-lightblue">
{{ form.preco_kg|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:decimal"|attr:"step:any"|attr:"data-decimal:4"|attr:"autocomplete:off"|attr:"placeholder:Ex: 12,3456" }}
</td>
<td class="bg-lightyellow">{{ form.desenvolvido_mm|add_class:"form-control form-control-sm"|attr:"placeholder:Desenv. (mm)" }}</td>
<td class="bg-lightyellow">{{ form.peso_liquido|add_class:"form-control form-control-sm"|attr:"placeholder:Ex: 1,234" }}</td>
<td class="bg-lightyellow">{{ form.peso_bruto|add_class:"form-control form-control-sm"|attr:"placeholder:Ex: 1,500" }}</td>
<td class="bg-lightyellow text-end">{{ form.peso_bruto_total|add_class:"form-control form-control-sm text-end" }}</td>
<td class="text-center">{% if form.instance.pk and form.instance.preco_kg %}<span class="badge bg-success">OK</span>{% else %}<span class="badge bg-warning text-dark">Aguardando</span>{% endif %}</td>
</tr>
{% endfor %}
</tbody>

        </table>

        {{ fs_mat.management_form }}

        <div class="mb-3 mt-3">
<label for="{{ form_precalculo.observacoes_materiais.id_for_label }}" class="form-label">
<i class="bi bi-chat-left-text me-1 text-muted"></i> Observações Gerais
</label>
{{ form_precalculo.observacoes_materiais|add_class:"form-control"|attr:"placeholder:Ex: Informe aqui detalhes ou observações relevantes…" }}
</div>

        
        
        
        <div>
          {% if materiais_respondidos %}
            <button type="submit" name="form_materiais_submitted" class="btn btn-primary">
              <i class="bi bi-save me-1"></i> Salvar
            </button>
          {% else %}
            <button type="submit" name="form_materiais_submitted" class="btn btn-success">
              <i class="bi bi-send-check me-1"></i> Salvar e Enviar para Cotação
            </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</form>
<script>
(function(){
  function normalizePtBR(s){s=(s||"").toString().trim().replace(/\s+/g,"");if(!s)return"";if(s.includes(",")&&s.includes("."))s=s.replace(/\./g,"").replace(",",".");else if(s.includes(","))s=s.replace(",",".");return s;}
  function quantizeStringDecimal(s,places){s=normalizePtBR(s);if(!s)return"";let sign="";if(s[0]==="-"||s[0]==="+"){sign=s[0]==="-"?"-":"";s=s.slice(1);}let a=s.split(".");let intp=a[0]||"0";let frac=a[1]||"";intp=intp.replace(/^0+(?=\d)/,"");while(frac.length<places)frac+="0";if(frac.length>places){const cut=frac.slice(0,places);const rest=frac[places];if(rest>="5"){let carry=1;let out=cut.split("");for(let i=out.length-1;i>=0;i--){let d=out[i].charCodeAt(0)-48+carry;if(d>=10){out[i]=String.fromCharCode(48+(d-10));carry=1;}else{out[i]=String.fromCharCode(48+d);carry=0;break;}}if(carry===1){out=new Array(places).fill("0");let ii=intp.split("");let k=ii.length-1;carry=1;for(;k>=0;k--){let d=ii[k].charCodeAt(0)-48+carry;if(d>=10){ii[k]=String.fromCharCode(48+(d-10));carry=1;}else{ii[k]=String.fromCharCode(48+d);carry=0;break;}}if(carry===1)ii.unshift("1");intp=ii.join("");}frac=out.join("");}else{frac=cut;}}if(places===0)return sign+(intp||"0");return sign+(intp||"0")+"."+(frac||"0".repeat(places));}

  document.addEventListener("DOMContentLoaded",function(){
    const form=document.querySelector("form[method='post']");if(!form)return;

    form.querySelectorAll("input[name$='-preco_kg']").forEach(inp=>{
      inp.addEventListener("blur",function(){const places=parseInt(inp.getAttribute("data-decimal")||"4",10);const out=quantizeStringDecimal(inp.value,places);inp.value=out?out.replace(".",","):"";});
    });

    form.addEventListener("submit",function(){
      form.querySelectorAll("input[name$='-preco_kg']").forEach(inp=>{const places=parseInt(inp.getAttribute("data-decimal")||"4",10);inp.value=quantizeStringDecimal(inp.value,places);});
      form.querySelectorAll("input[name$='-icms'], input[name$='-peso_liquido'], input[name$='-peso_bruto'], input[name$='-peso_bruto_total']").forEach(inp=>{inp.value=normalizePtBR(inp.value);});
    },{capture:true});
  });
})();
</script>


<!-- Preenchimento automático de código -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dataDiv = document.querySelector("#precalculo-data");
    const itemId = dataDiv?.dataset.itemId;
    const codigoInputs = document.querySelectorAll(".codigo-input");

    if (itemId) {
      fetch(`/comercial/ajax/codigo-materia-prima/?item_id=${itemId}`)
        .then(response => response.json())
        .then(data => {
          if (data.sucesso && data.codigo) {
            codigoInputs.forEach(input => {
              if (!input.value) input.value = data.codigo;
            });
          }
        });
    }
  });
</script>

<!-- Cálculo automático do Peso Bruto Total -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const valorQtde = "{{ form_analise.instance.qtde_estimada|default_if_none:'0' }}".replace(",", ".");
    const qtdeEstimada = parseFloat(valorQtde) || 0;
    const linhas = document.querySelectorAll("tbody tr");

    linhas.forEach(row => {
      const pesoBrutoInput = row.querySelector("input[name$='-peso_bruto']");
      const pesoBrutoTotalInput = row.querySelector("input[name$='-peso_bruto_total']");

      if (pesoBrutoInput && pesoBrutoTotalInput) {
        const atualizarPesoBrutoTotal = () => {
          const pesoBruto = parseFloat(pesoBrutoInput.value.replace(",", ".")) || 0;

          // Somente calcula se qtdeEstimada for maior que zero
          if (qtdeEstimada > 0 && pesoBruto > 0) {
            const resultado = pesoBruto * qtdeEstimada;
pesoBrutoTotalInput.value = resultado.toFixed(10).replace(".", ",");
          } else {
            // Se já houver valor preenchido vindo do backend, mantém
            const valorOriginal = pesoBrutoTotalInput.defaultValue || pesoBrutoTotalInput.value;
            if (valorOriginal) {
              pesoBrutoTotalInput.value = valorOriginal;
            }
          }
        };

        // Executa no carregamento
        atualizarPesoBrutoTotal();

        // Atualiza ao digitar
        pesoBrutoInput.addEventListener("input", atualizarPesoBrutoTotal);
      }
    });
  });
</script>

<!-- Cópia de campos técnicos para todas as linhas -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const qtdeEstimada = parseFloat("{{ form_analise.instance.qtde_estimada|default_if_none:'0' }}".replace(",", ".")) || 0;
    const linhas = document.querySelectorAll("tbody tr");

    if (linhas.length < 2) return;

    const primeira = linhas[0];
    const campoDesenv = primeira.querySelector("input[name$='-desenvolvido_mm']");
    const campoPesoLiq = primeira.querySelector("input[name$='-peso_liquido']");
    const campoPesoBruto = primeira.querySelector("input[name$='-peso_bruto']");
    const campoPesoBrutoTotal = primeira.querySelector("input[name$='-peso_bruto_total']");

    function copiarCamposParaOutrasLinhas() {
      const valorDesenv = campoDesenv?.value;
      const valorPesoLiq = campoPesoLiq?.value;
      const valorPesoBruto = campoPesoBruto?.value;
      const bruto = parseFloat(valorPesoBruto?.replace(",", ".")) || 0;
      const totalCalculado = toPlain(bruto * qtdeEstimada, 10).replace(".", ",");

      for (let i = 1; i < linhas.length; i++) {
        const linha = linhas[i];

        const inputDesenv = linha.querySelector("input[name$='-desenvolvido_mm']");
        const inputPesoLiq = linha.querySelector("input[name$='-peso_liquido']");
        const inputPesoBruto = linha.querySelector("input[name$='-peso_bruto']");
        const inputPesoBrutoTotal = linha.querySelector("input[name$='-peso_bruto_total']");

        if (inputDesenv && valorDesenv !== undefined) inputDesenv.value = valorDesenv;
        if (inputPesoLiq && valorPesoLiq !== undefined) inputPesoLiq.value = valorPesoLiq;

        if (inputPesoBruto && valorPesoBruto !== undefined) inputPesoBruto.value = valorPesoBruto;
        if (inputPesoBrutoTotal) {
          inputPesoBrutoTotal.removeAttribute("readonly");
          inputPesoBrutoTotal.value = totalCalculado;
          inputPesoBrutoTotal.setAttribute("readonly", "readonly");
        }
      }
    }

    if (campoDesenv) campoDesenv.addEventListener("input", copiarCamposParaOutrasLinhas);
    if (campoPesoLiq) campoPesoLiq.addEventListener("input", copiarCamposParaOutrasLinhas);
    if (campoPesoBruto) campoPesoBruto.addEventListener("input", copiarCamposParaOutrasLinhas);
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const qtdeEstimada = parseFloat("{{ form_analise.instance.qtde_estimada|default_if_none:'0' }}".replace(",", ".")) || 0;

    document.querySelectorAll("tbody tr").forEach(row => {
      const brutoInput = row.querySelector("input[name$='-peso_bruto']");
      const totalInput = row.querySelector("input[name$='-peso_bruto_total']");

      if (brutoInput && totalInput) {
        const atualizar = () => {
          const bruto = parseFloat(brutoInput.value.replace(",", ".")) || 0;
          const resultadoCalculado = (bruto * qtdeEstimada).toFixed(3).replace(".", ",");

          totalInput.removeAttribute("readonly");

          // 🔒 Só atualiza se estiver vazio ou 0,000
          if (!totalInput.value || totalInput.value === "0,000") {
            totalInput.value = resultadoCalculado;
          }

          totalInput.setAttribute("readonly", "readonly");
        };

        brutoInput.addEventListener("input", atualizar);
        atualizar();  // inicial
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    function verificarLotes() {
      document.querySelectorAll("tbody tr").forEach(row => {
        const loteMinInput = row.querySelector("input[name$='-lote_minimo']");
        const pesoTotalInput = row.querySelector("input[name$='-peso_bruto_total']");

        if (loteMinInput && pesoTotalInput) {
          const loteMin = parseFloat(loteMinInput.value.replace(",", ".")) || 0;
          const pesoTotal = parseFloat(pesoTotalInput.value.replace(",", ".")) || 0;

          // Remove alerta anterior
          row.classList.remove("table-danger");
          loteMinInput.title = "";
          pesoTotalInput.title = "";

          if (pesoTotal > 0 && loteMin > 0 && pesoTotal < loteMin) {
            row.classList.add("table-danger");
            const msg = `⚠ Peso Total (${pesoTotal}) menor que Lote Mínimo (${loteMin})`;
            loteMinInput.title = msg;
            pesoTotalInput.title = msg;
          }
        }
      });
    }

    // Rodar ao carregar
    verificarLotes();

    // Rodar ao alterar lote mínimo ou peso total
    document.querySelectorAll("input[name$='-lote_minimo'], input[name$='-peso_bruto_total']").forEach(input => {
      input.addEventListener("input", verificarLotes);
    });
  });
</script>

<script>
  (function () {
    function toPlainString(val, maxDecimals = 10) {
      if (val === null || val === undefined) return "";
      const n = Number(String(val).replace(",", "."));
      if (!Number.isFinite(n)) return "";
      let s = n.toFixed(Math.min(maxDecimals + 5, 20));
      if (s.includes(".")) {
        const [i, f] = s.split(".");
        const frac = f.slice(0, maxDecimals).replace(/0+$/, "");
        s = frac ? `${i}.${frac}` : i;
      }
      return s;
    }

    function normalizarCamposMateriais(scope) {
      // ⚠️ SOMENTE CAMPOS TÉCNICOS – NUNCA mexer em preco_kg, icms, lote_minimo
      const seletores = [
        "input[name$='-desenvolvido_mm']",
        "input[name$='-peso_liquido']",
        "input[name$='-peso_bruto']",
        "input[name$='-peso_bruto_total']",
      ].join(",");

      const campos = scope.querySelectorAll(seletores);
      campos.forEach((inp) => {
        const aplicar = (forcar = false) => {
          const raw = (inp.value || "").trim();
          if (!raw) return;

          // normaliza apenas quando veio em notação científica ou no blur
          if (/[eE]-?\d+/.test(raw) || forcar) {
            const n = Number(raw.replace(",", "."));
            if (!Number.isFinite(n)) return;
            let s = toPlainString(n, 10).replace(".", ",");
            inp.value = s;
          }
        };

        aplicar(false);
        inp.addEventListener("blur", () => aplicar(true));
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const container = document.querySelector(".bg-materiais")?.closest("form") || document;
      normalizarCamposMateriais(container);
    });
  })();
</script>

<script>
  // Utilitário único para 10 casas decimais
  function toPlain(val, maxDecimals = 10) {
    const n = Number(String(val).replace(",", "."));
    if (!Number.isFinite(n)) return "";
    let s = n.toFixed(Math.min(maxDecimals + 5, 20));
    if (s.includes(".")) {
      const [i, f] = s.split(".");
      const frac = f.slice(0, maxDecimals).replace(/0+$/, "");
      s = frac ? i + "." + frac : i;
    }
    return s;
  }

  document.addEventListener("DOMContentLoaded", function () {
    const qtde = parseFloat("{{ form_analise.instance.qtde_estimada|default_if_none:'0' }}".replace(",", ".")) || 0;

    // Calcula P.Total sem truncar e não sobrescreve backend
    document.querySelectorAll("tbody tr").forEach(row => {
      const bruto = row.querySelector("input[name$='-peso_bruto']");
      const total = row.querySelector("input[name$='-peso_bruto_total']");
      if (!bruto || !total) return;

      const atualizar = () => {
        const v = parseFloat((bruto.value || "").replace(",", ".")) || 0;
        const res = v * qtde;
        if (!total.value || total.value === "0" || total.value === "0,000" || total.value === "0,0000000000") {
          total.value = toPlain(res, 10).replace(".", ",");
        }
      };
      atualizar();
      bruto.addEventListener("input", atualizar);
    });

    // Normalização geral com 10 casas para todos (inclusive total)
    document.querySelectorAll("input[name$='-desenvolvido_mm'],input[name$='-peso_liquido'],input[name$='-peso_bruto'],input[name$='-peso_bruto_total']").forEach(inp => {
      const aplicar = (forcar = false) => {
        const raw = (inp.value || "").trim();
        if (!raw) return;
        if (/[eE]-?\d+/.test(raw) || forcar) {
          inp.value = toPlain(raw, 10).replace(".", ",");
        }
      };
      aplicar(false);
      inp.addEventListener("blur", () => aplicar(true));
    });

    // Não copiar valores do 1º item se os demais já têm dados do backend
    const linhas = document.querySelectorAll("tbody tr");
    if (linhas.length >= 2) {
      const p = linhas[0];
      const vDes = p.querySelector("input[name$='-desenvolvido_mm']")?.value ?? "";
      const vLiq = p.querySelector("input[name$='-peso_liquido']")?.value ?? "";
      const vBru = p.querySelector("input[name$='-peso_bruto']")?.value ?? "";
      for (let i = 1; i < linhas.length; i++) {
        const r = linhas[i];
        const d = r.querySelector("input[name$='-desenvolvido_mm']");
        const l = r.querySelector("input[name$='-peso_liquido']");
        const b = r.querySelector("input[name$='-peso_bruto']");
        if (d && !d.value && vDes) d.value = vDes;
        if (l && !l.value && vLiq) l.value = vLiq;
        if (b && !b.value && vBru) b.value = vBru;
      }
    }
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("input[name$='-preco_kg'], input[name$='-icms'], input[name$='-lote_minimo']").forEach((el, i) => {
      el.addEventListener("focus",  () => console.log(`[UI] focus  #${i} ${el.name} = '${el.value}'`));
      el.addEventListener("input",  () => console.log(`[UI] input  #${i} ${el.name} = '${el.value}'`));
      el.addEventListener("blur",   () => console.log(`[UI] blur   #${i} ${el.name} = '${el.value}'`));
      el.form?.addEventListener("submit", () => {
        console.log(`[UI] submit #${i} ${el.name} (FINAL) = '${el.value}'`);
      });
    });
  });
</script>
