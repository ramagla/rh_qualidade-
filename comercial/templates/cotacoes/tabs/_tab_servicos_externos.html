{% load widget_tweaks %}

<form method="post" enctype="multipart/form-data">
  <input type="hidden" name="aba" value="servicos">
  {% csrf_token %}

  <div class="row bg-servicos p-4 rounded shadow-sm">
    <div class="col-12">
      <div class="border p-4 rounded bg-white shadow-sm">
        <h5 class="mb-4">
          <i class="bi bi-tools text-danger me-2"></i> Serviços Externos (Tratamento)
        </h5>

        <div class="alert alert-info d-flex flex-column gap-2 small">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-info-circle-fill"></i>
            O campo <strong>Peso Bruto</strong> é calculado automaticamente como: 
            <code>Peso Líquido × Qtde Estimada</code>.
          </div>
          <div>
            <strong class="text-primary">Compras:</strong> Preenchem os campos <code>Lote Mínimo</code>, <code>Entrega (dias)</code>, <code>Fornecedor</code>, <code>ICMS (%)</code> e <code>Preço/kg</code>.
          </div>
          <div>
            <strong class="text-warning">Técnico:</strong> Preenche os campos <code>Desenv. (mm)</code>, <code>Peso Líquido</code> e <code>Peso Bruto</code>.
          </div>
        </div>

        {% if fs_sev.non_form_errors %}
          <div class="alert alert-danger">
            <ul class="mb-0">
              {% for error in fs_sev.non_form_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <table class="table table-bordered align-middle table-sm">
          <thead class="table-light text-center align-middle">
            <tr>
              <th><i class="bi bi-check2-square"></i> Selecionar</th>
              <th><i class="bi bi-box"></i> Insumo</th>
              <th><i class="bi bi-boxes"></i> Lote Mínimo</th>
              <th><i class="bi bi-truck"></i> Entrega (dias)</th>
              <th><i class="bi bi-building"></i> Fornecedor</th>
              <th><i class="bi bi-percent"></i> ICMS (%)</th>
              <th><i class="bi bi-currency-dollar"></i> Preço/kg</th>
              <th><i class="bi bi-rulers"></i> Desenv. (mm)</th>
              <th><i class="bi bi-scale"></i> Peso Líquido</th>
              <th><i class="bi bi-scale"></i> Peso Bruto</th>
              <th><i class="bi bi-clipboard-check"></i> Status</th>
            </tr>
          </thead>
          <tbody>
            {% for form in fs_sev.forms %}
              <tr>
                {{ form.id }}
                <td class="text-center align-middle">
                  <input type="radio"
                         name="servico_selecionado"
                         value="{{ form.prefix }}"
                         class="form-check-input mt-1"
                         {% if form.instance.selecionado %}checked{% endif %}>
                </td>
                <td>
                  {{ form.instance.insumo.materia_prima.codigo }}
                  {{ form.insumo }}
                </td>
                <td class="bg-lightblue">{{ form.lote_minimo|add_class:"form-control form-control-sm" }}</td>
                <td class="bg-lightblue">{{ form.entrega_dias|add_class:"form-control form-control-sm" }}</td>
                <td class="bg-lightblue">{{ form.fornecedor|add_class:"form-select form-select-sm" }}</td>
                <td class="bg-lightblue">{{ form.icms|add_class:"form-control form-control-sm" }}</td>
                <td class="bg-lightblue">{{ form.preco_kg|add_class:"form-control form-control-sm" }}</td>
                <td class="bg-lightyellow">{{ form.desenvolvido_mm|add_class:"form-control form-control-sm" }}</td>
                <td class="bg-lightyellow">{{ form.peso_liquido|add_class:"form-control form-control-sm" }}</td>
                <td class="bg-lightyellow">{{ form.peso_bruto|add_class:"form-control form-control-sm" }}</td>
                <td class="text-center">
                  {% if form.instance.pk and form.instance.preco_kg %}
                    <span class="badge bg-success">OK</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Aguardando</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {{ fs_sev.management_form }}

        <div class="mb-3 mt-3">
          <label for="id_observacoes_servicos" class="form-label">
            <i class="bi bi-chat-left-text me-1 text-muted"></i> Observações Gerais
          </label>
          {{ form_precalculo.observacoes_servicos|add_class:"form-control ckeditor" }}
        </div>
        <input type="hidden" name="form_servicos_submitted" value="1">

        <div class="text-end mt-3">
          {% if servicos_respondidos %}
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1"></i> Salvar
            </button>
          {% else %}
            <button type="submit" class="btn btn-success">
              <i class="bi bi-send-check me-1"></i> Salvar e Enviar para Cotação
            </button>
          {% endif %}
        </div>
        
      </div>
    </div>
  </div>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const qtdeEstimada = parseFloat("{{ form_analise.instance.qtde_estimada|default_if_none:'0' }}".replace(",", ".")) || 0;
    document.querySelectorAll("tbody tr").forEach(row => {
      const liquido = row.querySelector("input[name$='-peso_liquido']");
      const bruto = row.querySelector("input[name$='-peso_bruto']");
      if (liquido && bruto) {
        const atualizar = () => {
          const val = parseFloat(liquido.value.replace(",", ".")) || 0;
          bruto.value = (val * qtdeEstimada).toFixed(3);
        };
        liquido.addEventListener("input", atualizar);
        atualizar();
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const linhas = document.querySelectorAll("tbody tr");
    if (linhas.length < 2) return;
    const primeira = linhas[0];
    const campoDesenv = primeira.querySelector("input[name$='-desenvolvido_mm']");
    const campoPesoLiq = primeira.querySelector("input[name$='-peso_liquido']");

    function copiarValores() {
      const valDesenv = campoDesenv.value;
      const valPesoLiq = campoPesoLiq.value;
      linhas.forEach((row, idx) => {
        if (idx === 0) return;
        const d = row.querySelector("input[name$='-desenvolvido_mm']");
        const l = row.querySelector("input[name$='-peso_liquido']");
        const b = row.querySelector("input[name$='-peso_bruto']");
        if (d) d.value = valDesenv;
        if (l) l.value = valPesoLiq;
        if (b) {
          const liq = parseFloat(valPesoLiq.replace(",", ".")) || 0;
          b.value = (liq * qtdeEstimada).toFixed(3);
        }
      });
    }

    campoDesenv.addEventListener("input", copiarValores);
    campoPesoLiq.addEventListener("input", copiarValores);
  });
</script>