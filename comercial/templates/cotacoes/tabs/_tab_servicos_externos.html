{% load widget_tweaks %}
<style>
  .bg-lightblue {
    background-color: #d6f0ff !important;
  }

  .bg-lightyellow {
    background-color: #fff9d6 !important;
  }
</style>

<form method="post" enctype="multipart/form-data" novalidate>
  <input type="hidden" name="aba" value="servicos">
  {% csrf_token %}

  <div class="row bg-servicos p-4 rounded shadow-sm">
    <div class="col-12">
      <div class="border p-4 rounded bg-white shadow-sm">
        <h5 class="mb-4">
          <i class="bi bi-tools text-danger me-2"></i> Serviços (Tratamento)
        </h5>

        <div class="alert alert-info d-flex flex-column gap-2 small">
  <div class="d-flex align-items-center gap-2">
    <i class="bi bi-info-circle-fill"></i>
    O campo <strong>Peso Bruto</strong> é calculado automaticamente como: 
    <code>Peso Líquido × Qtde Estimada</code>.
  </div>

  <div class="d-flex align-items-start gap-2">
    <i class="bi bi-exclamation-triangle-fill text-warning"></i>
    <div>
      <strong>Regra de Lote Mínimo:</strong>
      Se <code>Peso Total × Preço/kg</code> for menor que <code>Lote Mínimo</code>, o valor do serviço considerado será o <u>Lote Mínimo</u>.
      Ex.: se <code>2,245 kg × 3,40</code> resultar em <code>7,63</code> e o <code>Lote Mínimo</code> for <code>110,00</code>, será utilizado <code>110,00</code>.
    </div>
  </div>

  <div>
    <strong class="text-primary">Compras:</strong> Preenchem os campos <code>Lote Mínimo</code>, <code>Entrega (dias)</code>, <code>Fornecedor</code>, <code>ICMS (%)</code> e <code>Preço/kg</code>.
  </div>
  <div>
    <strong class="text-warning">Técnico:</strong> Preenche os campos <code>Desenv. (mm)</code>, <code>Peso Líquido</code> e <code>Peso Bruto</code>.
  </div>
</div>


        {% if fs_sev.non_form_errors %}
          <div class="alert alert-danger">
            <ul class="mb-0">
              {% for error in fs_sev.non_form_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% regroup fs_sev.forms by instance.insumo as insumos_agrupados %}

{% for grupo in insumos_agrupados %}
  <div class="mt-4">
    <h6 class="text-primary">
      <i class="bi bi-tools me-1"></i> Insumo: {{ grupo.grouper }}
    </h6>

    <table class="table table-bordered align-middle table-sm">
      <thead class="table-light align-middle text-center">
  <tr>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-check-circle mb-1"></i>
        <small>Selecionar</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-upc-scan mb-1"></i>
        <small>Código</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-boxes mb-1"></i>
        <small>Lote Mín.</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-truck mb-1"></i>
        <small>Prazo</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-building mb-1"></i>
        <small>Fornecedor</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-percent mb-1"></i>
        <small>ICMS</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-currency-dollar mb-1"></i>
        <small>Preço/kg</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-rulers mb-1"></i>
        <small>Desenv. (mm)</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-box  mb-1"></i>
        <small>P.Líquido</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-box mb-1"></i>
        <small>P.Bruto</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-basket-fill mb-1"></i>
        <small>P.Total</small>
      </div>
    </th>
    <th>
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-flag mb-1"></i>
        <small>Status</small>
      </div>
    </th>
  </tr>
</thead>

      <tbody>
        {% for form in grupo.list %}
          <tr>
            {{ form.id }}
            <td class="text-center align-middle">
              <input type="radio"
                     name="selecionado_insumo_{{ form.instance.insumo.id }}"
                     value="{{ form.prefix }}"
                     class="form-check-input mt-1"
                     {% if form.instance.selecionado %}checked{% endif %}>
            </td>
            <td>
  {{ form.codigo_materia_prima|add_class:"form-control form-control-sm codigo-input"|attr:"readonly:readonly" }}
  {{ form.insumo }} 
</td>

            <td class="bg-lightblue">
              {{ form.lote_minimo|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:decimal"|attr:"data-decimal:2"|attr:"autocomplete:off" }}
            </td>
            <td class="bg-lightblue">
              {{ form.entrega_dias|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:numeric"|attr:"pattern:^\d{1,5}$"|attr:"autocomplete:off" }}
            </td>
            <td class="bg-lightblue">{{ form.fornecedor|add_class:"form-select form-select-sm" }}</td>
<td class="bg-lightblue">
  {{ form.icms|add_class:"form-control form-control-sm text-end"|attr:"type:text"|attr:"inputmode:decimal"|attr:"data-decimal:2"|attr:"autocomplete:off" }}
</td>
<td class="bg-lightblue">
  {{ form.preco_kg |add_class:"form-control form-control-sm text-end" |attr:"type:text"|attr:"inputmode:decimal"|attr:"data-decimal:4"|attr:"autocomplete:off" }}
</td>
            <td class="bg-lightyellow">{{ form.desenvolvido_mm|add_class:"form-control form-control-sm" }}</td>
            <td class="bg-lightyellow">{{ form.peso_liquido|add_class:"form-control form-control-sm" }}</td>
            <td class="bg-lightyellow">{{ form.peso_bruto|add_class:"form-control form-control-sm" }}</td>
            <td class="bg-lightyellow">
  {{ form.peso_liquido_total|add_class:"form-control form-control-sm text-end peso-liquido-total"|attr:"readonly:readonly" }}
</td>

            <td class="text-center">
              {% if form.instance.pk and form.instance.preco_kg %}
                <span class="badge bg-success">OK</span>
              {% else %}
                <span class="badge bg-warning text-dark">Aguardando</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endfor %}


        {{ fs_sev.management_form }}

        <div class="mb-3 mt-3">
          <label for="{{ form_precalculo.observacoes_servicos.id_for_label }}" class="form-label">
            <i class="bi bi-chat-left-text me-1 text-muted"></i> Observações Gerais
          </label>
          {{ form_precalculo.observacoes_servicos|add_class:"form-control" }}
        </div>
        
        <input type="hidden" name="form_servicos_submitted" value="1">

        <div class="text-end mt-3">
          {% if servicos_respondidos %}
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1"></i> Salvar
            </button>
          {% else %}
            <button type="submit" class="btn btn-success">
              <i class="bi bi-send-check me-1"></i> Salvar e Enviar para Cotação
            </button>
          {% endif %}
        </div>
        
      </div>
    </div>
  </div>
</form>
<script>
document.addEventListener("DOMContentLoaded", function(){
  const form = document.querySelector("form[method='post']");
  if(form){
    form.addEventListener("submit", function(e){
      const fd = new FormData(form);
      const keys = Array.from(fd.keys());
      console.group("%c[DEBUG][SERVICOS] Submit","color:blue;font-weight:bold");
      console.log("Total campos:", keys.length);
      console.log("Sample keys:", keys.slice(0,30));
      console.log("Campos críticos:", {
        lote_minimo: fd.get("fs_sev-0-lote_minimo"),
        entrega_dias: fd.get("fs_sev-0-entrega_dias"),
        fornecedor: fd.get("fs_sev-0-fornecedor"),
        icms: fd.get("fs_sev-0-icms"),
        preco_kg: fd.get("fs_sev-0-preco_kg")
      });
      console.groupEnd();
    }, {capture:true});
  }
});
</script>
<style>
  input[readonly].form-control-sm {
    background-color: #f8f9fa;
    font-style: italic;
  }
</style>



<!-- Cálculo dinâmico do Peso Líquido Total ao alterar individualmente -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const qtdeEstimada = parseFloat("{{ form_analise.instance.qtde_estimada|default_if_none:'0' }}".replace(",", ".")) || 0;

    document.querySelectorAll("tbody tr").forEach(row => {
      const liquidoInput = row.querySelector("input[name$='-peso_liquido']");
      const totalInput = row.querySelector("input[name$='-peso_liquido_total']");

      if (liquidoInput && totalInput) {
        const atualizar = () => {
          const liquido = parseFloat(liquidoInput.value.replace(",", ".")) || 0;
          const resultado = liquido * qtdeEstimada;
          totalInput.removeAttribute("readonly");
          totalInput.value = resultado.toFixed(10).replace(".", ",");
          totalInput.setAttribute("readonly", "readonly");
        };

        liquidoInput.addEventListener("input", atualizar);
        atualizar();  // inicial
      }
    });
  });
</script>

<!-- …(código atual da aba Serviços, até o último <script> existente)… -->

<!-- Normalização: remove notação científica e aplica decimal “plano” com vírgula -->
<script>
  (function () {
    function toPlainString(val, maxDecimals = 10) {
      if (val === null || val === undefined) return "";
      const n = Number(String(val).replace(",", "."));
      if (!Number.isFinite(n)) return "";

      let s = n.toFixed(Math.min(maxDecimals + 5, 20));
      if (s.includes(".")) {
        const [i, f] = s.split(".");
        const frac = f.slice(0, maxDecimals).replace(/0+$/, "");
        s = frac ? `${i}.${frac}` : i;
      }
      return s;
    }

    function normalizarCamposServicos(scope) {
      const seletores = [
        "input[name$='-desenvolvido_mm']",
        "input[name$='-peso_liquido']",
        "input[name$='-peso_bruto']",
        "input[name$='-preco_kg']",
        "input[name$='-icms']",
        "input[name$='-peso_liquido_total']",
      ].join(",");

      const campos = scope.querySelectorAll(seletores);
      campos.forEach((inp) => {
        const aplicar = (forcar = false) => {
          const raw = (inp.value || "").trim();
          if (!raw) return;

          if (/[eE]-?\d+/.test(raw) || forcar) {
            const n = Number(raw.replace(",", "."));
            if (!Number.isFinite(n)) return;

            const casas = 10;
            let s = toPlainString(n, casas).replace(".", ",");
            inp.value = s;
          }
        };

        aplicar(false);
        inp.addEventListener("blur", () => aplicar(true));
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const container = document.querySelector(".bg-servicos")?.closest("form") || document;
      normalizarCamposServicos(container);
    });
  })();
</script>


