{% extends 'base.html' %}

{% block title %}Itens de Pr√©-C√°lculo - Cota√ß√£o #{{ cotacao.numero }}{% endblock %}
{% load humanize %}
{% load filters_gerais %}

{% block content %}
{% load custom_filters %}

{% include "partials/global/_styles_componentes.html" %}

<div class="container-fluid mt-5">

  <div class="text-center mb-4 border-bottom pb-2">
    <h2 class="m-0">
      <i class="bi bi-calculator text-primary me-2"></i>
      Itens de Pr√©-C√°lculo da Cota√ß√£o <strong>#{{ cotacao.numero }}</strong>
    </h2>
  </div>
    {% include "partials/global/_toast_mensagens.html" %}
  {% include "partials/global/_estilos_botoes_acoes.html" %}

  <!-- Bot√µes -->
  <div class="d-flex justify-content-end flex-wrap gap-2 mb-4">
    <a href="{% url 'lista_cotacoes' %}" class="btn btn-importar-personalizado d-inline-flex align-items-center">
    <i class="bi bi-arrow-left-circle-fill me-2"></i>
    Voltar √†s Cota√ß√µes
  </a>
 {% if request.user|has_permission:"comercial.add_precalculo" %}
      <a href="{% url 'criar_precalculo' cotacao.id %}" class="btn btn-cadastrar-personalizado d-inline-flex align-items-center">
      <i class="bi bi-plus-circle-fill me-2"></i>
      Novo Item
    </a>
      {% if request.user|has_permission:"comercial.gerar_proposta" %}

       <a href="#" class="btn btn-cadastrar-personalizado d-inline-flex align-items-center"
   data-bs-toggle="modal" data-bs-target="#modalGerarProposta"
   style="background: linear-gradient(135deg, #ffc107, #ffca2c); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.25);">
  <i class="bi bi-file-earmark-richtext me-2"></i>
  Gerar Proposta
</a>

      {% endif %}

      {% if request.user|has_permission:"comercial.add_precalculo" %}
         <a href="#" class="btn btn-importar-personalizado d-inline-flex align-items-center" style="background: linear-gradient(135deg, #6f42c1, #5a32a3); box-shadow: 0 4px 12px rgba(111, 66, 193, 0.25);" data-bs-toggle="modal" data-bs-target="#modalDuplicarPrecalc">
      <i class="bi bi-files me-2"></i>
      Duplicar Pr√©-C√°lculo
    </a>
      {% endif %}

      <!-- Modal Gerar Proposta -->
<div class="modal fade" id="modalGerarProposta" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="post" action="{% url 'gerar_proposta' cotacao.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gerar Carta Proposta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Selecione os pr√©-c√°lculos que far√£o parte da proposta:</p>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
  <tr class="align-middle text-center">
    <th>
      <i class="bi bi-check-square text-primary"></i><br>
      <small>Selecionar</small>
    </th>
    <th>
      <i class="bi bi-hash text-primary"></i><br>
      <small>N¬∫</small>
    </th>
    <th>
      <i class="bi bi-upc-scan text-primary"></i><br>
      <small>C√≥digo</small>
    </th>
    <th class="text-center align-middle">
  <div class="d-flex flex-column align-items-center">
    <i class="bi bi-diagram-3 mb-1"></i>
    <small>Roteiro</small>
  </div>
</th>

    <th>
      <i class="bi bi-currency-dollar text-primary"></i><br>
      <small>Pre√ßo Final</small>
    </th>
  </tr>
</thead>

              <tbody>
  {% for precalc in precalculos %}
    <tr>
      <td class="align-middle text-center">
        <input type="checkbox" name="precalculos_selecionados" value="{{ precalc.id }}">
      </td>
      <td class="align-middle text-center">
        {{ precalc.numero }}
      </td>
      <td class="align-middle text-center">
        {{ precalc.analise_comercial_item.item.codigo }}
      </td>
      <td class="align-middle text-center">
        {{ precalc.preco_manual|default:precalc.preco_selecionado|formatar_reais }}
      </td>
    </tr>
  {% endfor %}
</tbody>

            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-printer me-1"></i> Gerar Proposta
          </button>
        </div>
      </div>
    </form>
  </div>
</div>



<div class="modal fade" id="modalDuplicarPrecalc" tabindex="-1" aria-labelledby="modalDuplicarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="get" action="" id="formDuplicarPrecalc">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalDuplicarLabel">Duplicar Item de Pr√©-C√°lculo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="selectPrecalc" class="form-label">Selecione o Pr√©-C√°lculo de origem</label>
            <select class="form-select" id="selectPrecalc" name="precalc_id" required>
              {% for precalc in precalculos %}
                <option value="{{ precalc.id }}">
                  N¬∫ {{ precalc.numero }} - {{ precalc.analise_comercial_item.item.codigo }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="selectRoteiro" class="form-label">
              Selecione o Roteiro para o novo Pr√©-C√°lculo
              <small class="text-muted d-block">Ao escolher um roteiro aqui, materiais/servi√ßos/etapas do original n√£o ser√£o clonados.</small>
            </label>
            <select class="form-select" id="selectRoteiro" name="roteiro_id" disabled>
              <option value="">‚Äî Selecione primeiro o Pr√©-C√°lculo ‚Äî</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-copy me-1"></i> Duplicar
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const precalcSelect  = document.getElementById("selectPrecalc");
  const roteiroSelect  = document.getElementById("selectRoteiro");
  const formDuplicar   = document.getElementById("formDuplicarPrecalc");

  async function carregarRoteiros(precalcId) {
    roteiroSelect.innerHTML = '<option value="">Carregando...</option>';
    roteiroSelect.disabled = true;
    try {
      const resp = await fetch(`{% url 'opcoes_roteiro_precalculo' 0 %}`.replace('/0/', `/${precalcId}/`), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      roteiroSelect.innerHTML = '<option value="">‚Äî (opcional) Selecione o roteiro ‚Äî</option>';
      if (Array.isArray(data.roteiros)) {
        data.roteiros.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.id;
          opt.textContent = r.label;
          roteiroSelect.appendChild(opt);
        });
      }
      roteiroSelect.disabled = false;
    } catch(e) {
      roteiroSelect.innerHTML = '<option value="">Falha ao carregar roteiros</option>';
    }
  }

  precalcSelect.addEventListener("change", function () {
    const id = this.value;
    if (id) carregarRoteiros(id);
  });

  document.addEventListener('DOMContentLoaded', function(){
    if (precalcSelect.value) carregarRoteiros(precalcSelect.value);
  });

  formDuplicar.addEventListener("submit", function (e) {
    e.preventDefault();
    const precalcId = precalcSelect.value;
    const roteiroId = roteiroSelect.value || "";
    let url = `{% url 'duplicar_precalculo' 9999 %}`.replace("9999", precalcId);
    if (roteiroId) {
      const sep = url.includes('?') ? '&' : '?';
      url = `${url}${sep}roteiro_id=${encodeURIComponent(roteiroId)}`;
    }
    window.location.href = url;
  });
</script>





    {% endif %}
  </div>

  <!-- Indicadores -->
<div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
{% include "partials/global/_card_indicador.html" with cor="success" titulo="Aprovados" valor=status_aprovado subtitulo="Itens Aprovados" icone="bi-check-circle-fill" %}
{% include "partials/global/_card_indicador.html" with cor="danger" titulo="Reprovados" valor=status_reprovado subtitulo="Itens Reprovados" icone="bi-x-circle-fill" %}
{% include "partials/global/_card_indicador.html" with cor="warning" titulo="Amostras" valor=status_amostras subtitulo="Solicita√ß√£o de Amostras" icone="bi-droplet" %}
{% include "partials/global/_card_indicador.html" with cor="secondary" titulo="Em Andamento" valor=status_andamento subtitulo="An√°lises em Andamento" icone="bi-hourglass-split" %}
</div>


  <!-- Lista de Itens de Pr√©-C√°lculo -->
  <h5 class="mb-3">
    <i class="bi bi-table me-2 text-muted"></i>üìä Lista de Itens de Pr√©-C√°lculo
  </h5>
<div class="alert alert-info d-flex align-items-start gap-2 small" role="alert">
  <i class="bi bi-info-circle-fill fs-5 mt-1 text-primary"></i>
  <div>
    <strong>Legenda dos pre√ßos escolhidos:</strong><br>
    <ul class="mb-0 ps-3">
      <li><strong>‚úçÔ∏è Manual:</strong> pre√ßo digitado diretamente no campo.</li>
      <li><strong>üí∞ Com Impostos:</strong> valor calculado com ICMS, PIS, COFINS, IR, CSLL, DF e DV.</li>
      <li><strong>üßÆ Sem Impostos:</strong> valor baseado apenas nos custos diretos + IR/CSLL/DF/DV.</li>
    </ul>
  </div>
</div>

  <div class="table-responsive zebra-tabela mt-4">
    <table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-light">
  <tr>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-hash mb-1"></i>
        <small>#</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-upc-scan mb-1"></i>
        <small>C√≥digo</small>
      </div>
    </th>
    <!-- NOVA COLUNA: Roteiro -->
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-diagram-3 mb-1"></i>
        <small>Roteiro</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-stack mb-1"></i>
        <small>Qtde Estimada</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-bar-chart-line mb-1"></i>
        <small>Status An√°lise</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-arrow-repeat mb-1"></i>
        <small>Periodicidade</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-cash-stack mb-1"></i>
        <small>Valor Total</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-tools mb-1"></i>
        <small>Ferramental</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-calculator mb-1"></i>
        <small>Total Geral</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-currency-exchange mb-1"></i>
        <small>Pre√ßo Escolhido</small>
      </div>
    </th>
    <th class="text-center align-middle">
      <div class="d-flex flex-column align-items-center">
        <i class="bi bi-gear mb-1"></i>
        <small>A√ß√µes</small>
      </div>
    </th>
  </tr>
</thead>


      
      
      <tbody>
        {% for item in page_obj %}
          <tr>
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>{{ item.analise_comercial_item.item.codigo }}</td>
            
<td>
  {% with roteiro=item.analise_comercial_item.roteiro_selecionado %}
    {% if roteiro %}
      <span class="badge bg-secondary">
{{ roteiro.get_tipo_roteiro_display }} - Rev. {{ roteiro.revisao }}
      </span>
    {% else %}
      <span class="text-muted fst-italic">‚Äî</span>
    {% endif %}
  {% endwith %}
</td>



            <!-- Quantidade Estimada -->
            <td>
              {{ item.analise_comercial_item.qtde_estimada|intcomma|default:"‚Äî" }}
            </td>
      
            <!-- Status da An√°lise -->
           <td>
  {% with status=item.analise_comercial_item.status %}
    {% if status == "aprovado" %}
      <span class="badge bg-success d-inline-flex align-items-center">
        <i class="bi bi-check-circle-fill me-1"></i> Aprovado
      </span>
    {% elif status == "reprovado" %}
      <span class="badge bg-danger d-inline-flex align-items-center">
        <i class="bi bi-x-circle-fill me-1"></i> Reprovado
      </span>
    {% elif status == "amostras" %}
      <span class="badge bg-warning text-dark d-inline-flex align-items-center">
        <i class="bi bi-flask me-1"></i> Solicita√ß√£o de Amostras
      </span>
    {% else %}
      <span class="badge bg-secondary d-inline-flex align-items-center">
        <i class="bi bi-hourglass-split me-1"></i> Em Andamento
      </span>
    {% endif %}
  {% endwith %}
</td>

      
            <!-- Periodicidade -->
            <td>
  {% with periodo=item.analise_comercial_item.periodo %}
    {% if periodo == "Mensal" %}
      <span class="badge bg-info text-dark d-inline-flex align-items-center">
        <i class="bi bi-calendar2-date me-1"></i> Mensal
      </span>
    {% elif periodo == "Trimestral" %}
      <span class="badge bg-warning text-dark d-inline-flex align-items-center">
        <i class="bi bi-calendar2-range me-1"></i> Trimestral
      </span>
    {% elif periodo == "Semestral" %}
      <span class="badge bg-primary d-inline-flex align-items-center">
        <i class="bi bi-calendar2-event me-1"></i> Semestral
      </span>
    {% elif periodo == "Anual" %}
      <span class="badge bg-success d-inline-flex align-items-center">
        <i class="bi bi-calendar2-check me-1"></i> Anual
      </span>
    {% else %}
      <span class="badge bg-secondary d-inline-flex align-items-center">
        <i class="bi bi-calendar2-week me-1"></i> Espor√°dico
      </span>
    {% endif %}
  {% endwith %}
</td>

      
          <td>
  {% if item.valor_total is not None %}
    {{ item.valor_total|formatar_reais }}
  {% else %}
    <span class="text-muted fst-italic">Ainda n√£o definido</span>
  {% endif %}
</td>



            
      <!-- üõ† Valor Ferramental -->
<td>
  {% if item.valor_ferramental is not None %}
    {{ item.valor_ferramental|formatar_reais }}
  {% else %}
    <span class="text-muted fst-italic">Ainda n√£o definido</span>
  {% endif %}
</td>


<!-- üí∞ Total Geral (produto + ferramental) -->
<td>
  {% if item.total_geral is not None %}
    {{ item.total_geral|formatar_reais }}
  {% else %}
    <span class="text-muted fst-italic">Ainda n√£o definido</span>
  {% endif %}
</td>


<!-- üìà Pre√ßo Escolhido (R$ + % margem) -->
<td>
  {% if item.preco_margem_formatado %}
    <span>{{ item.preco_margem_formatado }}</span>
    {% if item.observacoes_precofinal %}
      <button class="btn btn-sm btn-link p-0 ms-1" 
              data-bs-toggle="modal" 
              data-bs-target="#modalObsPrecoFinal{{ item.id }}" 
              title="Ver Observa√ß√µes">
        <i class="bi bi-chat-left-text text-primary"></i>
      </button>
    {% endif %}
  {% else %}
    <span class="text-muted fst-italic">Ainda n√£o definido</span>
  {% endif %}
</td>

{% for item in page_obj %}
  {% if item.observacoes_precofinal %}
    <div class="modal fade" id="modalObsPrecoFinal{{ item.id }}" tabindex="-1" aria-labelledby="modalLabel{{ item.id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel{{ item.id }}">
              <i class="bi bi-chat-left-text text-primary me-2"></i> Observa√ß√µes sobre o Pre√ßo Final - Item #{{ item.numero }}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            {{ item.observacoes_precofinal|safe }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Fechar
            </button>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endfor %}


      
            <!-- A√ß√µes -->
            <td>
              <div class="d-inline-flex flex-wrap gap-1 justify-content-center">
                {% if request.user|has_permission:"comercial.change_precalculo" %}
                  {% include "partials/global/_botao_editar.html" with objeto=item url_editar="editar_precalculo" label="precalculo" %}
                {% endif %}
                {% if request.user|has_permission:"comercial.view_precalculo" %}
                <a href="{% url 'visualizar_precalculo' item.pk %}"
                    class="btn btn-sm btn-info mt-1"
                    title="Visualizar F011 (Relat√≥rio)"
                    aria-label="Visualizar F011 (Relat√≥rio)">
                  <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
                </a>
                {% endif %}

             {% if request.user|has_permission:"comercial.ver_precificacao" %}
                <a href="{% url 'precificacao_produto' item.pk %}"
                        class="btn btn-sm btn-warning mt-1"
                        title="Precifica√ß√£o do Produto"
                        aria-label="Precifica√ß√£o do Produto">
                        <i class="bi bi-currency-dollar" aria-hidden="true"></i>
                  </a>
                  {% endif %}

                {% if request.user|has_permission:"comercial.delete_precalculo" %}
                  {% include "partials/global/_botao_excluir.html" with objeto=item url_excluir="excluir_precalculo" label="precalculo" %}
                  {% include "partials/global/_modal_exclusao.html" with objeto=item url_excluir="excluir_precalculo" %}
                {% endif %}
              </div>
            </td>
            
          </tr>
        {% endfor %}
      </tbody>
      
      
    </table>
    {% include "partials/global/_paginacao.html" with page_obj=page_obj %}
  </div>
</div>
{% endblock %}
