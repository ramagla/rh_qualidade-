{% extends 'base.html' %}

{% block title %}Itens de Pr√©-C√°lculo - Cota√ß√£o #{{ cotacao.numero }}{% endblock %}
{% load humanize %}

{% block content %}
{% load custom_filters %}

{% include "partials/global/_styles_componentes.html" %}

<div class="container-fluid mt-5">

  <div class="text-center mb-4 border-bottom pb-2">
    <h2 class="m-0">
      <i class="bi bi-calculator text-primary me-2"></i>
      Itens de Pr√©-C√°lculo da Cota√ß√£o <strong>#{{ cotacao.numero }}</strong>
    </h2>
  </div>
    {% include "partials/global/_toast_mensagens.html" %}
  {% include "partials/global/_estilos_botoes_acoes.html" %}

  <!-- Bot√µes -->
  <div class="d-flex justify-content-end flex-wrap gap-2 mb-4">
    <a href="{% url 'lista_cotacoes' %}"
    class="btn btn-cadastrar-personalizado d-inline-flex align-items-center">
   <i class="bi bi-arrow-left-circle-fill me-2"></i>
   Voltar √†s Cota√ß√µes
 </a>
 
    {% if request.user|has_permission:"comercial.add_precalculo" %}
      <a href="{% url 'criar_precalculo' cotacao.id %}"
         class="btn btn-cadastrar-personalizado d-inline-flex align-items-center">
        <i class="bi bi-plus-circle-fill me-2"></i>
        Novo Item
      </a>
    {% endif %}
  </div>

  <!-- Indicadores -->
  <div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
    {% include "partials/global/_card_indicador.html" with cor="success" titulo="Materiais" valor=total_materiais subtitulo="Itens de Mat√©ria-Prima" icone="bi-box-seam" %}
    {% include "partials/global/_card_indicador.html" with cor="warning" titulo="Servi√ßos Ext." valor=total_servicos subtitulo="Itens de Servi√ßo Externo" icone="bi-gear-fill" %}
    {% include "partials/global/_card_indicador.html" with cor="info" titulo="Total de Itens" valor=total_itens subtitulo="Materiais + Servi√ßos" icone="bi-list-ul" %}
    {% include "partials/global/_card_indicador.html" with cor="primary" titulo="Itens na P√°gina" valor=page_obj|length subtitulo="Registros desta p√°gina" icone="bi-card-list" %}
  </div>

  <!-- Lista de Itens de Pr√©-C√°lculo -->
  <h5 class="mb-3">
    <i class="bi bi-table me-2 text-muted"></i>üìä Lista de Itens de Pr√©-C√°lculo
  </h5>

  <div class="table-responsive zebra-tabela mt-4">
    <table class="table table-bordered table-striped align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>C√≥digo</th>
          <th>Qtde Estimada</th>
          <th>Status da An√°lise</th>
          <th>Periodicidade</th>
          <th>Valor Total (R$)</th>
          <th>Pre√ßo Escolhido (R$)</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      
      <tbody>
        {% for item in page_obj %}
          <tr>
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>{{ item.analise_comercial_item.item.codigo }}</td>
      
            <!-- Quantidade Estimada -->
            <td>
              {{ item.analise_comercial_item.qtde_estimada|intcomma|default:"‚Äî" }}
            </td>
      
            <!-- Status da An√°lise -->
            <td>
              {% if item.analise_comercial_item.status == "aprovado" %}
                <span class="badge bg-success">Aprovado</span>
              {% elif item.analise_comercial_item.status == "reprovado" %}
                <span class="badge bg-danger">Reprovado</span>
              {% elif item.analise_comercial_item.status == "amostras" %}
                <span class="badge bg-warning text-dark">Solicita√ß√£o de Amostras</span>
              {% else %}
                <span class="badge bg-secondary">Em Andamento</span>
              {% endif %}
            </td>
            
      
            <!-- Periodicidade -->
            <td>
              {% with periodo=item.analise_comercial_item.periodo %}
                {% if periodo == "Mensal" %}
                  <span class="badge bg-info"><i class="bi bi-calendar2-date me-1"></i> Mensal</span>
                {% elif periodo == "Trimestral" %}
                  <span class="badge bg-warning text-dark"><i class="bi bi-calendar2-range me-1"></i> Trimestral</span>
                {% elif periodo == "Semestral" %}
                  <span class="badge bg-primary"><i class="bi bi-calendar2-event me-1"></i> Semestral</span>
                {% elif periodo == "Anual" %}
                  <span class="badge bg-success"><i class="bi bi-calendar2-check me-1"></i> Anual</span>
                {% else %}
                  <span class="badge bg-secondary"><i class="bi bi-calendar2-week me-1"></i> Espor√°dico</span>
                {% endif %}
              {% endwith %}
            </td>
            
      
            <!-- Valor Total -->
            <td>
              {% with precos=item.calcular_precos_sem_impostos %}
                {% if precos %}
                  {% with total=precos|last %}
                    {{ total.total|floatformat:2 }}
                  {% endwith %}
                {% else %}
                  ‚Äî
                {% endif %}
              {% endwith %}
            </td>
            
            
            <!-- Pre√ßo Escolhido -->
            <td>
              {{ item.preco_selecionado|floatformat:2|default:"‚Äî" }}
            </td>
      
            <!-- A√ß√µes -->
            <td>
              <div class="d-inline-flex flex-wrap gap-1 justify-content-center">
                {% if request.user|has_permission:"comercial.change_precalculo" %}
                  {% include "partials/global/_botao_editar.html" with objeto=item url_editar="editar_precalculo" label="precalculo" %}
                {% endif %}
                {% if request.user|has_permission:"comercial.delete_precalculo" %}
                  {% include "partials/global/_botao_excluir.html" with objeto=item url_excluir="excluir_precalculo" label="precalculo" %}
                  {% include "partials/global/_modal_exclusao.html" with objeto=item url_excluir="excluir_precalculo" %}
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
      
    </table>
    {% include "partials/global/_paginacao.html" with page_obj=page_obj %}
  </div>
</div>
{% endblock %}
