{% load filters_gerais %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>
    Responder Cotação – Serviço Externo – {{ codigo }}{% if materia_prima %} — {{ materia_prima.descricao }}{% endif %}
  </title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    .btn-abrir-desenho {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      letter-spacing: .2px;
      border-radius: 999px;
      padding: .75rem 1.25rem;
      box-shadow: 0 .25rem .75rem rgba(0,0,0,.06);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn-abrir-desenho:hover {
      transform: translateY(-1px);
      box-shadow: 0 .75rem 1.5rem rgba(0,0,0,.10);
      text-decoration: none;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5 p-4 bg-white shadow rounded">

    <!-- Título com Código, Cotação e Pré-Cálculo -->
    <h2 class="mb-1 d-flex flex-wrap align-items-center gap-2">
      <i class="bi bi-tools me-2 text-danger"></i>
      <span>Responder Cotação – Serviço Externo</span>
    </h2>

    {% with prec=servicos.0.precalculo ac=servicos.0.precalculo.analise_comercial_item %}
  <div class="text-muted small mb-2 d-flex flex-wrap align-items-center gap-3">
    <span>
      <i class="bi bi-upc-scan me-1"></i>
      Código: <strong>{{ codigo|default:"—" }}</strong>
    </span>
    <span>
      <i class="bi bi-receipt me-1"></i>
      Cotação nº:
      <strong>{{ prec.cotacao.numero|default_if_none:cotacao_numero|default:cotacao_numero|default:"—" }}</strong>
    </span>
    <span>
      <i class="bi bi-clipboard-check me-1"></i>
      Pré-Cálculo nº:
      <strong>{{ prec.numero|default_if_none:precalculo_numero|default:precalculo_numero|default:"—" }}</strong>
    </span>

    {# ✅ NOVO: Quantidade Estimada (sem parênteses no if) #}
    {% if ac %}
      {% if ac.qtde_estimada or ac.periodo %}
        <span>
          <i class="bi bi-calculator me-1"></i>
          Qtde Estimada:
          {% if ac.qtde_estimada %}
            <strong>{{ ac.qtde_estimada|decimal_pt:0 }}</strong>
          {% elif prec.qtde_estimada %}
            <strong>{{ prec.qtde_estimada|decimal_pt:0 }}</strong>
          {% else %}
            <strong>—</strong>
          {% endif %}
          {% if ac.periodo %}
            <small class="text-muted">/ {{ ac.get_periodo_display }}</small>
          {% endif %}
        </span>
      {% endif %}
    {% endif %}
  </div>
{% endwith %}


    <!-- Subtítulo / Descrição do material associado -->
    <p class="text-muted mb-4">
      <i class="bi bi-card-text me-1"></i>
      {% if materia_prima and materia_prima.descricao %}
        {{ materia_prima.descricao }}
      {% else %}
        {% with mp=servicos.0.insumo.materia_prima %}
          {{ mp.descricao|default:"" }}
        {% endwith %}
      {% endif %}
    </p>

    <!-- Alerta com instruções -->
    <div class="alert alert-info small">
      <div class="d-flex align-items-center gap-2 mb-1">
        <i class="bi bi-info-circle-fill fs-5 text-primary"></i>
        Cotar no mínimo <strong>2 fornecedores diferentes</strong>. Caso não haja fonte homologada, consulte o setor responsável.
      </div>
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-clock fs-5 text-muted"></i>
        O prazo de entrega deve ser informado em <strong>dias corridos</strong>.
      </div>
    </div>

    {% if servicos.0.precalculo.analise_comercial_item.roteiro_selecionado.fontes_homologadas.exists %}
      <!-- Fontes Homologadas -->
      <div class="alert alert-warning border border-dark-subtle shadow-sm">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-building-check fs-5 text-dark me-2"></i>
          <strong class="text-dark fs-6">Fontes Homologadas para este serviço:</strong>
        </div>
        <ul class="mb-0 ps-3">
          {% for fonte in servicos.0.precalculo.analise_comercial_item.roteiro_selecionado.fontes_homologadas.all %}
            <li class="fw-semibold text-dark">
              <i class="bi bi-chevron-right text-primary me-1"></i> {{ fonte.nome }}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Cards: Desenvolvido / Pesos -->
    {% with sev=servicos.0 mp=servicos.0.insumo.materia_prima %}
    <div class="row g-3 mb-3">
      <!-- Desenvolvido (mm) -->
      <div class="col-12 col-md-6 col-lg-3">
        <div class="alert alert-secondary d-flex align-items-center justify-content-between p-3 shadow-sm mb-0 h-100">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-rulers fs-4 text-dark"></i>
            <span class="fw-bold">Desenvolvido (mm):</span>
          </div>
          <span class="text-primary fw-semibold">
           {% if sev.desenvolvido_mm %}
                {{ sev.desenvolvido_mm|decimal_pt:7 }}
              {% elif mp and mp.desenvolvido_mm %}
                {{ mp.desenvolvido_mm|decimal_pt:7 }}
              {% else %}—{% endif %}
          </span>
        </div>
      </div>

      <!-- Peso Líquido -->
      <div class="col-12 col-md-6 col-lg-3">
        <div class="alert alert-secondary d-flex align-items-center justify-content-between p-3 shadow-sm mb-0 h-100">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-box fs-4 text-dark"></i>
            <span class="fw-bold">Peso Líquido:</span>
          </div>
          <span class="text-primary fw-semibold">
            {% if sev.peso_liquido %}
              {{ sev.peso_liquido|decimal_pt:10 }} kg
            {% elif mp and mp.peso_liquido %}
              {{ mp.peso_liquido|decimal_pt:10 }} kg
            {% else %}—{% endif %}
          </span>
        </div>
      </div>

      <!-- Peso Bruto -->
      <div class="col-12 col-md-6 col-lg-3">
        <div class="alert alert-secondary d-flex align-items-center justify-content-between p-3 shadow-sm mb-0 h-100">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-box-seam fs-4 text-dark"></i>
            <span class="fw-bold">Peso Bruto:</span>
          </div>
          <span class="text-primary fw-semibold">
            {% if sev.peso_bruto %}
              {{ sev.peso_bruto|decimal_pt:10 }} kg
            {% elif mp and mp.peso_bruto %}
              {{ mp.peso_bruto|decimal_pt:10 }} kg
            {% else %}—{% endif %}
          </span>
        </div>
      </div>

      <!-- Peso Líquido Total -->
      <div class="col-12 col-md-6 col-lg-3">
        <div class="alert alert-secondary d-flex align-items-center justify-content-between p-3 shadow-sm mb-0 h-100">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-basket-fill fs-4 text-dark"></i>
            <span class="fw-bold">Peso Líquido Total:</span>
          </div>
          <span class="text-primary fw-semibold">
          {{ sev.peso_liquido_total|decimal_pt:7 }} kg          </span>
        </div>
      </div>
    </div>
    {% endwith %}

    <!-- Botão: Abrir Desenho do Item -->
    {% if servicos.0.precalculo.analise_comercial_item.item.desenho %}
      <div class="my-3 d-flex justify-content-center">
        <a href="{{ servicos.0.precalculo.analise_comercial_item.item.desenho.url }}"
           target="_blank"
           rel="noopener"
           class="btn btn-primary btn-abrir-desenho">
          <i class="bi bi-file-earmark-text"></i>
          <span>Abrir Desenho do Item</span>
        </a>
      </div>
    {% endif %}

   


    <!-- Formulário de resposta -->
    <form method="post" class="mt-4" novalidate>
      {% csrf_token %}



       <!-- Observações gerais (AGORA DENTRO DO FORM) -->
  <div class="mb-3">
    <label for="id_observacoes_gerais" class="form-label mb-1">
      <i class="bi bi-chat-left-text me-1 text-muted"></i> Observações Gerais
    </label>
    <textarea
      id="id_observacoes_gerais"
      name="observacoes_gerais"
      class="form-control"
      rows="6"
    >{{ observacoes_gerais|default_if_none:""|safe }}</textarea>
    <div class="form-text">Estas observações serão salvas no Pré-Cálculo (serviços).</div>
  </div>
      <table class="table table-bordered align-middle text-center">
        <thead class="table-light">
          <tr>
            <th style="width: 30%;">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-building mb-1"></i>
                <small>Fornecedor</small>
              </div>
            </th>
            <th style="width: 15%;">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-percent mb-1"></i>
                <small>ICMS (%)</small>
              </div>
            </th>
            <th style="width: 15%;">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-boxes mb-1"></i>
                <small>Lote Mínimo</small>
              </div>
            </th>
            <th style="width: 15%;">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-truck mb-1"></i>
                <small>Entrega (dias)</small>
              </div>
            </th>
            <th style="width: 15%;">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-currency-dollar mb-1"></i>
                <small>Preço/kg</small>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for sev in servicos %}
            <tr>
              <input type="hidden" name="id_{{ forloop.counter0 }}" value="{{ sev.id }}">
              <td>
                <select name="fornecedor_{{ forloop.counter0 }}" class="form-select select2">
                  <option value="">Selecione o fornecedor</option>
                  {% for f in fornecedores %}
                    <option value="{{ f.id }}" {% if sev.fornecedor and f.id == sev.fornecedor.id %}selected{% endif %}>{{ f.nome }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
<input type="text"
       name="icms_{{ forloop.counter0 }}"
       value="{{ sev.icms|default_if_none:''|decimal_pt:2 }}"
       class="form-control text-end"
       inputmode="decimal"
       data-decimal="2"
       autocomplete="off"
       placeholder="Ex: 18,00" />
              </td>
              <td>
               <input type="text"
       name="lote_minimo_{{ forloop.counter0 }}"
       value="{{ sev.lote_minimo|default_if_none:''|decimal_pt:2 }}"
       class="form-control text-end"
       inputmode="decimal"
       data-decimal="2"
       autocomplete="off"
       placeholder="Ex: 115,90" />

              </td>
              <td>
<input type="text"
       name="entrega_dias_{{ forloop.counter0 }}"
       value="{{ sev.entrega_dias|default_if_none:'' }}"
       class="form-control text-end"
       inputmode="numeric"
       pattern="^\d{1,5}$"
       autocomplete="off"
       placeholder="Ex: 30" />
                    </td>
              <td>
                <input type="text"
       name="preco_kg_{{ forloop.counter0 }}"
       value="{{ sev.preco_kg|default_if_none:''|decimal_pt:4 }}"
       class="form-control text-end"
       inputmode="decimal"
       data-decimal="4"
       autocomplete="off"
       placeholder="Ex: 3,9000" />
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Botão de envio -->
      <div class="text-end">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-circle me-1"></i> Salvar Cotações
        </button>
      </div>
    </form>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    $(document).ready(function () {
      $(".select2").select2({
        theme: "bootstrap-5",
        width: "100%"
      });
    });
  </script>
  <!-- CKEditor 5 (Classic) -->
<!-- Coloque estes <script> depois dos demais scripts (jQuery/Select2), antes de fechar </body> -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/translations/pt-br.js"></script>
<script>
  (function () {
    const textarea = document.getElementById('id_observacoes_gerais');
    if (!textarea) return;

    ClassicEditor.create(textarea, {
      language: 'pt-br',
      toolbar: {
        items: [
          'undo','redo','|',
          'heading','|',
          'bold','italic','underline','removeFormat','|',
          'bulletedList','numberedList','blockQuote','|',
          'link','insertTable'
        ]
      },
      placeholder: 'Escreva aqui observações gerais sobre a cotação...'
    }).then(editor => {
      // ⚠️ SINCRONIZAÇÃO NO SUBMIT
      const form = textarea.closest('form');
      if (form) {
        form.addEventListener('submit', () => {
          textarea.value = editor.getData();  // <- garante que vai no POST
        });
      }
    }).catch(console.error);
  })();
</script>
<script>
(function () {
  function parseFlexibleDecimal(str) {
    if (!str) return null;
    let s = String(str).trim();
    s = s.replace(/[^\d,\.]/g, "");
    if (!s) return null;

    if (s.includes(",") && s.includes(".")) {
      if (s.lastIndexOf(",") > s.lastIndexOf(".")) {
        s = s.replace(/\./g, "").replace(",", ".");
      } else {
        s = s.replace(/,/g, "");
      }
    } else if (s.includes(",")) {
      s = s.replace(",", ".");
    }
    const num = Number(s);
    return Number.isFinite(num) ? num : null;
  }

  function formatPtBR(num, frac) {
    return num.toLocaleString("pt-BR", {
      minimumFractionDigits: frac,
      maximumFractionDigits: frac
    });
  }

  document.querySelectorAll('input[data-decimal]').forEach(function (el) {
    const frac = parseInt(el.getAttribute('data-decimal') || "2", 10);

    el.addEventListener('input', function () {
      const caret = el.selectionStart;
      const before = el.value;
      let filtered = before.replace(/[^\d,\.]/g, "");
      filtered = filtered.replace(/[,\.]{2,}/g, function(m){ return m[0]; });
      if (filtered !== before) {
        el.value = filtered;
        const diff = before.length - filtered.length;
        const pos = Math.max(0, caret - diff);
        el.setSelectionRange(pos, pos);
      }
    });

    el.addEventListener('blur', function () {
      const parsed = parseFlexibleDecimal(el.value);
      if (parsed === null) return;       // não apaga se inválido
      el.value = formatPtBR(parsed, frac);
    });
  });
})();
</script>


</body>
</html>
