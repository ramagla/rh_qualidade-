{% load filters_gerais %}

<div class="card mb-3">
  <div class="card-body">
   <form method="get" class="row g-2 align-items-end">
    <input type="hidden" name="data_inicio" value="{{ data_inicio }}">
    <input type="hidden" name="data_fim" value="{{ data_fim }}">
    <input type="hidden" name="tab" value="ficha">  <!-- mantém a aba Ficha ativa -->


      <div class="col-sm-6 col-md-5 col-lg-4">
        <label class="form-label mb-1">
          <i class="bi bi-people me-1"></i> Cliente
        </label>
        <select name="cliente" id="fichaCliente" class="form-select select2" data-placeholder="Selecione..." style="width:100%;">
  <option value=""></option>
  {% for nome in clientes_opcoes %}
    <option value="{{ nome }}" {% if nome == cliente_nome_sel %}selected{% endif %}>
      {{ nome }}
    </option>
  {% endfor %}
</select>


      </div>

      <div class="col-sm-3 col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel me-1"></i> Aplicar
        </button>
      </div>
    </form>
  </div>
</div>

{% if not cliente_nome_sel %}
  <div class="alert alert-info">Selecione um cliente para visualizar a ficha resumida do período.</div>
{% else %}
  <div class="row row-cols-1 row-cols-md-3 g-3 mb-3">
    <div class="col">
      <div class="card-resumo resumo-azul text-center h-100">
        <div class="resumo-valor">{{ ficha_ranking }}</div>
        <div class="resumo-title">Ranking</div>
      </div>
    </div>
    <div class="col">
      <div class="card-resumo resumo-roxo text-center h-100">
        <div class="resumo-valor">{{ ficha_total|formatar_reais }}</div>
        <div class="resumo-title">Faturamento Total</div>
      </div>
    </div>
    <div class="col">
      <div class="card-resumo resumo-roxo2 text-center h-100">
        <div class="resumo-valor">{{ ficha_qtde_devolucoes }}</div>
        <div class="resumo-title">Qtde de Devoluções</div>
      </div>
    </div>
  </div>

  <div class="alert alert-success">
    Este cliente apresenta um faturamento total de {{ ficha_total|formatar_reais }}.
    Atualmente, ele está com o status <strong>{{ cliente_sel.status|upper }}</strong>,
    classificado como um cliente <strong>Classe {{ ficha_ranking }}</strong>.
    O último registro de compra foi feito em
    <strong>{% if ficha_ultima_compra %}{{ ficha_ultima_compra|date:"d/m/Y" }}{% else %}—{% endif %}</strong>.
    Até o momento, o cliente realizou <strong>{{ ficha_pedidos }}</strong> pedidos no total,
    com valor médio de compra de <strong>{{ ficha_valor_medio|formatar_reais }}</strong>.
  </div>

  <div class="card">
    <div class="card-header bg-white">
      <strong>Produtos mais adquiridos</strong>
    </div>
    <div class="card-body">
      <div class="table-responsive small">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Item</th>
              <th class="text-end">Qtde</th>
              <th class="text-end">Faturamento</th>
              <th class="text-center">Última Compra</th>
            </tr>
          </thead>
          <tbody>
            {% for r in ficha_produtos %}
              <tr>
                <td>{{ r.item_codigo }}</td>
                <td class="text-end">{{ r.qtde|default_if_none:0 }}</td>
                <td class="text-end">{{ r.total|formatar_reais }}</td>
                <td class="text-center">{% if r.ultima %}{{ r.ultima|date:"d/m/Y" }}{% else %}—{% endif %}</td>
              </tr>
            {% endfor %}
            <tr class="fw-bold bg-light">
              <td class="text-end">Total</td>
              <td class="text-end">{{ ficha_totais.qtde|default_if_none:0 }}</td>
              <td class="text-end">{{ ficha_totais.total|formatar_reais }}</td>
              <td class="text-center">{% if ficha_ultima_compra %}{{ ficha_ultima_compra|date:"d/m/Y" }}{% else %}—{% endif %}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-3 small">
        <strong>Legenda de Classificação de Clientes</strong><br>
        Classe A: faturamento do cliente &gt; 7% do faturamento geral do período.<br>
        Classe B: faturamento entre 2% e 7% do faturamento geral do período.<br>
        Classe C: faturamento &lt; 2% do faturamento geral do período.
      </div>
    </div>
  </div>
{% endif %}
