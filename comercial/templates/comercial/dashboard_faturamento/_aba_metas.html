{% load filters_gerais %}

<!-- comercial/templates/comercial/dashboard_faturamento/_aba_metas.html -->
<div class="row row-cols-1 row-cols-md-3 g-3 mb-3">
  <div class="col">
    <div class="card-resumo resumo-azul text-center h-100">
      <div class="resumo-valor">{{ fat_acumulado|formatar_reais }}</div>
      <div class="resumo-title">Faturamento</div>
    </div>
  </div>
  <div class="col">
    <div class="card-resumo resumo-roxo text-center h-100">
      <div class="resumo-valor">{{ meta_acumulada|formatar_reais }}</div>
      <div class="resumo-title">Meta de faturamento</div>
    </div>
  </div>
  <div class="col">
    <div class="card-resumo resumo-roxo2 text-center h-100">
      <!-- _aba_metas.html (card Diferença) -->
<div class="resumo-valor">
  {% if dif_negativo %}-{% endif %}{{ dif_valor_abs|default_if_none:0|formatar_reais }}
</div>

      <div class="resumo-title">Diferença <small class="text-light-50">(real × meta)</small>
        <span class="{% if dif_percent < 0 %}text-warning{% else %}text-light{% endif %}"> — {{ dif_percent }}%</span>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-12">
    <div class="card h-100">
      <div class="card-header bg-white"><strong>Faturamento e meta por mês</strong></div>
      <div class="card-body"><canvas id="chart_fat_meta_mes" height="120"></canvas></div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-white"><strong>Faturamento e meta acumulados por ano</strong></div>
      <div class="card-body"><canvas id="chart_acumulado" height="140"></canvas></div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-white"><strong>Desvio da meta por mês</strong></div>
      <div class="card-body"><canvas id="chart_desvio" height="140"></canvas></div>
    </div>
  </div>

  <div class="col-12">
    <div class="card h-100">
      <div class="card-header bg-white"><strong>Faturamento por Setor Primário</strong></div>
      <div class="card-body">
        <div class="table-responsive small">
          <table class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Setor</th>
                <th class="text-end">Valor (R$)</th>
              </tr>
            </thead>
            <tbody>
              {% for s in tabela_setores %}
              <tr>
                <td>{{ s.setor }}</td>
                <td class="text-end">{{ s.total|formatar_reais }}</td>
              </tr>
              {% endfor %}
              <tr class="fw-bold bg-light">
                <td class="text-end">Total</td>
                <td class="text-end">{{ total_setores|formatar_reais }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- comercial/templates/comercial/dashboard_faturamento/_aba_metas.html -->
<script>
window.addEventListener('load', function () {
  const L_MESES = {{ labels_meses|safe }};
  const V_MES   = {{ valores_mes|safe }};
  const M_MES   = {{ metas_mes|safe }};
  const AC_FAT  = {{ acum_fat|safe }};
  const AC_META = {{ acum_meta|safe }};
  const DESVIO  = {{ desvios_percent|safe }};

  new Chart(document.getElementById("chart_fat_meta_mes"), {
    type: 'bar',
    data: { labels: L_MESES, datasets: [
      { label: 'Faturamento', data: V_MES },
      { label: 'Meta', data: M_MES }
    ]},
    options: { responsive:true, plugins:{ legend:{position:'top'} }, scales:{ y:{ beginAtZero:true } } }
  });

  new Chart(document.getElementById("chart_acumulado"), {
    type: 'line',
    data: { labels: L_MESES, datasets: [
      { label: 'Faturamento Acumulado', data: AC_FAT,  fill:false, tension:.3 },
      { label: 'Meta Acumulada',        data: AC_META, fill:false, tension:.3 }
    ]},
    options: { responsive:true, plugins:{ legend:{position:'top'} } }
  });

  new Chart(document.getElementById("chart_desvio"), {
    type: 'line',
    data: { labels: L_MESES, datasets: [{ label: 'Desvio (%)', data: DESVIO, fill:true, tension:.3 }] },
    options: { responsive:true, scales:{ y:{ suggestedMin:-100, suggestedMax:100 } } }
  });
});
</script>
