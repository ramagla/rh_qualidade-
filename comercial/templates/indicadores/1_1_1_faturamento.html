{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load filters_gerais %}
{% load humanize %}

{% block content %}
{% include 'partials/global/_estilos_impressao.html' %}
{% include 'partials/global/_styles_componentes.html' %}
{% include 'partials/global/_botao_impressao.html' %}

<div class="container pdf-container">
  <!-- Filtro -->
  <form method="get" class="mb-4 d-print-none">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label for="ano" class="form-label mb-0">
          <i class="bi bi-calendar me-1"></i> Ano:
        </label>
        <input type="number" name="ano" id="ano" class="form-control" value="{{ ano }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel-fill me-1"></i> Filtrar
        </button>
      </div>
    </div>
  </form>

  <!-- Cabe√ßalho -->
  <div class="header mb-4">
    <table class="info-table">
      <tr>
        <td style="width: 20%; text-align: center;">
          <img src="/static/logo.png" alt="Logo Bras-Mol" style="max-width: 60px;">
        </td>
        <td style="width: 60%; text-align: center;">
          <strong>üìä Indicador:</strong><br>1.1 - Faturamento
        </td>
        <td style="width: 20%; text-align: center;">
          <strong>Respons√°vel:</strong><br>Gest√£o Comercial
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <strong>üéØ Objetivo:</strong> Mensurar o faturamento l√≠quido mensal (NF v√°lidas + Vales ‚àí Devolu√ß√µes).
        </td>
        <td class="text-center">
  <strong>üéØ Meta Mensal:</strong><br>
  <small class="text-muted">Conf. Tabela</small><br>

</td>

      </tr>
    </table>
  </div>

  <!-- Gr√°fico e M√©dia -->
  <div class="grafico-midia-container mb-4 mt-4 d-flex flex-column flex-md-row justify-content-between align-items-start gap-4">
    <div class="grafico-box" style="flex: 0 0 65%;">
      {% if grafico_base64 %}
        <img src="data:image/png;base64,{{ grafico_base64 }}" alt="Gr√°fico Faturamento"
             class="img-fluid border rounded shadow-sm d-block mx-auto"
             style="max-height: 360px; max-width: 100%;">
      {% else %}
        {% include 'partials/global/_sem_resultados.html' with item_nome="gr√°fico" %}
      {% endif %}
    </div>

    <div class="media-box" style="flex: 0 0 33%;">
      <div class="media-card p-3 bg-light rounded shadow-sm border h-100">
        <table class="table table-bordered text-center mb-0">
          <thead class="table-light">
            <tr>
              <th colspan="2"><i class="bi bi-bar-chart-line me-1"></i> M√©dia Mensal</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><i class="bi bi-graph-up me-1"></i> M√©dia</td>
              <td style="{% if media >= meta %}color: green;{% else %}color: red;{% endif %}">
                <strong>{{ media|formatar_reais }}</strong>
                <span class="fs-5">
                  {% if media >= meta %} ‚úÖ {% else %} ‚ö†Ô∏è {% endif %}
                </span>
              </td>
            </tr>
            <tr>
              <td><i class="bi bi-123 me-1"></i> Acumulado</td>
              <td><strong>{{ total_ano|formatar_reais }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tabela por M√™s (sem scroll na impress√£o) -->
<div class="indicadores-container mt-4">
  <div class="table-wrap">
    <table class="table table-bordered text-center align-middle custom-table small tabela-indicador-compacta">
      <thead class="table-light">
        <tr>
          <th style="white-space:nowrap;">{{ ano }}</th>
          {% for m in meses|slice:":mes_atual" %}
            <th class="text-uppercase" style="white-space:nowrap;">{{ m }}</th>
          {% endfor %}
          <th style="white-space:nowrap;">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th><i class="bi bi-cash-coin text-success me-1"></i> Faturamento</th>
          {% for m in meses|slice:":mes_atual" %}
<td>{{ dados_faturamento|get_item:m|reais_sem_centavos }}</td>
          {% endfor %}
<td><strong>{{ total_ano|reais_sem_centavos }}</strong></td>
        </tr>
        <tr>
          <th class="text-success"><i class="bi bi-bullseye me-1"></i> Meta</th>
          {% for m in meses|slice:":mes_atual" %}
        <td>R$ {{ metas_mes|get_item:m|formatar_meta_extenso }}</td>
          {% endfor %}
        <td><strong>R$ {{ meta_total|formatar_meta_extenso }}</strong></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<style>
  /* Compacta√ß√£o para caber em 1 p√°gina */
  .tabela-indicador-compacta {
    font-size: 12px;
    table-layout: fixed;     /* colunas mais previs√≠veis */
    width: 100%;
  }
  .tabela-indicador-compacta th,
  .tabela-indicador-compacta td {
    padding: .35rem .4rem;   /* c√©lulas mais compactas */
    word-wrap: break-word;
  }

  /* Em tela (desktop), se quiser manter responsividade sem exagero */
  @media screen {
    .table-wrap { overflow-x: auto; }
  }

  /* Em impress√£o: SEM SCROLL e SEM corte */
  @media print {
    .table-wrap { overflow: visible !important; }
    .tabela-indicador-compacta {
      font-size: 10pt;              /* levemente menor no papel */
      page-break-inside: avoid;     /* evita quebra no meio */
    }
    .tabela-indicador-compacta th,
    .tabela-indicador-compacta td {
      padding: .25rem .3rem;
    }
  }
</style>
<style>
  /* Apenas para impress√£o */
  @media print {
    .custom-table th, .custom-table td {
      padding: 3px 5px !important;
      font-size: 9px !important;
    }
    .indicadores-container {
      margin-top: 5px !important;
    }
    .custom-table {
      table-layout: fixed;
    }
  }

  /* Na tela, manter leg√≠vel */
  .custom-table th, .custom-table td {
    padding: 6px 8px;
    font-size: 12px;
  }
</style>


  <!-- Detalhes opcionais -->
  <div class="mt-4">
    <div class="alert alert-secondary">
      <strong>Notas:</strong> NF v√°lidas consideram apenas Notas com n√∫mero preenchido (‚â† ‚Äúvale‚Äù). Vales somam ao faturamento e devolu√ß√µes s√£o subtra√≠das.
    </div>
  </div>

  <!-- An√°lise de Dados -->
  <div class="analise-dados mt-5">
    <h5 class="text-center mb-3 text-primary d-flex justify-content-center align-items-center gap-2">
      <i class="bi bi-bar-chart-steps fs-5"></i> An√°lise de Dados
    </h5>

    {% if comentarios %}
      <table class="table table-bordered table-striped text-center align-middle custom-table small">
        <thead class="table-light">
          <tr>
            <th><i class="bi bi-calendar-range me-1"></i> M√™s</th>
            <th><i class="bi bi-chat-left-text me-1"></i> Coment√°rio</th>
          </tr>
        </thead>
        <tbody>
          {% for comentario in comentarios %}
          <tr>
            <td>{{ comentario.data }}</td>
            <td class="text-start">
              {% if "dentro da meta" in comentario.texto %}
                <i class="bi bi-check-circle-fill text-success me-1"></i>
              {% else %}
                <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
              {% endif %}
              {{ comentario.texto }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="alert alert-info text-center">
        Nenhum coment√°rio gerado.
      </div>
    {% endif %}
  </div>

  <!-- Plano de A√ß√£o -->
  <div class="plano-acao mt-5">
    <h5 class="text-center mb-3 text-warning d-flex justify-content-center align-items-center gap-2">
      <i class="bi bi-tools fs-5"></i> Plano de A√ß√£o / Melhoria
    </h5>
    <table class="table table-bordered table-striped text-center align-middle custom-table">
      <thead class="table-light">
        <tr>
          <th><i class="bi bi-hash me-1"></i> Item</th>
          <th><i class="bi bi-wrench-adjustable me-1"></i> A√ß√£o Corretiva / Melhoria</th>
          <th><i class="bi bi-person-fill me-1"></i> Respons√°vel</th>
          <th><i class="bi bi-calendar-event me-1"></i> Prazo</th>
          <th><i class="bi bi-clipboard-check me-1"></i> Situa√ß√£o</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>[Descrever a√ß√£o se necess√°rio]</td>
          <td>[Respons√°vel]</td>
          <td>[Data]</td>
          <td>[Status]</td>
        </tr>
      </tbody>
    </table>
  </div>

  {% include 'partials/global/_formulario_rodape.html' with numero_formulario="IND 1.1" %}
</div>

<style media="print">
  .grafico-midia-container {
    display: flex !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    gap: 16px !important;
  }
  .grafico-box { flex: 0 0 65% !important; max-width: 65% !important; }
  .media-box  { flex: 0 0 33% !important; max-width: 33% !important; }
  .media-card { background: #f8f9fa !important; border: 1px solid #999 !important; padding: 8px !important; box-shadow: none !important; height: 100% !important; }
  .media-card table th, .media-card table td { font-size: 9pt !important; padding: 6px 8px !important; }
  .custom-table th, .custom-table td { font-size: 9pt !important; padding: 4px 6px !important; }
  .grafico-midia-container, .grafico-box, .media-box { page-break-inside: avoid !important; }
</style>
{% endblock %}
