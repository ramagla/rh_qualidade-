<!-- Modal de Insumos -->
<div class="modal fade" id="modalInsumo" tabindex="-1" aria-labelledby="modalInsumoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalInsumoLabel">
          <i class="bi bi-box me-2"></i> Adicionar Insumo à Etapa
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" onclick="$('.modal-backdrop').remove();"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">

          <div class="col-md-8">
            <label class="form-label">
              <i class="bi bi-box-seam me-1 text-muted"></i> Insumo (Matéria-prima):
            </label>
            <select class="form-select select2" name="insumo" data-dropdown-parent="#modalInsumo">
              {% for insumo in insumos %}
                <option value="{{ insumo.id }}">{{ insumo.codigo }} – {{ insumo.descricao }}</option>
              {% endfor %}
            </select>
          </div>
  <div class="col-md-4">
              <label class="form-label" for="desenvolvidoInsumo">
                <i class="bi bi-hammer me-1 text-muted"></i> Desenvolvido em (mm):
              </label>
              <input type="number" step="0.0000001" min="0" class="form-control" name="desenvolvido" id="desenvolvidoInsumo">
            </div>
          <div class="col-md-4">
            <label class="form-label">
              <i class="bi bi-box2-heart me-1 text-muted"></i> Peso Líquido (kg):
            </label>
            <input type="number" step="0.001" min="0" class="form-control" name="peso_liquido">
          </div>

          <div class="col-md-4">
            <label class="form-label">
              <i class="bi bi-box2-fill me-1 text-muted"></i> Peso Bruto (kg):
            </label>
            <input type="number" step="0.001" min="0" class="form-control" name="peso_bruto">
          </div>

         

          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-tags me-1 text-muted"></i> Tipo de Insumo:
            </label>
            <select class="form-select" name="tipo_insumo">
              <option value="matéria_prima">Matéria-Prima</option>
              <option value="componente">Componente</option>
              <option value="insumos">Insumos</option>
              <option value="outros">Outros</option>
            </select>
          </div>

          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="obrigatorio" id="obrigatorioInsumo">
              <label class="form-check-label" for="obrigatorioInsumo">
                <i class="bi bi-check-circle me-1 text-muted"></i> Obrigatório
              </label>
            </div>
          </div>

        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnSalvarInsumo">Salvar Insumo</button>
      </div>
    </div>
  </div>
</div>

  
  <!-- Modal de Propriedades -->
  <div class="modal fade" id="modalPropriedades" tabindex="-1" aria-labelledby="modalPropriedadesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalPropriedadesLabel">
            <i class="bi bi-gear-fill me-2"></i> Propriedades da Etapa
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" onclick="$('.modal-backdrop').remove();"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
  <label class="form-label">
    <i class="bi bi-pencil-fill me-1 text-muted"></i> Nome da Ação:
  </label>
  <select class="form-select select2" name="nome_acao" data-dropdown-parent="#modalPropriedades">
    <option value="">– Selecione –</option>
    {% for servico in servicos %}
      <option value="{{ servico.id }}">{{ servico.nome }}</option>
    {% endfor %}
  </select>
</div>

            <div class="col-md-6">
<label class="form-label">
  <i class="bi bi-cpu-fill me-1 text-muted"></i> Máquinas Permitidas:
</label>
              <select class="form-select select2" multiple name="maquinas" data-dropdown-parent="#modalPropriedades">
                {% for maquina in maquinas %}
                  <option value="{{ maquina.id }}">{{ maquina.codigo }} – {{ maquina.nome }}</option>
                {% endfor %}
              </select>             
              
            </div>
            <div class="col-md-6">
<label class="form-label">
  <i class="bi bi-tools me-1 text-muted"></i> Ferramenta:
</label>
              <select class="form-select select2" name="ferramenta" data-dropdown-parent="#modalPropriedades">
                <option value="">– Selecione –</option>
                {% for ferramenta in ferramentas %}
                  <option value="{{ ferramenta.id }}">{{ ferramenta.codigo }} – {{ ferramenta.descricao }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-12 mt-3">
  <label class="form-label fw-bold"><i class="bi bi-shield-lock me-1"></i> Características de Segurança:</label>
</div>
{% for campo, label in segurancas %}
  <div class="col-md-2">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="{{ campo }}">
      <label class="form-check-label" for="{{ campo }}">{{ label }}</label>
    </div>
  </div>
{% endfor %}



            <div class="col-md-12">
<label class="form-label">
  <i class="bi bi-card-text me-1 text-muted"></i> Descrição Detalhada:
</label>
              <textarea class="form-control" rows="4" name="descricao_detalhada"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnSalvarPropriedades">Salvar Propriedades</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Select2 nas modais -->

 <script>
if (!window._roteiroModaisRegistrado) {
  window._roteiroModaisRegistrado = true;

  document.addEventListener("DOMContentLoaded", function () {
    // Salvar Insumo
    document.getElementById("btnSalvarInsumo")?.addEventListener("click", () => {
    const m = document.getElementById("modalInsumo");
    const sel = m.querySelector('select[name="insumo"]');
    const peso_liquido = m.querySelector('input[name="peso_liquido"]').value;
    const peso_bruto = m.querySelector('input[name="peso_bruto"]').value;
    const desenvolvido = m.querySelector('input[name="desenvolvido"]').value;
    const tp = m.querySelector('select[name="tipo_insumo"]').value;
    const ob = m.querySelector('input[name="obrigatorio"]').checked;
    const txt = sel.options[sel.selectedIndex]?.text || "";
    const id = sel.value;

    const div = window.etapaAtiva;
    const data = JSON.parse(div.querySelector(".dados-etapa").value);
    const index = parseInt(m.dataset.index);
    const isEdicao = !isNaN(index) && index >= 0;
    const novoInsumo = {
      materia_prima_id: id,
      tipo_insumo: tp,
      obrigatorio: ob,
      desenvolvido: parseFloat(desenvolvido || 0),
      peso_liquido: parseFloat(peso_liquido || 0),
      peso_bruto: parseFloat(peso_bruto || 0)
    };

  if (isEdicao && index < data.insumos.length) {
  data.insumos.splice(index, 1, novoInsumo);
} else {
  data.insumos.push(novoInsumo);
}

    delete m.dataset.index; // limpa após uso

    div.querySelector(".dados-etapa").value = JSON.stringify(data);

    const ul = div.querySelector(".lista-insumos");
if (index !== undefined && ul.children[index]) {
  // Se for edição, substitui o conteúdo da linha
  ul.children[index].outerHTML = `
    <li class="list-group-item d-flex justify-content-between align-items-center small">
      <span><strong>${txt}</strong> — ${tp} / ${ob ? "Obrigatório" : "Opcional"} / Desenvolvido: ${desenvolvido} mm / Líq: ${peso_liquido} kg / Bruto: ${peso_bruto} kg</span>
      <div>
        <button type="button" class="btn btn-sm btn-outline-primary editar-insumo" data-index="${index}">
          <i class="bi bi-pencil"></i>
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger remover-insumo">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </li>
  `;
} else {
  // Se for novo, adiciona no final
  ul.insertAdjacentHTML("beforeend", `
    <li class="list-group-item d-flex justify-content-between align-items-center small">
      <span><strong>${txt}</strong> — ${tp} / ${ob ? "Obrigatório" : "Opcional"} / Desenvolvido: ${desenvolvido} mm / Líq: ${peso_liquido} kg / Bruto: ${peso_bruto} kg</span>
      <div>
        <button type="button" class="btn btn-sm btn-outline-primary editar-insumo" data-index="${data.insumos.length - 1}">
          <i class="bi bi-pencil"></i>
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger remover-insumo">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </li>
  `);
}



    bootstrap.Modal.getInstance(m)?.hide();
    document.querySelectorAll(".modal-backdrop").forEach(e => e.remove());
  });

document.querySelectorAll(".lista-insumos").forEach(lista => {
  lista.addEventListener("click", function (e) {
    const btn = e.target.closest(".editar-insumo");
    if (!btn) return;

    const index = Array.from(btn.closest("ul").children).indexOf(btn.closest("li"));
    const div = window.etapaAtiva;
    const data = JSON.parse(div.querySelector(".dados-etapa").value);
    const insumo = data.insumos[index];
    if (!insumo) return;

    const m = document.getElementById("modalInsumo");
    const selectInsumo = m.querySelector('select[name="insumo"]');
    selectInsumo.value = insumo.materia_prima_id;
    $(selectInsumo).trigger('change');  // para atualizar select2 visualmente
    m.querySelector('input[name="peso_liquido"]').value = insumo.peso_liquido || "";
    m.querySelector('input[name="peso_bruto"]').value = insumo.peso_bruto || "";
    m.querySelector('input[name="desenvolvido"]').value = insumo.desenvolvido || "";
    m.querySelector('select[name="tipo_insumo"]').value = insumo.tipo_insumo || "matéria_prima";
    m.querySelector('input[name="obrigatorio"]').checked = !!insumo.obrigatorio;

    m.dataset.index = index; // marcar que é edição

    new bootstrap.Modal(m).show();
  });
});

    // Salvar Propriedades
    document.getElementById("btnSalvarPropriedades")?.addEventListener("click", () => {
      const m = document.getElementById("modalPropriedades");

      const selNome = m.querySelector('select[name="nome_acao"]');
      const nome = selNome.options[selNome.selectedIndex]?.text || "";
      const nome_id = selNome.value;

      const desc = m.querySelector('textarea[name="descricao_detalhada"]').value;

      const maquinas = Array.from(m.querySelector('select[name="maquinas"]').selectedOptions)
        .map(o => ({ id: o.value, nome: o.textContent.trim() }));

      const selF = m.querySelector('select[name="ferramenta"]');
      const fId = selF.value;
      const fTxt = selF.options[selF.selectedIndex]?.text || "";

      const seguranca = {};
      ["mp", "ts", "m1", "l1", "l2"].forEach(sigla => {
        seguranca[`seguranca_${sigla}`] = m.querySelector(`input[name="seguranca_${sigla}"]`).checked;
      });

      const div = window.etapaAtiva;
      if (!div) {
        console.warn("⚠️ Nenhuma etapa ativa encontrada ao tentar salvar propriedades.");
        return;
      }

      const hidden = div.querySelector(".dados-etapa");
      const data = JSON.parse(hidden.value);

      data.propriedades = {
        nome_acao: nome,
        nome_acao_id: nome_id,
        descricao_detalhada: desc,
        maquinas,
        ferramenta: { id: fId, texto: fTxt },
        ...seguranca
      };

      hidden.value = JSON.stringify(data);

      const resumoSeg = Object.keys(seguranca)
        .filter(k => seguranca[k])
        .map(k => k.replace("seguranca_", "").toUpperCase())
        .join(", ");

      const ul = div.querySelector(".lista-propriedades");
      ul.innerHTML = `
        <li class="list-group-item small"><strong>Ação:</strong> ${nome}</li>
        <li class="list-group-item small"><strong>Máquinas:</strong> ${maquinas.map(x => x.nome).join(", ")}</li>
        <li class="list-group-item small"><strong>Descrição:</strong> ${desc}</li>
        ${fTxt ? `<li class="list-group-item small"><strong>Ferramenta:</strong> ${fTxt}</li>` : ""}
        ${resumoSeg ? `<li class="list-group-item small"><strong>Segurança:</strong> ${resumoSeg}</li>` : ""}
      `;

      bootstrap.Modal.getInstance(m)?.hide();
      document.querySelectorAll(".modal-backdrop").forEach(e => e.remove());
    });
  });
}
</script>


