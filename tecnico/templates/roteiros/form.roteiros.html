{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}
  {% if edicao %}Editar{% else %}Cadastrar{% endif %} Roteiro de Produção
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">
    <i class="bi bi-diagram-3 me-2"></i>
    {% if edicao %}Editar{% else %}Cadastrar{% endif %} Roteiro de Produção
  </h2>
<form method="post" id="roteiroForm">

  {% if form.errors %}
<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
  <strong>Erros no formulário:</strong>
  <ul class="mb-0">
    {% for field, errors in form.errors.items %}
      {% for error in errors %}
        <li><strong>{{ field|title }}:</strong> {{ error }}</li>
      {% endfor %}
    {% endfor %}
  </ul>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
</div>
{% endif %}

  {% csrf_token %}
  <div class="accordion mb-4" id="accordion-info-geral">
  <div class="accordion-item border rounded">
    <h2 class="accordion-header" id="heading-info">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-info" aria-expanded="true" aria-controls="collapse-info">
        <i class="bi bi-info-circle me-2"></i> Informações do Roteiro
      </button>
    </h2>
    <div id="collapse-info" class="accordion-collapse collapse show" aria-labelledby="heading-info" data-bs-parent="#accordion-info-geral">
      <div class="accordion-body">

        <div class="row g-3 align-items-end">
          <div class="col-md-5">
            <label for="{{ form.item.id_for_label }}" class="form-label">
              <i class="bi bi-box-seam me-1"></i> Item Vinculado <span class="text-danger">*</span>
            </label>
            {{ form.item|add_class:"form-select select2 w-100" }}
          </div>

          <div class="col-md-2">
            <label class="form-label">
              <i class="bi bi-tag me-1"></i> Tipo de Roteiro
            </label>
            {{ form.tipo_roteiro|add_class:"form-select" }}
          </div>
<div class="col-md-2">
    <label class="form-label">
      <i class="bi bi-toggle-on me-1"></i> Status
    </label>
    {{ form.status|add_class:"form-select" }}
  </div>
          <div class="col-md-3">
            <label class="form-label">
              <i class="bi bi-weight me-1"></i> Peso Unitário (g)
            </label>
            {{ form.peso_unitario_gramas|add_class:"form-control" }}
          </div>

          <div class="col-md-2">
            <label for="{{ form.revisao.id_for_label }}" class="form-label">
              <i class="bi bi-arrow-repeat me-1"></i> Revisão do Roteiro
            </label>
            {{ form.revisao|add_class:"form-control text-center" }}
          </div>
        </div>
<div class="row g-3 mt-3">
  <div class="col-12">
  <label class="form-label">
    <i class="bi bi-people-fill me-1"></i> Fontes Homologadas
  </label>
{{ form.fontes_homologadas|add_class:"form-select select2" }}
</div>
<div class="alert alert-info d-flex align-items-center gap-2 py-2 small mb-0" role="alert">
  <i class="bi bi-exclamation-circle-fill me-1"></i>
  As fontes homologadas são definidas no <strong>cadastro do item</strong>. Para alterá-las, acesse a tela de edição do item correspondente.
</div>
</div>

        <div class="row g-3 mt-3">
          <div class="col-12">
            <label for="{{ form.observacoes_gerais.id_for_label }}" class="form-label">
              <i class="bi bi-card-text me-1"></i> Observações Gerais
            </label>
            {{ form.observacoes_gerais }}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

    <hr>

<div class="accordion mb-3" id="etapas-container"></div>
  <div class="text-end">
 <button type="button" id="addEtapa" class="btn btn-outline-success btn-sm mb-3">
  <i class="bi bi-plus-circle me-1"></i> Adicionar Etapa
</button>

</div>

<input type="hidden" name="dados_json" id="dados_json">

<div class="text-center mt-4">
  {% include 'partials/global/_botoes_salvar_cancelar.html' with edicao=edicao url_voltar='tecnico:tecnico_roteiros' %}
</div>
</form>
</div>
</div>

{{ insumos_data|json_script:"insumos-data" }}
{{ maquinas_data|json_script:"maquinas-data" }}
{{ setores_data|json_script:"setores-data" }}
{# só renderiza se estivermos em edição #}
{{ roteiro_data|default_if_none:"{}"|json_script:"roteiro-data" }}

{# Inclui os dois modais apenas uma vez, fora do template JS #}
{% include "roteiros/_modal_insumo.html" with insumos=insumos_data %}
{% include "roteiros/_modal_propriedades.html" with maquinas=maquinas_data ferramentas=ferramentas_data servicos=servicos segurancas=segurancas %}

<script>
if (!window.roteiroScriptRegistrado) {
  window.roteiroScriptRegistrado = true;

  document.addEventListener("DOMContentLoaded", function () {
    const insumosData   = JSON.parse(document.getElementById("insumos-data").textContent);
    const maquinasData  = JSON.parse(document.getElementById("maquinas-data").textContent);
    const setoresData   = JSON.parse(document.getElementById("setores-data").textContent);
    let roteiroData = {};
    const roteiroDataEl = document.getElementById("roteiro-data");
    if (roteiroDataEl && roteiroDataEl.textContent.trim() !== "") {
      try {
        roteiroData = JSON.parse(roteiroDataEl.textContent);
      } catch (e) {
        console.warn("⚠️ Erro ao interpretar roteiro_data:", e);
        roteiroData = {};
      }
    }

    

    let etapaIndex = 0;
    const container = document.getElementById("etapas-container");

    function criarEtapa(index, data = null) {
      const div = document.createElement("div");
      div.className = "border rounded p-3 mb-3 etapa-form";
      div.dataset.index = index;
      div.innerHTML = `
  <div class="accordion-item border rounded">
    <h2 class="accordion-header px-2" id="heading-${index}">
      <div class="d-flex justify-content-between align-items-center w-100">
        <button class="accordion-button collapsed flex-grow-1 text-start" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapse-${index}"
                aria-expanded="false" aria-controls="collapse-${index}">
          Etapa <span class="ms-1 badge bg-secondary">${index + 1}</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remover-etapa" title="Remover Etapa">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </h2>

    <div id="collapse-${index}" class="accordion-collapse collapse" aria-labelledby="heading-${index}" data-bs-parent="#etapas-container">
      <div class="accordion-body">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label"><i class="bi bi-list-ol me-1"></i> Etapa Nº</label>
            <input type="number" class="form-control" name="etapas[${index}][etapa]" required>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="bi bi-diagram-3 me-1"></i> Setor</label>
            <select class="form-select select2" name="etapas[${index}][setor]" required>
              <option value="">– Selecione –</option>
              ${setoresData.map(s => `<option value="${s.id}">${s.nome}</option>`).join("")}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label"><i class="bi bi-speedometer2 me-1"></i> Peças/Hora</label>
            <input type="number" step="0.0001" class="form-control" name="etapas[${index}][pph]">
          </div>
          <div class="col-md-2">
            <label class="form-label"><i class="bi bi-stopwatch me-1"></i> Setup (min)</label>
            <input type="number" step="0.01" min="0" class="form-control" name="etapas[${index}][setup_minutos]">
          </div>
          <div class="col-md-2 d-flex align-items-end justify-content-between gap-1">
            <button type="button" class="btn btn-sm btn-info w-100 btn-add-insumo" title="Adicionar Insumo">
              <i class="bi bi-box-seam"></i>
            </button>
            <button type="button" class="btn btn-sm btn-secondary w-100 btn-add-propriedades" title="Adicionar Propriedades">
              <i class="bi bi-gear"></i>
            </button>
          </div>
        </div>

        <div class="mt-4">
          <label class="form-label"><i class="bi bi-box-seam me-1"></i> Insumos</label>
          <ul class="list-group lista-insumos mb-2"></ul>
        </div>

        <div class="mt-3">
          <label class="form-label"><i class="bi bi-gear me-1"></i> Propriedades</label>
          <ul class="list-group lista-propriedades mb-2"></ul>
        </div>

        <input type="hidden" class="dados-etapa" name="etapas[${index}][data]" value='{"insumos":[],"propriedades":{}}'>
      </div>
    </div>
  </div>
`;

      $(div).find("select.select2").select2({ dropdownParent: div });

      if (data) {
        div.querySelector(`[name="etapas[${index}][etapa]"]`).value         = data.etapa;
        div.querySelector(`[name="etapas[${index}][setor]"]`).value         = data.setor;
        div.querySelector(`[name="etapas[${index}][pph]"]`).value           = data.pph;
        div.querySelector(`[name="etapas[${index}][setup_minutos]"]`).value = data.setup_minutos;
        div.querySelector(".dados-etapa").value = JSON.stringify({ insumos: data.insumos, propriedades: data.propriedades });

        const ulI = div.querySelector(".lista-insumos");
        data.insumos.forEach(ins => {
          // encontra dados do insumo
          const mat = insumosData.find(i => i.id == ins.materia_prima_id);
          const txt = mat
            ? `${mat.codigo} – ${mat.descricao}`
            : ins.materia_prima_id;

          // normaliza e formata valores numéricos
          const dev = parseFloat(ins.desenvolvido) || 0;
          const liq = parseFloat(ins.peso_liquido)  || 0;
          const bru = parseFloat(ins.peso_bruto)    || 0;

          ulI.insertAdjacentHTML("beforeend", `
            <li class="list-group-item d-flex justify-content-between align-items-center small">
              <span>
                <strong>${txt}</strong> — 
                ${ins.tipo_insumo} / 
                ${ins.obrigatorio ? "Obrigatório" : "Opcional"} / 
                Desenvolvido: ${dev.toFixed(3)} mm / 
                Líq: ${liq.toFixed(3)} kg / 
                Bruto: ${bru.toFixed(3)} kg
              </span>
              <button type="button" class="btn btn-sm btn-outline-danger remover-insumo">
                <i class="bi bi-x-circle"></i>
              </button>
            </li>
          `);

        }); // fecha apenas o forEach


        const ulP = div.querySelector(".lista-propriedades");
        if (data.propriedades?.nome_acao) {
          const props = data.propriedades;
          const segs = ["mp", "ts", "m1", "l1", "l2"]
            .filter(k => props[`seguranca_${k}`])
            .map(k => k.toUpperCase())
            .join(", ");
          ulP.innerHTML = `
            <li class="list-group-item small"><strong>Ação:</strong> ${props.nome_acao}</li>
            <li class="list-group-item small"><strong>Máquinas:</strong> ${props.maquinas.map(m => m.nome).join(", ")}</li>
            <li class="list-group-item small"><strong>Descrição:</strong> ${props.descricao_detalhada}</li>
            ${props.ferramenta?.texto ? `<li class="list-group-item small"><strong>Ferramenta:</strong> ${props.ferramenta.texto}</li>` : ""}
            ${segs ? `<li class="list-group-item small"><strong>Segurança:</strong> ${segs}</li>` : ""}
          `;
        }
      }

      return div;
    }

    function adicionarEtapa() {
      container.appendChild(criarEtapa(etapaIndex));
      etapaIndex++;
    }

    if (roteiroData.etapas && Array.isArray(roteiroData.etapas) && roteiroData.etapas.length > 0) {
      roteiroData.etapas.forEach(et => {
        container.appendChild(criarEtapa(etapaIndex, et));
        etapaIndex++;
      });
    } else {
      adicionarEtapa();
    }

    document.getElementById("addEtapa").addEventListener("click", adicionarEtapa);

    container.addEventListener("click", e => {
      const etapaDiv = e.target.closest(".etapa-form");
      if (!etapaDiv) return;

      // Remover etapa
      if (e.target.closest(".remover-etapa")) {
        etapaDiv.classList.add("etapa-removida");
        etapaDiv.style.display = "none";
        return;
      }

      // Adicionar/Editar Insumo
      if (e.target.closest(".btn-add-insumo")) {
        window.etapaAtiva = etapaDiv;
        const data = JSON.parse(etapaDiv.querySelector(".dados-etapa").value);
        const insumos = data.insumos || [];
        const modalInsumo = document.getElementById("modalInsumo");

        if (insumos.length > 0) {
          const lastIndex = insumos.length - 1;
          const insumo = insumos[lastIndex];
          modalInsumo.querySelector('select[name="insumo"]').value = insumo.materia_prima_id;
          $(modalInsumo.querySelector('select[name="insumo"]')).trigger('change');
          modalInsumo.querySelector('input[name="peso_liquido"]').value   = insumo.peso_liquido || "";
          modalInsumo.querySelector('input[name="peso_bruto"]').value     = insumo.peso_bruto   || "";
          modalInsumo.querySelector('input[name="desenvolvido"]').value   = insumo.desenvolvido  || "";
          modalInsumo.querySelector('select[name="tipo_insumo"]').value   = insumo.tipo_insumo   || "matéria_prima";
          modalInsumo.querySelector('input[name="obrigatorio"]').checked  = !!insumo.obrigatorio;
          modalInsumo.dataset.index = lastIndex;
        } else {
          modalInsumo.querySelector('select[name="insumo"]').value = "";
          $(modalInsumo.querySelector('select[name="insumo"]')).trigger('change');
          modalInsumo.querySelector('input[name="peso_liquido"]').value   = "";
          modalInsumo.querySelector('input[name="peso_bruto"]').value     = "";
          modalInsumo.querySelector('input[name="desenvolvido"]').value   = "";
          modalInsumo.querySelector('select[name="tipo_insumo"]').value   = "matéria_prima";
          modalInsumo.querySelector('input[name="obrigatorio"]').checked  = false;
          delete modalInsumo.dataset.index;
        }

        new bootstrap.Modal(modalInsumo).show();
        return;
      }

      // Adicionar/Editar Propriedades
      if (e.target.closest(".btn-add-propriedades")) {
        window.etapaAtiva = etapaDiv;
        const data = JSON.parse(etapaDiv.querySelector(".dados-etapa").value);
        const props = data.propriedades || {};
        const modalP = document.getElementById("modalPropriedades");

        // Nome da Ação
        const selectAcao = modalP.querySelector('select[name="nome_acao"]');
        selectAcao.value = props.nome_acao_id || "";
        $(selectAcao).trigger("change");

        // Descrição Detalhada
        modalP.querySelector('textarea[name="descricao_detalhada"]').value = props.descricao_detalhada || "";

        // Máquinas
        const selectMaquinas = modalP.querySelector('select[name="maquinas"]');
        const maquinasSelecionadas = (props.maquinas || []).map(m => m.id);
        $(selectMaquinas).val(maquinasSelecionadas).trigger("change");

        // Ferramenta
        const selectFerramenta = modalP.querySelector('select[name="ferramenta"]');
        selectFerramenta.value = props.ferramenta?.id || "";
        $(selectFerramenta).trigger("change");

        // Segurança
        ["mp", "ts", "m1", "l1", "l2"].forEach(sigla => {
          const input = modalP.querySelector(`input[name="seguranca_${sigla}"]`);
          if (input) input.checked = !!props[`seguranca_${sigla}`];
        });

        new bootstrap.Modal(modalP).show();
        return;
      }


      // Remover Insumo
      if (e.target.closest(".remover-insumo")) {
        const li = e.target.closest("li");
        const idx = Array.from(li.parentNode.children).indexOf(li);
        const data = JSON.parse(etapaDiv.querySelector(".dados-etapa").value);
        data.insumos.splice(idx, 1);
        etapaDiv.querySelector(".dados-etapa").value = JSON.stringify(data);
        li.remove();
      }
    });

    document.getElementById("roteiroForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = this;
      const payload = {
        item: document.querySelector('[name="item"]').value,
        etapas: []
      };

      const etapaDivs = Array.from(container.querySelectorAll(".etapa-form"))
        .filter(div => !div.classList.contains("etapa-removida"));

      etapaDivs.forEach(div => {
        const data = JSON.parse(div.querySelector(".dados-etapa").value);
        data.etapa = div.querySelector('input[name^="etapas"][name$="[etapa]"]').value;
        data.setor = div.querySelector('select[name^="etapas"][name$="[setor]"]').value;
        data.pph   = div.querySelector('input[name^="etapas"][name$="[pph]"]').value;
        data.setup_minutos = div.querySelector('input[name^="etapas"][name$="[setup_minutos]"]').value.replace(",", ".");
        payload.etapas.push(data);
      });

      document.getElementById("dados_json").value = JSON.stringify(payload);
      setTimeout(() => form.submit(), 50);
    });
  });
}
</script>

<script>
  $(document).ready(function () {
    $("#id_item").on("change", function () {
      const itemId = $(this).val();

      if (itemId) {
        $.ajax({
          url: "{% url 'tecnico:ajax_fontes_homologadas' %}",
          data: { item_id: itemId },
          success: function (data) {
            const $select = $("#id_fontes_homologadas");
            $select.empty();

            if (data.results.length > 0) {
              data.results.forEach(function (fonte) {
                const option = new Option(fonte.text, fonte.id, true, true);
                $select.append(option);
              });
            }

            $select.trigger("change");
          },
        });
      }
    });
  });
</script>



{% endblock %}
